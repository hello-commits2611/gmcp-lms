<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - GMCP Student Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .profile-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .profile-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .profile-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .profile-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .form-container {
            padding: 40px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
        }

        .form-group label .required {
            color: #ef4444;
            margin-left: 4px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: #ffffff;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .form-group input[readonly],
        .form-group input.admin-assigned {
            background-color: #f3f4f6;
            border-color: #d1d5db;
            cursor: not-allowed;
            color: #6b7280;
            font-weight: 600;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .profile-picture-section {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: #f8fafc;
            border-radius: 12px;
            border: 2px dashed #d1d5db;
        }

        .profile-picture-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            border: 4px solid #e5e7eb;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px auto;
            color: #9ca3af;
            font-size: 3rem;
        }

        .profile-picture-preview img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            background: #4f46e5;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: background 0.3s ease;
            display: inline-block;
        }

        .file-input-button:hover {
            background: #4338ca;
        }

        .section-title {
            font-size: 1.5rem;
            color: #1f2937;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #e5e7eb;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 25px;
            background: #4f46e5;
            margin-right: 15px;
            border-radius: 2px;
        }

        .residence-type-selector {
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }

        .residence-option {
            flex: 1;
            position: relative;
        }

        .residence-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .residence-option label {
            display: block;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            font-weight: 600;
        }

        .residence-option input[type="radio"]:checked + label {
            border-color: #4f46e5;
            background: #ede9fe;
            color: #4f46e5;
        }

        .submit-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e5e7eb;
            text-align: center;
        }

        .submit-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
        }

        .submit-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .error-message {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .success-message {
            background: #dcfce7;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .readonly-mode {
            background: #f9fafb !important;
            cursor: not-allowed !important;
        }

        .readonly-info {
            background: #f0f9ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .profile-container {
                margin: 10px;
                border-radius: 10px;
            }

            .form-container {
                padding: 25px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .profile-header h1 {
                font-size: 2rem;
            }

            .residence-type-selector {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="profile-container">
        <div class="profile-header">
            <h1>üìã My Profile</h1>
            <p>Complete your profile information to access the dashboard</p>
        </div>

        <div class="form-container">
            <div id="messages"></div>
            
            <form id="profileForm" enctype="multipart/form-data">
                <!-- Profile Picture Section -->
                <div class="profile-picture-section">
                    <h3 class="section-title">Profile Picture</h3>
                    <div class="profile-picture-preview" id="profilePicturePreview">
                        üì∑
                    </div>
                    <div class="file-input-wrapper">
                        <input type="file" id="profilePicture" name="profilePicture" accept="image/*">
                        <div class="file-input-button">Choose Profile Picture</div>
                    </div>
                    <p style="margin-top: 10px; font-size: 0.9rem; color: #6b7280;">
                        Upload a clear photo (max 5MB, JPG/PNG)
                    </p>
                </div>

                <!-- Personal Information -->
                <h3 class="section-title">Personal Information</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="studentName">Student Name <span class="required">*</span></label>
                        <input type="text" id="studentName" name="studentName" required 
                               placeholder="Enter your full name">
                    </div>

                    <div class="form-group">
                        <label for="studentId">Student ID <span class="required">*</span></label>
                        <input type="text" id="studentId" name="studentId" required 
                               placeholder="Enter your student ID">
                        <small id="studentIdHelp" style="display: none; color: #10b981; font-weight: 500; margin-top: 5px; display: block;">
                            ‚úÖ This ID was assigned by admin and cannot be changed
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="admissionNumber">Admission Number <span class="required">*</span></label>
                        <input type="text" id="admissionNumber" name="admissionNumber" required 
                               placeholder="Enter your admission number">
                    </div>

                    <div class="form-group">
                        <label for="bloodGroup">Blood Group <span class="required">*</span></label>
                        <select id="bloodGroup" name="bloodGroup" required>
                            <option value="">Select Blood Group</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="currentSemester">Current Semester <span class="required">*</span></label>
                        <select id="currentSemester" name="currentSemester" required>
                            <option value="">Select Semester</option>
                            <option value="1">1st Semester</option>
                            <option value="2">2nd Semester</option>
                            <option value="3">3rd Semester</option>
                            <option value="4">4th Semester</option>
                            <option value="5">5th Semester</option>
                            <option value="6">6th Semester</option>
                            <option value="7">7th Semester</option>
                            <option value="8">8th Semester</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="gender">Gender <span class="required">*</span></label>
                        <select id="gender" name="gender" required>
                            <option value="">Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="dateOfBirth">Date of Birth <span class="required">*</span></label>
                        <input type="date" id="dateOfBirth" name="dateOfBirth" required 
                               placeholder="Select your date of birth" max="2010-12-31">
                    </div>
                    
                    <div class="form-group">
                        <label for="session">Session <span class="required">*</span></label>
                        <select id="session" name="session" required>
                            <option value="">Select Session</option>
                            <option value="2020-23">2020-23</option>
                            <option value="2021-24">2021-24</option>
                            <option value="2022-25">2022-25</option>
                            <option value="2023-26">2023-26</option>
                            <option value="2024-27">2024-27</option>
                            <option value="2025-28">2025-28</option>
                            <option value="2026-29">2026-29</option>
                            <option value="2027-30">2027-30</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="course">Course <span class="required">*</span></label>
                        <select id="course" name="course" required>
                            <option value="">Select Course</option>
                            <option value="Diploma in Civil Engineering">Diploma in Civil Engineering</option>
                            <option value="Diploma in Mechanical Engineering">Diploma in Mechanical Engineering</option>
                            <option value="Diploma in Electrical Engineering">Diploma in Electrical Engineering</option>
                            <option value="Diploma in Computer Science Engineering">Diploma in Computer Science Engineering</option>
                        </select>
                    </div>
                </div>

                <!-- Family Information -->
                <h3 class="section-title">Family Information</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fatherName">Father's Name <span class="required">*</span></label>
                        <input type="text" id="fatherName" name="fatherName" required 
                               placeholder="Enter father's full name">
                    </div>

                    <div class="form-group">
                        <label for="motherName">Mother's Name <span class="required">*</span></label>
                        <input type="text" id="motherName" name="motherName" required 
                               placeholder="Enter mother's full name">
                    </div>
                </div>

                <!-- Contact Information -->
                <h3 class="section-title">Contact Information</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="studentContact">Student Contact Number <span class="required">*</span></label>
                        <input type="tel" id="studentContact" name="studentContact" required 
                               placeholder="Enter your mobile number" pattern="[6-9][0-9]{9}">
                    </div>

                    <div class="form-group">
                        <label for="parentsContact">Parents' Contact Number <span class="required">*</span></label>
                        <input type="tel" id="parentsContact" name="parentsContact" required 
                               placeholder="Enter parents' mobile number" pattern="[6-9][0-9]{9}">
                    </div>
                </div>

                <!-- Address Information -->
                <h3 class="section-title">Address Information</h3>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="address">Address Details <span class="required">*</span></label>
                        <textarea id="address" name="address" required 
                                  placeholder="Enter complete address (House No., Street, Locality)"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="pincode">Pincode <span class="required">*</span></label>
                        <input type="text" id="pincode" name="pincode" required 
                               placeholder="Enter 6-digit pincode" pattern="[0-9]{6}">
                    </div>

                    <div class="form-group">
                        <label for="district">District <span class="required">*</span></label>
                        <input type="text" id="district" name="district" required 
                               placeholder="Enter district name">
                    </div>

                    <div class="form-group">
                        <label for="state">State <span class="required">*</span></label>
                        <select id="state" name="state" required>
                            <option value="">Select State</option>
                            <option value="Andhra Pradesh">Andhra Pradesh</option>
                            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                            <option value="Assam">Assam</option>
                            <option value="Bihar">Bihar</option>
                            <option value="Chhattisgarh">Chhattisgarh</option>
                            <option value="Goa">Goa</option>
                            <option value="Gujarat">Gujarat</option>
                            <option value="Haryana">Haryana</option>
                            <option value="Himachal Pradesh">Himachal Pradesh</option>
                            <option value="Jharkhand">Jharkhand</option>
                            <option value="Karnataka">Karnataka</option>
                            <option value="Kerala">Kerala</option>
                            <option value="Madhya Pradesh">Madhya Pradesh</option>
                            <option value="Maharashtra">Maharashtra</option>
                            <option value="Manipur">Manipur</option>
                            <option value="Meghalaya">Meghalaya</option>
                            <option value="Mizoram">Mizoram</option>
                            <option value="Nagaland">Nagaland</option>
                            <option value="Odisha">Odisha</option>
                            <option value="Punjab">Punjab</option>
                            <option value="Rajasthan">Rajasthan</option>
                            <option value="Sikkim">Sikkim</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="Telangana">Telangana</option>
                            <option value="Tripura">Tripura</option>
                            <option value="Uttar Pradesh">Uttar Pradesh</option>
                            <option value="Uttarakhand">Uttarakhand</option>
                            <option value="West Bengal">West Bengal</option>
                            <option value="Delhi">Delhi</option>
                        </select>
                    </div>
                </div>

                <!-- Residence Type -->
                <h3 class="section-title">Residence Type</h3>
                <div class="form-group">
                    <label>Are you a hosteller or day boarder? <span class="required">*</span></label>
                    <div class="residence-type-selector">
                        <div class="residence-option">
                            <input type="radio" id="hosteller" name="residenceType" value="hosteller" required>
                            <label for="hosteller">
                                üè† Hosteller<br>
                                <small style="color: #6b7280;">Lives in college hostel</small>
                            </label>
                        </div>
                        <div class="residence-option">
                            <input type="radio" id="day-boarder" name="residenceType" value="day-boarder" required>
                            <label for="day-boarder">
                                üö∂ Day Boarder<br>
                                <small style="color: #6b7280;">Commutes from home</small>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="submit-section">
                    <button type="submit" class="submit-btn" id="submitBtn">
                        <span class="loading-spinner" id="loadingSpinner"></span>
                        <span id="submitBtnText">Complete Profile</span>
                    </button>
                    <p style="margin-top: 15px; color: #6b7280; font-size: 0.9rem;">
                        Once submitted, only admin can modify your profile information.
                    </p>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Profile picture preview functionality
        document.getElementById('profilePicture').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('profilePicturePreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Profile Preview">`;
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = 'üì∑';
            }
        });

        // Form validation and submission
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Debug: Check form field states before FormData creation
            const courseElement = document.getElementById('course');
            console.log('üßê Pre-submit Debug:');
            console.log('  Course element exists:', !!courseElement);
            console.log('  Course element value:', courseElement?.value);
            console.log('  Course element disabled:', courseElement?.disabled);
            console.log('  Course element name:', courseElement?.name);
            
            const submitBtn = document.getElementById('submitBtn');
            const submitBtnText = document.getElementById('submitBtnText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const messagesDiv = document.getElementById('messages');
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtnText.textContent = 'Saving Profile...';
            loadingSpinner.style.display = 'inline-block';
            messagesDiv.innerHTML = '';
            
            try {
                const formData = new FormData(this);
                
                // Debug: Check if course field is in FormData
                console.log('üîç Frontend Debug - Course field value from form:', document.getElementById('course').value);
                console.log('üîç Frontend Debug - FormData entries:');
                for (let [key, value] of formData.entries()) {
                    if (key === 'course' || key === 'session' || key === 'gender') {
                        console.log(`  ${key}:`, value);
                    }
                }
                
                const response = await fetch('/api/profile', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    messagesDiv.innerHTML = `
                        <div class="success-message">
                            ‚úÖ Profile completed successfully! Redirecting to dashboard...
                        </div>
                    `;
                    
                    // Redirect to dashboard after 2 seconds
                    setTimeout(() => {
                        window.location.href = '/student-portal.html';
                    }, 2000);
                } else {
                    messagesDiv.innerHTML = `
                        <div class="error-message">
                            ‚ùå ${result.error || 'Failed to save profile'}
                        </div>
                    `;
                }
            } catch (error) {
                messagesDiv.innerHTML = `
                    <div class="error-message">
                        ‚ùå Network error. Please check your connection and try again.
                    </div>
                `;
            }
            
            // Reset loading state
            submitBtn.disabled = false;
            submitBtnText.textContent = 'Complete Profile';
            loadingSpinner.style.display = 'none';
        });

        // Phone number validation
        function validatePhoneNumber(input) {
            input.addEventListener('input', function() {
                const value = this.value.replace(/\D/g, '');
                this.value = value.slice(0, 10);
                
                if (value.length === 10 && /^[6-9]/.test(value)) {
                    this.style.borderColor = '#10b981';
                } else if (value.length > 0) {
                    this.style.borderColor = '#ef4444';
                } else {
                    this.style.borderColor = '#e5e7eb';
                }
            });
        }

        // Apply phone validation
        validatePhoneNumber(document.getElementById('studentContact'));
        validatePhoneNumber(document.getElementById('parentsContact'));

        // Pincode validation
        document.getElementById('pincode').addEventListener('input', function() {
            const value = this.value.replace(/\D/g, '');
            this.value = value.slice(0, 6);
            
            if (value.length === 6) {
                this.style.borderColor = '#10b981';
            } else if (value.length > 0) {
                this.style.borderColor = '#ef4444';
            } else {
                this.style.borderColor = '#e5e7eb';
            }
        });

        // Load dynamic sessions from backend
        async function loadSessions() {
            try {
                const response = await fetch('/api/attendance/sessions', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.sessions) {
                        const sessionSelect = document.getElementById('session');
                        
                        // Clear existing options except the first one
                        sessionSelect.innerHTML = '<option value="">Select Session</option>';
                        
                        // Add active sessions
                        data.sessions
                            .filter(s => s.status === 'active')
                            .sort((a, b) => b.startYear - a.startYear) // Sort newest first
                            .forEach(session => {
                                const option = document.createElement('option');
                                option.value = session.id; // e.g., "2023-2026"
                                option.textContent = session.name || session.id;
                                sessionSelect.appendChild(option);
                            });
                        
                        console.log('\u2705 Loaded', data.sessions.length, 'sessions');
                    }
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }
        
        // Check if user is logged in and load existing profile
        async function checkAuthAndLoadProfile() {
            try {
                // Load dynamic sessions first
                await loadSessions();
                
                // Check authentication
                const authResponse = await fetch('/api/auth/check', {
                    credentials: 'include'
                });
                
                if (!authResponse.ok) {
                    window.location.href = '/login.html';
                    return;
                }
                
                const authData = await authResponse.json();
                if (!authData.authenticated) {
                    window.location.href = '/login.html';
                    return;
                }
                
                // Check if user has Student ID or Employee ID assigned by admin
                const user = authData.user;
                const studentIdField = document.getElementById('studentId');
                const studentIdHelp = document.getElementById('studentIdHelp');
                
                if (user && (user.studentId || user.employeeId)) {
                    // User has ID assigned by admin - make it read-only
                    const assignedId = user.studentId || user.employeeId;
                    studentIdField.value = assignedId;
                    studentIdField.readOnly = true;
                    studentIdField.classList.add('admin-assigned');
                    studentIdField.required = false; // Already has value
                    if (studentIdHelp) {
                        studentIdHelp.style.display = 'block';
                    }
                }

                // Try to load existing profile
                const profileResponse = await fetch('/api/profile', {
                    credentials: 'include'
                });
                
                if (profileResponse.ok) {
                    const profileData = await profileResponse.json();
                    
                    if (profileData.exists && profileData.profile) {
                        const profile = profileData.profile;
                        const form = document.getElementById('profileForm');
                        const messagesDiv = document.getElementById('messages');
                        
                        // Check if profile can be edited
                        if (!profileData.editable && authData.user.role !== 'admin') {
                            // Show readonly message
                            messagesDiv.innerHTML = `
                                <div class="readonly-info">
                                    \u2705 Your profile has been submitted successfully!<br>
                                    \ud83d\udd12 <strong>Academic information (Session, Course, Semester) is locked and cannot be changed by students.</strong><br>
                                    \u2139\ufe0f If you need to update your enrollment details, please contact the admin.
                                </div>
                            `;
                            
                            // Make ONLY enrollment-related fields (session, course, semester) readonly
                            const enrollmentFields = ['session', 'course', 'currentSemester'];
                            enrollmentFields.forEach(fieldId => {
                                const field = document.getElementById(fieldId);
                                if (field) {
                                    field.disabled = true;
                                    field.classList.add('readonly-mode');
                                    field.style.backgroundColor = '#f3f4f6';
                                    field.style.borderColor = '#d1d5db';
                                    field.style.cursor = 'not-allowed';
                                }
                            });
                            
                            // For students with completed profiles, make ALL fields readonly
                            if (profile.isComplete) {
                                const inputs = form.querySelectorAll('input, select, textarea');
                                inputs.forEach(input => {
                                    input.disabled = true;
                                    input.classList.add('readonly-mode');
                                });
                                
                                // Hide submit button
                                document.querySelector('.submit-section').style.display = 'none';
                            }
                        }
                        
                        // Populate form with existing data
                        Object.keys(profile).forEach(key => {
                            const element = document.getElementById(key);
                            if (element && profile[key]) {
                                if (element.type === 'radio') {
                                    const radio = document.querySelector(`input[name="${key}"][value="${profile[key]}"]`);
                                    if (radio) radio.checked = true;
                                } else {
                                    element.value = profile[key];
                                }
                            }
                        });
                        
                        // Show profile picture if exists
                        if (profile.profilePicture) {
                            document.getElementById('profilePicturePreview').innerHTML = 
                                `<img src="${profile.profilePicture}" alt="Profile Picture">`;
                        }
                        
                        // If profile is complete and user is student, redirect to dashboard
                        if (profile.isComplete && authData.user.role === 'student' && profileData.editable === false) {
                            setTimeout(() => {
                                window.location.href = '/student-portal.html';
                            }, 3000);
                        }
                    }
                }
                
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', checkAuthAndLoadProfile);
    </script>
</body>
</html>