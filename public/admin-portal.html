<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - GMCP LMS</title>
    <link rel="icon" type="image/jpeg" href="images/logo.jpg">
    <link rel="stylesheet" href="css/common.css">
    <style>
        body { background: #f8f9fa; min-height: 100vh; }
        .header { background: linear-gradient(135deg, #d63031 0%, #74b9ff 100%); color: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-left img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.3); }
        .header-text h1 { font-size: 24px; margin-bottom: 5px; }
        .header-text .subtitle { font-size: 14px; opacity: 0.9; }
        .header-right { display: flex; align-items: center; gap: 20px; }
        .logout-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .navigation { background: white; border-bottom: 1px solid #dee2e6; }
        .nav-content { max-width: 1200px; margin: 0 auto; display: flex; padding: 0 20px; overflow-x: auto; }
        .nav-item { padding: 15px 20px; cursor: pointer; border-bottom: 3px solid transparent; transition: all .3s ease; font-weight: 500; white-space: nowrap; }
        .nav-item:hover { background: #f8f9fa; color: #d63031; }
        .nav-item.active { border-bottom-color: #d63031; color: #d63031; background: #f8f9fa; }
        .main-content { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .stat-card::before { content: ''; position: absolute; top:0; left:0; right:0; height:4px; background: linear-gradient(135deg, #d63031 0%, #74b9ff 100%); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px,1fr)); gap:20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 12px; padding: 25px; text-align: center; border: 1px solid #e9ecef; position: relative; overflow: hidden; }
        .stat-value { font-size: 32px; font-weight: 700; color: #333; margin-bottom: 5px; }
        .stat-label { font-size: 14px; color: #666; text-transform: uppercase; letter-spacing: .5px; }
        .user-form { max-width: 600px; margin: 0 auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
        .role-fields { display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .role-fields.active { display: block; }
        .user-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: white; border-radius: 10px; margin-bottom: 10px; border: 1px solid #e9ecef; }
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #d63031 0%, #74b9ff 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
        .user-info { flex: 1; }
        .user-name { font-weight: 600; margin-bottom: 2px; }
        .user-email { font-size: 13px; color: #666; }
        .user-actions { display: flex; gap: 8px; }
        .search-bar { position: relative; margin-bottom: 20px; }
        .search-bar input { padding-left: 40px; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999; }
        .filter-tabs { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-tab { padding: 8px 16px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 13px; }
        .filter-tab.active { background: #d63031; color: white; border-color: #d63031; }
        .bulk-actions { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px; display: none; }
        .bulk-actions.active { display: block; }
        .system-setting { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f0f0f0; }
        .toggle-switch { position: relative; width: 50px; height: 24px; background: #ccc; border-radius: 24px; cursor: pointer; }
        .toggle-switch.active { background: #00b894; }
        .toggle-slider { position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: transform 0.3s ease; }
        .toggle-switch.active .toggle-slider { transform: translateX(26px); }
        .biometric-tab { display: none; }
        .biometric-tab.active { display: block; }
        .table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        .table thead { background: #f8f9fa; }
        .table th { padding: 12px; text-align: left; font-weight: 600; color: #333; border-bottom: 2px solid #dee2e6; }
        .table td { padding: 12px; border-bottom: 1px solid #f0f0f0; }
        .table tbody tr:hover { background: #f8f9fa; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <img src="images/logo.jpg" alt="GMCP Logo">
                <div class="header-text">
                    <h1>Admin Portal</h1>
                    <div class="subtitle">Complete system administration and control</div>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-role" id="userRole">Administrator</div>
                </div>
                <button class="logout-btn" onclick="authManager.logout()">üö™ Logout</button>
            </div>
        </div>
    </header>

    <nav class="navigation">
        <div class="nav-content">
            <div class="nav-item active" onclick="showSection('dashboard')">üìä Dashboard</div>
            <div class="nav-item" onclick="showSection('users')">üë• User Management</div>
            <div class="nav-item" onclick="showSection('hostel-management')">üè† Hostel Management</div>
            <div class="nav-item" onclick="showSection('hostel-issues')">üõ†Ô∏è Hostel Issues</div>
            <div class="nav-item" onclick="showSection('request-management')">üìã Request Management</div>
            <div class="nav-item" onclick="showSection('document-management')">üìÑ Document Management</div>
            <div class="nav-item" onclick="showSection('feedback-management')">üí¨ Feedback Management</div>
            <div class="nav-item" onclick="showSection('attendance')">üìä Attendance Management</div>
            <div class="nav-item" onclick="showSection('biometric-attendance')">üëÜ Biometric Attendance</div>
            <div class="nav-item" onclick="showSection('system')">‚öôÔ∏è System Settings</div>
            <div class="nav-item" onclick="showSection('logs')">üìã System Logs</div>
            <div class="nav-item" onclick="showSection('backup')">üíæ Backup & Security</div>
            <div class="nav-item" onclick="showSection('profile')">üë§ Profile</div>
        </div>
    </nav>

    <main class="main-content">
        <section id="dashboard" class="page-section active">
            <h2 class="mb-4">System Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalUsers">1,328</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeUsers">1,204</div>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingApprovals">12</div>
                    <div class="stat-label">Pending Approvals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="systemHealth">99.9%</div>
                    <div class="stat-label">System Health</div>
                </div>
            </div>

            <div class="row">
                <div class="col-8">
                    <div class="card">
                        <div class="card-header"><div class="card-title">User Distribution</div></div>
                        <div class="card-body">
                            <div class="detail-row"><span>Students</span><span>1,240 (93.4%)</span></div>
                            <div class="detail-row"><span>Faculty</span><span>85 (6.4%)</span></div>
                            <div class="detail-row"><span>Management</span><span>2 (0.15%)</span></div>
                            <div class="detail-row"><span>Administrators</span><span>1 (0.08%)</span></div>
                        </div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="card">
                        <div class="card-header"><div class="card-title">System Status</div></div>
                        <div class="card-body">
                            <div class="detail-row"><span>Server Uptime</span><span class="text-success">99.9%</span></div>
                            <div class="detail-row"><span>Database Status</span><span class="text-success">Online</span></div>
                            <div class="detail-row"><span>Backup Status</span><span class="text-success">Current</span></div>
                            <div class="detail-row"><span>Security Alerts</span><span class="text-danger">2</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="users" class="page-section">
            <h2 class="mb-4">User Management</h2>
            
            <div class="search-bar">
                <span class="search-icon">üîç</span>
                <input type="text" class="form-control" placeholder="Search users by name, email, or ID..." id="userSearch" oninput="filterUsers()">
            </div>

            <div class="filter-tabs">
                <div class="filter-tab active" onclick="filterByRole('all')">All Users</div>
                <div class="filter-tab" onclick="filterByRole('student')">Students</div>
                <div class="filter-tab" onclick="filterByRole('teacher')">Faculty</div>
                <div class="filter-tab" onclick="filterByRole('management')">Management</div>
                <div class="filter-tab" onclick="filterByRole('admin')">Admins</div>
                <div class="filter-tab" onclick="filterByRole('inactive')">Inactive</div>
            </div>

            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="showCreateUserModal()">‚ûï Create User</button>
                    <button class="btn btn-primary" onclick="showBulkAddModal()">üì• Bulk Add Users</button>
                </div>
                <button class="btn btn-light" onclick="showBulkImportModal()">üìÅ Import from CSV</button>
            </div>
            
            <div class="bulk-actions" id="bulkActions">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span><span id="selectedCount">0</span> users selected</span>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-danger btn-sm" onclick="bulkAction('delete')">üóëÔ∏è Delete Selected</button>
                        <button class="btn btn-warning btn-sm" onclick="bulkAction('deactivate')">‚è∏Ô∏è Deactivate</button>
                        <button class="btn btn-success btn-sm" onclick="bulkAction('activate')">‚ñ∂Ô∏è Activate</button>
                        <button class="btn btn-light btn-sm" onclick="clearSelection()">‚ùå Clear</button>
                    </div>
                </div>
            </div>

            <div id="usersList">
                <div class="text-center" style="padding: 40px; color: #666;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <div style="margin-top: 15px;">Loading users from database...</div>
                </div>
            </div>
        </section>

        <!-- STUDENT PROFILES SECTION REMOVED - Use Edit button in User Management instead -->

        <section id="hostel-management" class="page-section">
            <h2 class="mb-4">üè† Hostel Management</h2>
            
            <div class="search-bar">
                <span class="search-icon">üîç</span>
                <input type="text" class="form-control" placeholder="Search students by name, ID, or email..." id="profileSearch" oninput="filterProfiles()">
            </div>

            <div class="filter-tabs">
                <div class="filter-tab active" onclick="filterProfiles('all')">All Students</div>
                <div class="filter-tab" onclick="filterProfiles('hosteller')">Hostellers</div>
                <div class="filter-tab" onclick="filterProfiles('day-boarder')">Day Boarders</div>
                <div class="filter-tab" onclick="filterProfiles('incomplete')">Incomplete Profiles</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Student Profiles</div>
                    <button class="btn btn-primary btn-sm" onclick="exportProfiles()">üìä Export Data</button>
                </div>
                <div class="card-body">
                    <div id="profilesList">
                        <!-- Student profiles will be loaded here dynamically -->
                        <div class="text-center" id="profilesLoading">
                            <div>Loading student profiles...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Edit Modal -->
            <div id="profileEditModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>Edit Student Profile</h3>
                        <button class="modal-close" onclick="closeProfileModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="editProfileForm" enctype="multipart/form-data">
                            <input type="hidden" id="editUsername" name="username">
                            
                            <div class="row">
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>Student Name *</label>
                                        <input type="text" class="form-control" id="editStudentName" name="studentName" required>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>Student ID *</label>
                                        <input type="text" class="form-control" id="editStudentId" name="studentId" required>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-4">
                                    <div class="form-group">
                                        <label>Blood Group *</label>
                                        <select class="form-control" id="editBloodGroup" name="bloodGroup" required>
                                            <option value="">Select Blood Group</option>
                                            <option value="A+">A+</option>
                                            <option value="A-">A-</option>
                                            <option value="B+">B+</option>
                                            <option value="B-">B-</option>
                                            <option value="AB+">AB+</option>
                                            <option value="AB-">AB-</option>
                                            <option value="O+">O+</option>
                                            <option value="O-">O-</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-group">
                                        <label>Current Semester *</label>
                                        <select class="form-control" id="editCurrentSemester" name="currentSemester" required>
                                            <option value="">Select Semester</option>
                                            <option value="1">1st Semester</option>
                                            <option value="2">2nd Semester</option>
                                            <option value="3">3rd Semester</option>
                                            <option value="4">4th Semester</option>
                                            <option value="5">5th Semester</option>
                                            <option value="6">6th Semester</option>
                                            <option value="7">7th Semester</option>
                                            <option value="8">8th Semester</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-group">
                                        <label>Residence Type *</label>
                                        <select class="form-control" id="editResidenceType" name="residenceType" required>
                                            <option value="">Select Type</option>
                                            <option value="hosteller">Hosteller</option>
                                            <option value="day-boarder">Day Boarder</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>Father's Name *</label>
                                        <input type="text" class="form-control" id="editFatherName" name="fatherName" required>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>Mother's Name *</label>
                                        <input type="text" class="form-control" id="editMotherName" name="motherName" required>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>Student Contact *</label>
                                        <input type="tel" class="form-control" id="editStudentContact" name="studentContact" required>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>Parents' Contact *</label>
                                        <input type="tel" class="form-control" id="editParentsContact" name="parentsContact" required>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Address *</label>
                                <textarea class="form-control" id="editAddress" name="address" rows="3" required></textarea>
                            </div>

                            <div class="row">
                                <div class="col-4">
                                    <div class="form-group">
                                        <label>Pincode *</label>
                                        <input type="text" class="form-control" id="editPincode" name="pincode" required>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-group">
                                        <label>District *</label>
                                        <input type="text" class="form-control" id="editDistrict" name="district" required>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-group">
                                        <label>State *</label>
                                        <input type="text" class="form-control" id="editState" name="state" required>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" onclick="closeProfileModal()">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveProfileChanges()">üíæ Save Changes</button>
                    </div>
                </div>
            </div>

            <!-- Semester Promotion Modal -->
            <div id="semesterPromotionModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>Promote Semester</h3>
                        <button class="modal-close" onclick="closeSemesterModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Student: <strong id="promotionStudentName"></strong></label>
                        </div>
                        <div class="form-group">
                            <label>Current Semester: <strong id="currentSemesterDisplay"></strong></label>
                        </div>
                        <div class="form-group">
                            <label>Promote to Semester *</label>
                            <select class="form-control" id="newSemester" required>
                                <option value="">Select New Semester</option>
                                <option value="1">1st Semester</option>
                                <option value="2">2nd Semester</option>
                                <option value="3">3rd Semester</option>
                                <option value="4">4th Semester</option>
                                <option value="5">5th Semester</option>
                                <option value="6">6th Semester</option>
                                <option value="7">7th Semester</option>
                                <option value="8">8th Semester</option>
                            </select>
                        </div>
                        <input type="hidden" id="promotionUsername">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" onclick="closeSemesterModal()">Cancel</button>
                        <button type="button" class="btn btn-success" onclick="confirmSemesterPromotion()">üéì Promote</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="hostel-management" class="page-section">
            <h2 class="mb-4">üè† Hostel Management</h2>
            
            <!-- Hostel Statistics -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="stat-value" id="totalHostelers">0</div>
                    <div class="stat-label">Total Hostelers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="roomsOccupied">0</div>
                    <div class="stat-label">Rooms Occupied</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="singleOccupancy">0</div>
                    <div class="stat-label">Single Occupancy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="sharedRooms">0</div>
                    <div class="stat-label">Shared Rooms</div>
                </div>
            </div>

            <!-- Filter and Search -->
            <div class="row mb-4">
                <div class="col-8">
                    <div class="search-bar">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="form-control" placeholder="Search by student name, room number, or ID..." 
                               id="hostelSearch" oninput="filterHostelers()">
                    </div>
                </div>
                <div class="col-4">
                    <button class="btn btn-primary" onclick="refreshHostelData()">
                        üîÑ Refresh Data
                    </button>
                </div>
            </div>

            <!-- Hostelers List -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Student Hostel Information</div>
                </div>
                <div class="card-body">
                    <div id="hostelersList">
                        <!-- Hostelers will be loaded here dynamically -->
                        <div class="text-center" id="hostelersLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                            <div class="mt-3">Loading hostelers data...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Hostel Modal -->
            <div id="hostelEditModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>Edit Hostel Information</h3>
                        <button class="modal-close" onclick="closeHostelModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="editHostelForm">
                            <input type="hidden" id="editHostelEmail" name="email">
                            
                            <div class="row">
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>Student Name *</label>
                                        <input type="text" class="form-control" id="editHostelStudentName" readonly>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>Room Number *</label>
                                        <input type="text" class="form-control" id="editRoomNumber" name="roomNumber" required>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>Allotment Date *</label>
                                        <input type="date" class="form-control" id="editAllotmentDate" name="allotmentDate" required>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>Contact Number *</label>
                                        <input type="tel" class="form-control" id="editContactNumber" name="contactNumber" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Warden Name</label>
                                <input type="text" class="form-control" id="editWardenName" name="wardenName" 
                                       value="Akarshan Raj Rohan">
                            </div>

                            <div class="form-group">
                                <label>Roommates</label>
                                <div id="editRoommatesContainer">
                                    <!-- Dynamic roommate fields -->
                                </div>
                                <button type="button" class="btn btn-sm btn-info mt-2" onclick="addEditRoommateField()">
                                    + Add Roommate
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" onclick="closeHostelModal()">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveHostelChanges()">üíæ Save Changes</button>
                        <button type="button" class="btn btn-danger" onclick="deleteHostelRecord()">üóëÔ∏è Delete Record</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="request-management" class="page-section">
            <h2 class="mb-4">üìã Request Management</h2>
            
            <!-- Request Statistics -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="stat-value" id="totalRequests">0</div>
                    <div class="stat-label">Total Requests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pendingRequests">0</div>
                    <div class="stat-label">Pending Requests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="approvedRequests">0</div>
                    <div class="stat-label">Approved Requests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="declinedRequests">0</div>
                    <div class="stat-label">Declined Requests</div>
                </div>
            </div>
            
            <!-- Filter Controls -->
            <div class="row mb-4">
                <div class="col-8">
                    <div class="search-bar">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="form-control" placeholder="Search by student name, request ID, or purpose..." 
                               id="requestSearch" oninput="filterRequests()">
                    </div>
                </div>
                <div class="col-4">
                    <button class="btn btn-primary" onclick="refreshRequestData()">
                        üîÑ Refresh Requests
                    </button>
                </div>
            </div>
            
            <!-- Request Filter Tabs -->
            <div class="filter-tabs mb-4">
                <div class="filter-tab active" onclick="filterRequestsByStatus('all')">All Requests</div>
                <div class="filter-tab" onclick="filterRequestsByStatus('pending')">Pending</div>
                <div class="filter-tab" onclick="filterRequestsByStatus('approved')">Approved</div>
                <div class="filter-tab" onclick="filterRequestsByStatus('declined')">Declined</div>
                <div class="filter-tab" onclick="filterRequestsByType('leave_hostel')">Leave Hostel</div>
                <div class="filter-tab" onclick="filterRequestsByType('outing')">Outing</div>
            </div>
            
            <!-- Requests List -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Student Requests</div>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-success" onclick="bulkApproveRequests()" id="bulkApproveBtn" style="display: none;">
                            ‚úÖ Approve Selected
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="bulkDeclineRequests()" id="bulkDeclineBtn" style="display: none;">
                            ‚ùå Decline Selected
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="bulkDeleteRequests()" id="bulkDeleteBtn" style="display: none;">
                            üóëÔ∏è Delete Selected
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="requestsList">
                        <!-- Requests will be loaded here dynamically -->
                        <div class="text-center" id="requestsLoading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                            <div class="mt-3">Loading requests...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Request Review Modal -->
            <div id="requestReviewModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3 id="reviewModalTitle">Review Request</h3>
                        <button class="modal-close" onclick="closeRequestReviewModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="requestDetails">
                            <!-- Request details will be loaded here -->
                        </div>
                        
                        <div class="form-group mt-4">
                            <label>Admin Remarks</label>
                            <textarea class="form-control" id="adminRemarks" rows="3" placeholder="Add your remarks (optional)..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Reviewed By</label>
                            <input type="text" class="form-control" id="reviewedBy" placeholder="Your name" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" onclick="closeRequestReviewModal()">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="reviewRequest('decline')" id="declineRequestBtn">
                            ‚ùå Decline Request
                        </button>
                        <button type="button" class="btn btn-success" onclick="reviewRequest('approve')" id="approveRequestBtn">
                            ‚úÖ Approve Request
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section id="hostel-issues" class="page-section">
            <h2 class="mb-4">üõ†Ô∏è Hostel Issues Management</h2>
            
            <!-- Filter Tabs -->
            <div class="filter-tabs mb-4">
                <button class="filter-tab active" onclick="filterHostelIssues('All')">All</button>
                <button class="filter-tab" onclick="filterHostelIssues('Pending')">Pending</button>
                <button class="filter-tab" onclick="filterHostelIssues('In Progress')">In Progress</button>
                <button class="filter-tab" onclick="filterHostelIssues('Resolved')">Resolved</button>
                <button class="filter-tab" onclick="filterHostelIssues('Rejected')">Rejected</button>
            </div>
            
            <!-- Issues List -->
            <div id="hostelIssuesList">
                <div class="text-center" style="padding: 40px; color: #999;">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p style="margin-top: 15px;">Loading issues...</p>
                </div>
            </div>
        </section>

        <section id="document-management" class="page-section">
            <h2 class="mb-4">üìÑ Document Management</h2>
            
            <!-- Document Upload Cards -->
            <div class="row mb-4">
                <div class="col-6">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìù Upload Hostel Notice</div>
                        </div>
                        <div class="card-body">
                            <form id="noticeUploadForm" enctype="multipart/form-data">
                                <div class="form-group">
                                    <label>Notice Title *</label>
                                    <input type="text" class="form-control" name="title" required placeholder="Enter notice title">
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea class="form-control" name="description" rows="3" placeholder="Brief description (optional)"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>PDF File *</label>
                                    <input type="file" class="form-control" name="file" accept=".pdf" required>
                                    <small class="form-text">Only PDF files allowed (Max: 10MB)</small>
                                </div>
                                <button type="submit" class="btn btn-primary">üìÅ Upload Notice</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üçΩÔ∏è Upload Mess Menu</div>
                        </div>
                        <div class="card-body">
                            <form id="messMenuUploadForm" enctype="multipart/form-data">
                                <div class="form-group">
                                    <label>Menu Title *</label>
                                    <input type="text" class="form-control" name="title" required placeholder="e.g., Weekly Mess Menu">
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea class="form-control" name="description" rows="3" placeholder="Menu details (optional)"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>PDF File *</label>
                                    <input type="file" class="form-control" name="file" accept=".pdf" required>
                                    <small class="form-text">Only PDF files allowed (Max: 10MB)</small>
                                </div>
                                <button type="submit" class="btn btn-success">üçΩÔ∏è Upload Menu</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Documents -->
            <div class="row">
                <div class="col-6">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Hostel Notices</div>
                            <button class="btn btn-sm btn-primary" onclick="refreshDocuments()">üîÑ Refresh</button>
                        </div>
                        <div class="card-body">
                            <div id="noticesList">
                                <div class="text-center" style="padding: 40px; color: #666;">Loading notices...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Current Mess Menu</div>
                        </div>
                        <div class="card-body">
                            <div id="messMenuDisplay">
                                <div class="text-center" style="padding: 40px; color: #666;">Loading mess menu...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="feedback-management" class="page-section">
            <h2 class="mb-4">üí¨ Feedback Management</h2>
            
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="showAddFeedbackLinkModal()">‚ûï Add Feedback Link</button>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Feedback Form Links</div>
                </div>
                <div class="card-body">
                    <div id="feedbackLinksList">
                        <div class="text-center" style="padding: 40px; color: #666;">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p style="margin-top: 15px;">Loading feedback links...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ATTENDANCE MANAGEMENT SECTION -->
        <section id="attendance" class="page-section">
            <h2 class="mb-4">üìä Attendance Management System</h2>
            
            <!-- Sub-navigation tabs -->
            <div class="filter-tabs" style="margin-bottom: 30px;">
                <div class="filter-tab active" onclick="showAttendanceTab('config')">‚öôÔ∏è Configuration</div>
                <div class="filter-tab" onclick="showAttendanceTab('subjects')">üìö Subjects</div>
                <div class="filter-tab" onclick="showAttendanceTab('enrollments')">üìù Student Enrollment</div>
                <div class="filter-tab" onclick="showAttendanceTab('monitor')">üìä Monitor Attendance</div>
                <div class="filter-tab" onclick="showAttendanceTab('reports')">üìà Reports</div>
            </div>

            <!-- Configuration Tab -->
            <div id="attendance-config" class="attendance-tab active">
                <div class="row">
                    <!-- Sessions -->
                    <div class="col-4">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Academic Sessions</div>
                                <button class="btn btn-sm btn-success" onclick="showAddSessionModal()">‚ûï Add</button>
                            </div>
                            <div class="card-body">
                                <div id="sessionsList" style="max-height: 300px; overflow-y: auto;">
                                    <div class="text-center" style="padding: 20px; color: #666;">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Branches -->
                    <div class="col-4">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Branches</div>
                                <button class="btn btn-sm btn-success" onclick="showAddBranchModal()">‚ûï Add</button>
                            </div>
                            <div class="card-body">
                                <div id="branchesList" style="max-height: 300px; overflow-y: auto;">
                                    <div class="text-center" style="padding: 20px; color: #666;">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Periods -->
                    <div class="col-4">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Class Periods</div>
                                <button class="btn btn-sm btn-success" onclick="showAddPeriodModal()">‚ûï Add</button>
                            </div>
                            <div class="card-body">
                                <div id="periodsList" style="max-height: 300px; overflow-y: auto;">
                                    <div class="text-center" style="padding: 20px; color: #666;">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subjects Tab -->
            <div id="attendance-subjects" class="attendance-tab" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Subject Management</div>
                        <button class="btn btn-success" onclick="showAddSubjectModal()">‚ûï Add Subject</button>
                    </div>
                    <div class="card-body">
                        <!-- Filters -->
                        <div class="row" style="margin-bottom: 20px;">
                            <div class="col-3">
                                <label>Session</label>
                                <select id="subjectFilterSession" class="form-control" onchange="filterSubjects()">
                                    <option value="">All Sessions</option>
                                </select>
                            </div>
                            <div class="col-3">
                                <label>Branch</label>
                                <select id="subjectFilterBranch" class="form-control" onchange="filterSubjects()">
                                    <option value="">All Branches</option>
                                </select>
                            </div>
                            <div class="col-3">
                                <label>Semester</label>
                                <select id="subjectFilterSemester" class="form-control" onchange="filterSubjects()">
                                    <option value="">All Semesters</option>
                                    <option value="1">Semester 1</option>
                                    <option value="2">Semester 2</option>
                                    <option value="3">Semester 3</option>
                                    <option value="4">Semester 4</option>
                                    <option value="5">Semester 5</option>
                                    <option value="6">Semester 6</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="subjectsList">
                            <div class="text-center" style="padding: 40px; color: #666;">Loading subjects...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student Enrollment Tab -->
            <div id="attendance-enrollments" class="attendance-tab" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Student Enrollment</div>
                    </div>
                    <div class="card-body">
                        <!-- Enrollment Form -->
                        <div class="row" style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <div class="col-12">
                                <h5 style="margin-bottom: 15px; color: #333;">‚ûï Add Student Enrollment</h5>
                            </div>
                            <div class="col-3">
                                <label>Session *</label>
                                <select id="enrollAddSession" class="form-control" required>
                                    <option value="">Select Session</option>
                                </select>
                            </div>
                            <div class="col-3">
                                <label>Branch *</label>
                                <select id="enrollAddBranch" class="form-control" required>
                                    <option value="">Select Branch</option>
                                </select>
                            </div>
                            <div class="col-2">
                                <label>Semester *</label>
                                <select id="enrollAddSemester" class="form-control" required>
                                    <option value="">Select</option>
                                    <option value="1">Semester 1</option>
                                    <option value="2">Semester 2</option>
                                    <option value="3">Semester 3</option>
                                    <option value="4">Semester 4</option>
                                    <option value="5">Semester 5</option>
                                    <option value="6">Semester 6</option>
                                </select>
                            </div>
                            <div class="col-4">
                                <label>Student *</label>
                                <select id="enrollAddStudent" class="form-control" required>
                                    <option value="">Select Student</option>
                                </select>
                            </div>
                            <div class="col-12" style="margin-top: 15px;">
                                <button class="btn btn-success" onclick="enrollStudent()">‚úÖ Enroll Student</button>
                                <button class="btn btn-secondary" onclick="resetEnrollmentForm()" style="margin-left: 10px;">üîÑ Reset</button>
                            </div>
                        </div>
                        
                        <!-- Filters -->
                        <div class="row" style="margin-bottom: 20px;">
                            <div class="col-3">
                                <label>Filter by Session</label>
                                <select id="enrollFilterSession" class="form-control" onchange="filterEnrollments()">
                                    <option value="">All Sessions</option>
                                </select>
                            </div>
                            <div class="col-3">
                                <label>Filter by Branch</label>
                                <select id="enrollFilterBranch" class="form-control" onchange="filterEnrollments()">
                                    <option value="">All Branches</option>
                                </select>
                            </div>
                            <div class="col-3">
                                <label>Filter by Semester</label>
                                <select id="enrollFilterSemester" class="form-control" onchange="filterEnrollments()">
                                    <option value="">All Semesters</option>
                                    <option value="1">Semester 1</option>
                                    <option value="2">Semester 2</option>
                                    <option value="3">Semester 3</option>
                                    <option value="4">Semester 4</option>
                                    <option value="5">Semester 5</option>
                                    <option value="6">Semester 6</option>
                                </select>
                            </div>
                            <div class="col-3">
                                <label>&nbsp;</label>
                                <button class="btn btn-primary form-control" onclick="loadEnrollmentsData()">üîç Refresh</button>
                            </div>
                        </div>
                        
                        <div id="enrollmentsList">
                            <div class="text-center" style="padding: 40px; color: #666;">Loading enrollments...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monitor Attendance Tab -->
            <div id="attendance-monitor" class="attendance-tab" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Monitor & Edit Attendance</div>
                    </div>
                    <div class="card-body">
                        <!-- Filters -->
                        <div class="row" style="margin-bottom: 20px;">
                            <div class="col-2">
                                <label>Date</label>
                                <input type="date" id="monitorDate" class="form-control" onchange="filterAttendanceRecords()">
                            </div>
                            <div class="col-2">
                                <label>Session</label>
                                <select id="monitorSession" class="form-control" onchange="filterAttendanceRecords()">
                                    <option value="">All</option>
                                </select>
                            </div>
                            <div class="col-2">
                                <label>Branch</label>
                                <select id="monitorBranch" class="form-control" onchange="filterAttendanceRecords()">
                                    <option value="">All</option>
                                </select>
                            </div>
                            <div class="col-2">
                                <label>Semester</label>
                                <select id="monitorSemester" class="form-control" onchange="filterAttendanceRecords()">
                                    <option value="">All</option>
                                    <option value="1">Sem 1</option>
                                    <option value="2">Sem 2</option>
                                    <option value="3">Sem 3</option>
                                    <option value="4">Sem 4</option>
                                    <option value="5">Sem 5</option>
                                    <option value="6">Sem 6</option>
                                </select>
                            </div>
                            <div class="col-2">
                                <label>&nbsp;</label>
                                <button class="btn btn-primary btn-block" onclick="filterAttendanceRecords()">üîç Search</button>
                            </div>
                        </div>
                        
                        <div id="attendanceRecordsList">
                            <div class="text-center" style="padding: 40px; color: #666;">Select filters and click Search</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="attendance-reports" class="attendance-tab" style="display: none;">
                <div class="row">
                    <div class="col-6">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Daily Attendance Report</div>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Select Date</label>
                                    <input type="date" id="reportDate" class="form-control">
                                </div>
                                <button class="btn btn-primary" onclick="generateDailyReport()">üìä Generate Report</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-6">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Subject-wise Report</div>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Subject</label>
                                    <select id="reportSubject" class="form-control">
                                        <option value="">Select Subject</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="generateSubjectReport()">üìä Generate Report</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <div class="card-title">Student-wise Report</div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-4">
                                <label>Student Email</label>
                                <input type="email" id="reportStudentEmail" class="form-control" placeholder="student@gmcpnalanda.com">
                            </div>
                            <div class="col-4">
                                <label>Session</label>
                                <select id="reportSession" class="form-control">
                                    <option value="">Select Session</option>
                                </select>
                            </div>
                            <div class="col-4">
                                <label>&nbsp;</label>
                                <button class="btn btn-primary btn-block" onclick="generateStudentReport()">üìä Generate Report</button>
                            </div>
                        </div>
                        
                        <div id="studentReportDisplay" style="margin-top: 20px;"></div>
                    </div>
                </div>
                
                <!-- Audit Logs -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <div class="card-title">Attendance Audit Logs</div>
                    </div>
                    <div class="card-body">
                        <div id="auditLogsList">
                            <div class="text-center" style="padding: 20px; color: #666;">Loading audit logs...</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- BIOMETRIC ATTENDANCE SECTION -->
        <section id="biometric-attendance" class="page-section">
            <h2 class="mb-4">üëÜ Biometric Attendance System</h2>
            
            <!-- Stats Cards -->
            <div class="stats-grid" style="margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-value" id="bioEnrolledUsers">0</div>
                    <div class="stat-label">Enrolled Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="bioTodayAttendance">0</div>
                    <div class="stat-label">Today's Attendance</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="bioActiveDevices">0</div>
                    <div class="stat-label">Active Devices</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="bioPendingEnrollments">0</div>
                    <div class="stat-label">Pending Enrollments</div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="filter-tabs" style="margin-bottom: 20px;">
                <div class="filter-tab active" onclick="showBiometricTab('devices')">üì± Devices</div>
                <div class="filter-tab" onclick="showBiometricTab('enrollment')">‚úã Enrollment Status</div>
                <div class="filter-tab" onclick="showBiometricTab('attendance-log')">üìä Attendance Log</div>
                <div class="filter-tab" onclick="showBiometricTab('reports')">üìà Reports</div>
            </div>

            <!-- Devices Tab -->
            <div id="biometric-devices" class="biometric-tab active">
                <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <h3>Biometric Devices</h3>
                    <button class="btn btn-primary" onclick="loadBiometricDevices()">üîÑ Refresh</button>
                </div>
                
                <div id="devicesList">
                    <div class="text-center" style="padding: 40px; color: #666;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <div style="margin-top: 15px;">Click Refresh to load devices...</div>
                    </div>
                </div>
            </div>

            <!-- Enrollment Tab -->
            <div id="biometric-enrollment" class="biometric-tab" style="display: none;">
                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="form-control" placeholder="Search users..." id="bioEnrollmentSearch">
                </div>
                
                <div class="filter-tabs" style="margin-bottom: 20px;">
                    <div class="filter-tab active" onclick="filterBioEnrollment('all')">All</div>
                    <div class="filter-tab" onclick="filterBioEnrollment('active')">‚úÖ Enrolled</div>
                    <div class="filter-tab" onclick="filterBioEnrollment('pending')">‚è≥ Pending</div>
                    <div class="filter-tab" onclick="filterBioEnrollment('not-enrolled')">‚ùå Not Enrolled</div>
                </div>
                
                <div id="bioEnrollmentList">
                    <div class="text-center" style="padding: 40px; color: #666;">
                        <button class="btn btn-primary" onclick="loadBioEnrollmentStatus()">Load Enrollment Status</button>
                    </div>
                </div>
            </div>

            <!-- Attendance Log Tab -->
            <div id="biometric-attendance-log" class="biometric-tab" style="display: none;">
                <div style="margin-bottom: 20px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr auto auto auto;">
                        <div>
                            <label>From Date</label>
                            <input type="date" class="form-control" id="bioAttendanceFromDate">
                        </div>
                        <div>
                            <label>To Date</label>
                            <input type="date" id="bioAttendanceToDate" class="form-control">
                        </div>
                        <div>
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" style="width: 100%;" onclick="loadBioAttendanceLog()">üîç Search</button>
                        </div>
                        <div>
                            <label>&nbsp;</label>
                            <button class="btn btn-success" style="width: 100%;" onclick="exportBioAttendanceCSV()">üì• CSV</button>
                        </div>
                        <div>
                            <label>&nbsp;</label>
                            <button class="btn btn-info" style="width: 100%;" onclick="exportBioAttendancePDF()">üìÑ PDF</button>
                        </div>
                    </div>
                </div>
                
                <div id="bioAttendanceLogList">
                    <div class="text-center" style="padding: 40px; color: #666;">
                        Select date range and click Search to view attendance records
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="biometric-reports" class="biometric-tab" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìà Biometric Attendance Reports</div>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div>
                                <label>Report Type</label>
                                <select class="form-control" id="bioReportType">
                                    <option value="daily">Daily Report</option>
                                    <option value="weekly">Weekly Report</option>
                                    <option value="monthly">Monthly Report</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                            <div>
                                <label>User Filter</label>
                                <select class="form-control" id="bioReportUserFilter">
                                    <option value="all">All Users</option>
                                    <option value="students">Students Only</option>
                                    <option value="faculty">Faculty Only</option>
                                </select>
                            </div>
                            <div>
                                <label>From Date</label>
                                <input type="date" class="form-control" id="bioReportFromDate">
                            </div>
                            <div>
                                <label>To Date</label>
                                <input type="date" class="form-control" id="bioReportToDate">
                            </div>
                        </div>
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="generateBioReport()">üìä Generate Report</button>
                            <button class="btn btn-success" onclick="downloadBioReportPDF()">üì• Download PDF</button>
                            <button class="btn btn-light" onclick="downloadBioReportCSV()">üìÑ Download CSV</button>
                        </div>
                    </div>
                </div>
                
                <div id="bioReportResults" style="margin-top: 20px;">
                    <!-- Report results will be shown here -->
                </div>
            </div>
        </section>

        <section id="system" class="page-section">
            <h2 class="mb-4">System Settings</h2>
            
            <div class="card">
                <div class="card-header"><div class="card-title">General Settings</div></div>
                <div class="card-body">
                    <div class="system-setting">
                        <div>
                            <div style="font-weight: 500;">User Registration</div>
                            <div style="font-size: 13px; color: #666;">Allow new user self-registration</div>
                        </div>
                        <div class="toggle-switch" onclick="toggleSetting(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="system-setting">
                        <div>
                            <div style="font-weight: 500;">Email Notifications</div>
                            <div style="font-size: 13px; color: #666;">Send system notifications via email</div>
                        </div>
                        <div class="toggle-switch active" onclick="toggleSetting(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="system-setting">
                        <div>
                            <div style="font-weight: 500;">Maintenance Mode</div>
                            <div style="font-size: 13px; color: #666;">Put system in maintenance mode</div>
                        </div>
                        <div class="toggle-switch" onclick="toggleSetting(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><div class="card-title">Security Settings</div></div>
                <div class="card-body">
                    <div class="system-setting">
                        <div>
                            <div style="font-weight: 500;">Two-Factor Authentication</div>
                            <div style="font-size: 13px; color: #666;">Require 2FA for admin accounts</div>
                        </div>
                        <div class="toggle-switch active" onclick="toggleSetting(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="system-setting">
                        <div>
                            <div style="font-weight: 500;">Session Timeout</div>
                            <div style="font-size: 13px; color: #666;">Auto-logout after inactivity</div>
                        </div>
                        <div class="toggle-switch active" onclick="toggleSetting(this)">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="logs" class="page-section">
            <h2 class="mb-4">System Logs</h2>
            <div class="card">
                <div class="card-header"><div class="card-title">Recent System Events</div></div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead><tr><th>Timestamp</th><th>User</th><th>Action</th><th>Details</th><th>IP Address</th></tr></thead>
                        <tbody>
                            <tr><td>2025-01-23 10:15:23</td><td>admin@gmcp...</td><td>USER_CREATE</td><td>Created student account</td><td>192.168.1.100</td></tr>
                            <tr><td>2025-01-23 10:12:41</td><td>prof.smith@gmcp...</td><td>LOGIN</td><td>Successful login</td><td>192.168.1.101</td></tr>
                            <tr><td>2025-01-23 10:05:12</td><td>admin@gmcp...</td><td>SETTINGS_UPDATE</td><td>Updated system settings</td><td>192.168.1.100</td></tr>
                            <tr><td>2025-01-23 09:58:33</td><td>system</td><td>BACKUP</td><td>Daily backup completed</td><td>localhost</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="backup" class="page-section">
            <h2 class="mb-4">Backup & Security</h2>
            <div class="row">
                <div class="col-6">
                    <div class="card">
                        <div class="card-header"><div class="card-title">Database Backup</div></div>
                        <div class="card-body">
                            <div class="detail-row"><span>Last Backup</span><span class="text-success">Today 2:00 AM</span></div>
                            <div class="detail-row"><span>Backup Size</span><span>2.4 GB</span></div>
                            <div class="detail-row"><span>Status</span><span class="text-success">Healthy</span></div>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-primary btn-sm">üíæ Create Backup</button>
                                <button class="btn btn-light btn-sm">üì• Download</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card">
                        <div class="card-header"><div class="card-title">Security Status</div></div>
                        <div class="card-body">
                            <div class="detail-row"><span>SSL Certificate</span><span class="text-success">Valid</span></div>
                            <div class="detail-row"><span>Last Security Scan</span><span>Jan 20, 2025</span></div>
                            <div class="detail-row"><span>Threats Detected</span><span class="text-success">0</span></div>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-warning btn-sm">üîç Run Scan</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="profile" class="page-section">
            <h2 class="mb-4">Administrator Profile</h2>
            <div class="card">
                <div class="card-body">
                    <div class="detail-row"><span>Name</span><span id="detailName">System Administrator</span></div>
                    <div class="detail-row"><span>Email</span><span id="detailEmail">admin@gmcpnalanda.com</span></div>
                    <div class="detail-row"><span>Role</span><span>Administrator</span></div>
                    <div class="detail-row"><span>Employee ID</span><span id="detailEmployeeId">ADM001</span></div>
                    <div class="detail-row"><span>Last Login</span><span>Today at 9:30 AM</span></div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary">‚úèÔ∏è Edit Profile</button>
                        <button class="btn btn-warning">üîë Change Password</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="js/userManager.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // IMMEDIATE AUTHENTICATION CHECK - Runs before anything else
        (function() {
            const user = authManager?.getCurrentUser();
            if (!user || user.role !== 'admin') {
                console.error('‚ùå Unauthorized access attempt to admin portal');
                window.location.href = '/login.html';
                throw new Error('Unauthorized access');
            }
        })();
        
        console.log('üöÄ Admin Portal JavaScript Started');
        
        // CRITICAL: Enforce admin authentication
        try {
            if (authManager && authManager.requireRole) {
                authManager.requireRole('admin');
            } else {
                console.error('‚ùå Auth manager not loaded - redirecting to login');
                window.location.href = '/login.html';
            }
        } catch (e) {
            console.error('‚ùå Authentication failed:', e);
            window.location.href = '/login.html';
        }
        
        const u = authManager.getCurrentUser();
        if (u) {
            document.getElementById('userName').textContent = u.name;
            document.getElementById('detailName').textContent = u.name || '';
            document.getElementById('detailEmail').textContent = u.email || '';
            document.getElementById('detailEmployeeId').textContent = u.employeeId || '';
        }

        function showSection(id){ 
            document.querySelectorAll('.page-section').forEach(s=>s.classList.remove('active')); 
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
            event.target.classList.add('active');
            
            // Load data when sections are shown
            if (id === 'hostel-issues') {
                loadHostelIssues('All');
            } else if (id === 'feedback-management') {
                loadFeedbackLinks();
            }
        }

        // showRoleFields removed - users now fill their own profile data

        function filterByRole(role) {
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const users = document.querySelectorAll('.user-item');
            users.forEach(user => {
                if (role === 'all' || user.dataset.role === role) {
                    user.style.display = 'flex';
                } else {
                    user.style.display = 'none';
                }
            });
        }

        function filterUsers() {
            const query = document.getElementById('userSearch').value.toLowerCase();
            const users = document.querySelectorAll('.user-item');
            users.forEach(user => {
                const text = user.textContent.toLowerCase();
                user.style.display = text.includes(query) ? 'flex' : 'none';
            });
        }

        function updateSelection() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            const count = checkboxes.length;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('bulkActions').classList.toggle('active', count > 0);
        }

        function clearSelection() {
            document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
            updateSelection();
        }

        async function bulkAction(action) {
            const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
            const selected = selectedCheckboxes.length;
            
            if (selected === 0) {
                showMessage('Please select at least one user', 'error');
                return;
            }
            
            if (action === 'delete') {
                const confirmation = confirm(
                    `Are you sure you want to delete ${selected} user(s)?\n\n` +
                    `This action cannot be undone and will permanently remove:\n` +
                    `- User accounts\n` +
                    `- User profiles\n` +
                    `- Associated data\n\n` +
                    `Type "DELETE" to confirm:`
                );
                
                if (!confirmation) {
                    return;
                }
                
                const confirmText = prompt('Please type "DELETE" to confirm:');
                if (confirmText !== 'DELETE') {
                    showMessage('Deletion cancelled - confirmation text did not match', 'info');
                    return;
                }
            }
            
            // Extract email addresses from selected users
            const userEmails = [];
            selectedCheckboxes.forEach(checkbox => {
                const userItem = checkbox.closest('.user-item');
                const emailElement = userItem.querySelector('.user-email');
                if (emailElement) {
                    const emailText = emailElement.textContent;
                    // Extract email from format "email@domain.com ‚Ä¢ ID ‚Ä¢ Role"
                    // Split by bullet point and take first part, then clean all whitespace
                    const email = emailText.split('‚Ä¢')[0].trim().replace(/\s+/g, '');
                    if (email && email.includes('@')) {
                        userEmails.push(email);
                        console.log('Extracted email for deletion:', email);
                    } else {
                        console.warn('Invalid email extracted:', email, 'from text:', emailText);
                    }
                }
            });
            
            console.log('Emails to delete:', userEmails);
            
            try {
                showMessage(`${action === 'delete' ? 'Deleting' : 'Processing'} ${selected} user(s)...`, 'info');
                
                // Use JSON-based API for bulk operations
                const response = await fetch(`/api/users/bulk-${action}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        emails: userEmails
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const count = result.deleted || result.deletedCount || result.processedCount || selected;
                    showMessage(`Successfully ${action === 'delete' ? 'deleted' : 'processed'} ${count} user(s)!`, 'success');
                    
                    // Clear selection
                    clearSelection();
                    
                    // Refresh the full user list immediately
                    await updateUsersList();
                } else {
                    const errorMsg = result.error || result.message || 'Unknown error';
                    const details = result.details ? `\n\nDetails: ${JSON.stringify(result.details, null, 2)}` : '';
                    showMessage(`Failed to ${action} users: ${errorMsg}${details}`, 'error');
                    console.error('Bulk action failed:', result);
                }
                
            } catch (error) {
                console.error(`Bulk ${action} error:`, error);
                showMessage(`Error performing ${action}: ${error.message}`, 'error');
            }
        }

        function editUser(email) {
            showMessage(`Edit user functionality for ${email}`, 'info');
        }

        function viewUser(email) {
            showMessage(`View user details for ${email}`, 'info');
        }
        
        async function resetUserPassword(email) {
            // Show password reset modal
            showPasswordResetModal(email);
        }
        
        function showPasswordResetModal(email) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; margin: 20px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                ">
                    <h3 style="margin-bottom: 20px; color: #333;">üîë Reset Password</h3>
                    <p style="margin-bottom: 20px; color: #666; line-height: 1.6;">
                        Reset password for: <strong>${email}</strong><br>
                        The user will be required to change their password on next login.
                    </p>
                    <form id="resetPasswordForm">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
                                New Password:
                            </label>
                            <input type="password" id="newPassword" required minlength="8" 
                                   placeholder="Enter new password (min 8 characters)"
                                   style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px;">
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                Password must be at least 8 characters long
                            </small>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="requirePasswordChange" checked>
                                <span style="font-size: 14px; color: #333;">Require user to change password on next login</span>
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                            <button type="button" onclick="closePasswordResetModal()" style="
                                padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;
                            ">Cancel</button>
                            <button type="submit" style="
                                padding: 10px 20px; border: none; background: #ff6b6b; color: white; border-radius: 6px; cursor: pointer;
                            ">Reset Password</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newPassword = document.getElementById('newPassword').value.trim();
                const requirePasswordChange = document.getElementById('requirePasswordChange').checked;
                
                if (newPassword.length < 8) {
                    showMessage('Password must be at least 8 characters long', 'error');
                    return;
                }
                
                try {
                    showMessage('Resetting password...', 'info');
                    const result = await resetPasswordViaAPI(email, newPassword, requirePasswordChange);
                    
                    if (result.success) {
                        showMessage(`Password reset successfully for ${email}!`, 'success');
                        closePasswordResetModal();
                    } else {
                        showMessage(`Failed to reset password: ${result.error}`, 'error');
                    }
                } catch (error) {
                    showMessage(`Error resetting password: ${error.message}`, 'error');
                }
            });
            
            // Store reference for closing
            window.currentPasswordResetModal = modal;
        }
        
        function closePasswordResetModal() {
            if (window.currentPasswordResetModal) {
                window.currentPasswordResetModal.remove();
                window.currentPasswordResetModal = null;
            }
        }
        
        // API function for password reset
        async function resetPasswordViaAPI(email, newPassword, requirePasswordChange = true) {
            try {
                const response = await fetch('/api/users/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: email,
                        newPassword: newPassword,
                        requirePasswordChange: requirePasswordChange
                    })
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('API Error resetting password:', error);
                throw error;
            }
        }

        async function deleteUser(email) {
            const confirmed = confirm(
                `‚ö†Ô∏è PERMANENT DELETION WARNING\n\n` +
                `You are about to PERMANENTLY delete: ${email}\n\n` +
                `This will remove ALL data including:\n` +
                `- User account\n` +
                `- Profile information\n` +
                `- Hostel data & requests\n` +
                `- üìä Attendance enrollments\n` +
                `- üìä Attendance records\n` +
                `- üìä Attendance summaries\n` +
                `- All notifications\n\n` +
                `This action is IRREVERSIBLE and cannot be undone!\n\n` +
                `Click OK to proceed with PERMANENT deletion.`
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                console.log('üóëÔ∏è Attempting to delete user:', email);
                showMessage('Deleting user...', 'info');
                
                const result = await deleteUserViaAPI(email);
                
                console.log('üìä Delete result:', result);
                
                if (result.success) {
                    const summary = result.deletionSummary;
                    
                    // Build comprehensive deletion message
                    let deletionDetails = [];
                    if (summary.firestoreCollections) deletionDetails.push('‚úÖ Firestore database');
                    if (summary.firebaseAuthentication) deletionDetails.push('‚úÖ Firebase Authentication');
                    if (summary.profileData) deletionDetails.push('‚úÖ Profile (JSON)');
                    if (summary.hostelData) deletionDetails.push('‚úÖ Hostel data (JSON)');
                    if (summary.requestsDeleted > 0) deletionDetails.push(`‚úÖ ${summary.requestsDeleted} request(s)`);
                    if (summary.notificationsDeleted > 0) deletionDetails.push(`‚úÖ ${summary.notificationsDeleted} notification(s)`);
                    if (summary.attendanceEnrollmentsDeleted > 0) deletionDetails.push(`‚úÖ ${summary.attendanceEnrollmentsDeleted} enrollment(s)`);
                    if (summary.attendanceRecordsModified > 0) deletionDetails.push(`‚úÖ Modified ${summary.attendanceRecordsModified} attendance record(s)`);
                    if (summary.attendanceSummariesDeleted > 0) deletionDetails.push(`‚úÖ ${summary.attendanceSummariesDeleted} attendance summary/summaries`);
                    
                    const deletionMessage = deletionDetails.length > 0 
                        ? `\n\nDeleted:\n${deletionDetails.join('\n')}`
                        : '';
                    
                    showMessage(
                        `‚úÖ User PERMANENTLY deleted!\n` +
                        `${email} and all associated data have been removed from the entire LMS.${deletionMessage}`,
                        'success'
                    );
                    
                    console.log('üìÑ Full deletion summary:', result.deletionSummary);
                    
                    // Refresh the user list
                    await updateUsersList();
                } else {
                    showMessage(`Failed to delete user: ${result.error || result.message}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå Delete error:', error);
                showMessage(`Error deleting user: ${error.message}`, 'error');
            }
        }
        
        // View User Profile
        async function viewUser(email) {
            const modal = document.getElementById('viewUserModal');
            const contentDiv = document.getElementById('userProfileContent');
            
            modal.style.display = 'flex';
            contentDiv.innerHTML = '<div class="text-center" style="padding: 40px;"><div class="spinner-border text-primary"></div><div style="margin-top: 15px;">Loading profile...</div></div>';
            
            try {
                console.log('üîç Fetching user data for:', email);
                
                // Fetch user data from JSON-based API
                const response = await fetch(`/api/users/${encodeURIComponent(email)}`, {
                    credentials: 'include'
                });
                
                console.log('üì° Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error:', errorText);
                    throw new Error(`Failed to load user data: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ User data received:', result);
                const user = result.user;
                
                // Fetch student profile if user is a student
                let profile = null;
                if (user.role === 'student') {
                    try {
                        // Try with full email first
                        let profileResponse = await fetch(`/api/profile/${encodeURIComponent(user.email)}`, {
                            credentials: 'include'
                        });
                        
                        // If not found, try with username part only
                        if (!profileResponse.ok) {
                            profileResponse = await fetch(`/api/profile/${user.email.split('@')[0]}`, {
                                credentials: 'include'
                            });
                        }
                        
                        if (profileResponse.ok) {
                            const profileResult = await profileResponse.json();
                            profile = profileResult.profile;
                            console.log('‚úÖ Loaded student profile:', profile);
                        } else {
                            console.log('‚ö†Ô∏è Profile not found for:', user.email);
                        }
                    } catch (e) {
                        console.log('‚ùå Error loading profile:', e);
                    }
                }
                
                // Fetch faculty profile if user is a teacher
                let facultyProfile = null;
                if (user.role === 'teacher') {
                    try {
                        const facultyResponse = await fetch(`/api/faculty/profile/${encodeURIComponent(user.email)}`, {
                            credentials: 'include'
                        });
                        
                        if (facultyResponse.ok) {
                            const facultyResult = await facultyResponse.json();
                            facultyProfile = facultyResult.profile;
                            console.log('‚úÖ Loaded faculty profile:', facultyProfile);
                        } else {
                            console.log('‚ö†Ô∏è Faculty profile not found for:', user.email);
                        }
                    } catch (e) {
                        console.log('‚ùå Error loading faculty profile:', e);
                    }
                }
                
                // Build profile HTML
                let html = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 10px;">${user.name.split(' ').map(n => n[0]).join('').toUpperCase()}</div>
                        <h3 style="margin: 0;">${user.name}</h3>
                        <p style="margin: 5px 0; opacity: 0.9;">${user.email}</p>
                        <span style="background: rgba(255,255,255,0.3); padding: 5px 15px; border-radius: 20px; font-size: 14px;">
                            ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}
                        </span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="color: #666; font-size: 13px; margin-bottom: 5px;">Status</div>
                            <div style="font-weight: 600;">${user.status || 'Active'}</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="color: #666; font-size: 13px; margin-bottom: 5px;">Account Created</div>
                            <div style="font-weight: 600;">${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A'}</div>
                        </div>
                    </div>
                `;
                
                // Add student profile details if available
                if (user.role === 'student' && profile) {
                    html += `
                        <h4 style="margin-top: 20px; margin-bottom: 15px; color: #667eea;">üéì Student Profile Information</h4>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                ${profile.studentName ? `<div><div style="color: #666; font-size: 13px;">Student Name</div><div style="font-weight: 600; margin-top: 5px;">${profile.studentName}</div></div>` : ''}
                                ${profile.studentId ? `<div><div style="color: #666; font-size: 13px;">Student ID</div><div style="font-weight: 600; margin-top: 5px;">${profile.studentId}</div></div>` : ''}
                                ${profile.bloodGroup ? `<div><div style="color: #666; font-size: 13px;">Blood Group</div><div style="font-weight: 600; margin-top: 5px;">${profile.bloodGroup}</div></div>` : ''}
                                ${profile.gender ? `<div><div style="color: #666; font-size: 13px;">Gender</div><div style="font-weight: 600; margin-top: 5px;">${profile.gender.charAt(0).toUpperCase() + profile.gender.slice(1)}</div></div>` : ''}
                                ${profile.dateOfBirth ? `<div><div style="color: #666; font-size: 13px;">Date of Birth</div><div style="font-weight: 600; margin-top: 5px;">${new Date(profile.dateOfBirth).toLocaleDateString()}</div></div>` : ''}
                                ${profile.currentSemester ? `<div><div style="color: #666; font-size: 13px;">Current Semester</div><div style="font-weight: 600; margin-top: 5px;">Semester ${profile.currentSemester}</div></div>` : ''}
                                ${profile.session ? `<div><div style="color: #666; font-size: 13px;">Session</div><div style="font-weight: 600; margin-top: 5px;">${profile.session}</div></div>` : ''}
                                ${profile.course ? `<div><div style="color: #666; font-size: 13px;">Course</div><div style="font-weight: 600; margin-top: 5px;">${profile.course}</div></div>` : ''}
                                ${profile.residenceType ? `<div><div style="color: #666; font-size: 13px;">Residence Type</div><div style="font-weight: 600; margin-top: 5px;">${profile.residenceType === 'hosteller' ? 'üè† Hosteller' : 'üö∂ Day Boarder'}</div></div>` : ''}
                                ${profile.fatherName ? `<div><div style="color: #666; font-size: 13px;">Father's Name</div><div style="font-weight: 600; margin-top: 5px;">${profile.fatherName}</div></div>` : ''}
                                ${profile.motherName ? `<div><div style="color: #666; font-size: 13px;">Mother's Name</div><div style="font-weight: 600; margin-top: 5px;">${profile.motherName}</div></div>` : ''}
                                ${profile.studentContact ? `<div><div style="color: #666; font-size: 13px;">Student Contact</div><div style="font-weight: 600; margin-top: 5px;">${profile.studentContact}</div></div>` : ''}
                                ${profile.parentsContact ? `<div><div style="color: #666; font-size: 13px;">Parents Contact</div><div style="font-weight: 600; margin-top: 5px;">${profile.parentsContact}</div></div>` : ''}
                                ${profile.pincode ? `<div><div style="color: #666; font-size: 13px;">Pincode</div><div style="font-weight: 600; margin-top: 5px;">${profile.pincode}</div></div>` : ''}
                                ${profile.district ? `<div><div style="color: #666; font-size: 13px;">District</div><div style="font-weight: 600; margin-top: 5px;">${profile.district}</div></div>` : ''}
                                ${profile.state ? `<div><div style="color: #666; font-size: 13px;">State</div><div style="font-weight: 600; margin-top: 5px;">${profile.state}</div></div>` : ''}
                                ${profile.address ? `<div style="grid-column: 1 / -1;"><div style="color: #666; font-size: 13px;">Address</div><div style="font-weight: 600; margin-top: 5px;">${profile.address}</div></div>` : ''}
                                ${profile.profilePicture ? `<div style="grid-column: 1 / -1; text-align: center; margin-top: 10px;"><img src="${profile.profilePicture}" alt="Profile" style="max-width: 200px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);"></div>` : ''}
                            </div>
                        </div>
                    `;
                    
                    // Add hostel information if student is a hosteller and has hostel info
                    if (user.hostelInfo && user.hostelInfo.isComplete) {
                        const roommates = user.hostelInfo.roommates || [];
                        const roommatesContacts = user.hostelInfo.roommatesContacts || [];
                        let roommatesHtml = '';
                        
                        if (roommates.length > 0) {
                            roommatesHtml = roommates.map((name, index) => {
                                const contact = roommatesContacts[index] || 'No contact';
                                return `<div><div style="color: #666; font-size: 13px;">Roommate ${index + 1}</div><div style="font-weight: 600; margin-top: 5px;">${name}<br><span style="font-size: 12px; color: #999;">${contact}</span></div></div>`;
                            }).join('');
                        } else {
                            roommatesHtml = '<div style="grid-column: 1 / -1; text-align: center; color: #999; padding: 10px;">No roommates</div>';
                        }
                        
                        html += `
                            <h4 style="margin-top: 20px; margin-bottom: 15px; color: #667eea;">üè† Room Information</h4>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div><div style="color: #666; font-size: 13px;">Room Number</div><div style="font-weight: 600; margin-top: 5px;">${user.hostelInfo.roomNumber || 'N/A'}</div></div>
                                    <div><div style="color: #666; font-size: 13px;">Allotment Date</div><div style="font-weight: 600; margin-top: 5px;">${user.hostelInfo.allotmentDate ? new Date(user.hostelInfo.allotmentDate).toLocaleDateString() : 'N/A'}</div></div>
                                    <div><div style="color: #666; font-size: 13px;">Warden Name</div><div style="font-weight: 600; margin-top: 5px;">${user.hostelInfo.wardenName || 'N/A'}</div></div>
                                    <div><div style="color: #666; font-size: 13px;">Contact Number</div><div style="font-weight: 600; margin-top: 5px;">${user.hostelInfo.contactNumber || 'N/A'}</div></div>
                                    ${roommatesHtml}
                                </div>
                            </div>
                        `;
                    } else if (profile && profile.residenceType === 'hosteller') {
                        html += `
                            <h4 style="margin-top: 20px; margin-bottom: 15px; color: #667eea;">üè† Room Information</h4>
                            <div style="text-align: center; padding: 30px; color: #666; background: #f8f9fa; border-radius: 10px;">
                                <div style="font-size: 36px; margin-bottom: 10px;">üè†</div>
                                <div style="font-weight: 600; margin-bottom: 5px;">Hostel Information Not Completed</div>
                                <div style="font-size: 14px;">This hosteller hasn't filled in their hostel details yet.</div>
                            </div>
                        `;
                    }
                } else if (user.role === 'student') {
                    html += `
                        <div style="text-align: center; padding: 40px; color: #666; background: #f8f9fa; border-radius: 10px; margin-top: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üìù</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Profile Not Completed</div>
                            <div style="font-size: 14px;">This student hasn't filled in their profile details yet.</div>
                        </div>
                    `;
                }
                
                // Add faculty profile details if available
                if (user.role === 'teacher' && facultyProfile) {
                    html += `
                        <h4 style="margin-top: 20px; margin-bottom: 15px; color: #00b894;">üë®‚Äçüè´ Faculty Profile Information</h4>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                ${facultyProfile.fullName ? `<div><div style="color: #666; font-size: 13px;">Full Name</div><div style="font-weight: 600; margin-top: 5px;">${facultyProfile.fullName}</div></div>` : ''}
                                ${facultyProfile.email ? `<div><div style="color: #666; font-size: 13px;">Email</div><div style="font-weight: 600; margin-top: 5px;">${facultyProfile.email}</div></div>` : ''}
                                ${facultyProfile.employeeId ? `<div><div style="color: #666; font-size: 13px;">Employee ID</div><div style="font-weight: 600; margin-top: 5px;">${facultyProfile.employeeId}</div></div>` : ''}
                                ${facultyProfile.designation ? `<div><div style="color: #666; font-size: 13px;">Designation</div><div style="font-weight: 600; margin-top: 5px;">${facultyProfile.designation}</div></div>` : ''}
                                ${facultyProfile.department ? `<div><div style="color: #666; font-size: 13px;">Department</div><div style="font-weight: 600; margin-top: 5px;">${facultyProfile.department}</div></div>` : ''}
                                ${facultyProfile.subjectSpecialization ? `<div><div style="color: #666; font-size: 13px;">Subject Specialization</div><div style="font-weight: 600; margin-top: 5px;">${facultyProfile.subjectSpecialization}</div></div>` : ''}
                                ${facultyProfile.qualification ? `<div><div style="color: #666; font-size: 13px;">Qualification</div><div style="font-weight: 600; margin-top: 5px;">${facultyProfile.qualification}</div></div>` : ''}
                                ${facultyProfile.totalExperience ? `<div><div style="color: #666; font-size: 13px;">Total Experience</div><div style="font-weight: 600; margin-top: 5px;">${facultyProfile.totalExperience}</div></div>` : ''}
                                ${facultyProfile.dateOfJoining ? `<div><div style="color: #666; font-size: 13px;">Date of Joining</div><div style="font-weight: 600; margin-top: 5px;">${new Date(facultyProfile.dateOfJoining).toLocaleDateString()}</div></div>` : ''}
                                ${facultyProfile.employmentType ? `<div><div style="color: #666; font-size: 13px;">Employment Type</div><div style="font-weight: 600; margin-top: 5px;">${facultyProfile.employmentType}</div></div>` : ''}
                                ${facultyProfile.mobileNumber ? `<div><div style="color: #666; font-size: 13px;">Mobile Number</div><div style="font-weight: 600; margin-top: 5px;">${facultyProfile.mobileNumber}</div></div>` : ''}
                                ${facultyProfile.dateOfBirth ? `<div><div style="color: #666; font-size: 13px;">Date of Birth</div><div style="font-weight: 600; margin-top: 5px;">${new Date(facultyProfile.dateOfBirth).toLocaleDateString()}</div></div>` : ''}
                                ${facultyProfile.gender ? `<div><div style="color: #666; font-size: 13px;">Gender</div><div style="font-weight: 600; margin-top: 5px;">${facultyProfile.gender.charAt(0).toUpperCase() + facultyProfile.gender.slice(1)}</div></div>` : ''}
                                ${facultyProfile.address ? `<div style="grid-column: 1 / -1;"><div style="color: #666; font-size: 13px;">Address</div><div style="font-weight: 600; margin-top: 5px;">${facultyProfile.address}</div></div>` : ''}
                                ${facultyProfile.profileCompleted ? `<div style="grid-column: 1 / -1; margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 5px; color: #155724; font-size: 13px;">‚úÖ Profile completed on ${new Date(facultyProfile.completedAt).toLocaleString()}</div>` : ''}
                                ${facultyProfile.lastUpdatedBy && facultyProfile.lastUpdatedBy !== facultyProfile.email ? `<div style="grid-column: 1 / -1; padding: 10px; background: #fff3cd; border-radius: 5px; color: #856404; font-size: 13px;">Last updated by ${facultyProfile.lastUpdatedBy} on ${new Date(facultyProfile.lastUpdatedAt).toLocaleString()}</div>` : ''}
                            </div>
                        </div>
                    `;
                } else if (user.role === 'teacher') {
                    html += `
                        <div style="text-align: center; padding: 40px; color: #666; background: #f8f9fa; border-radius: 10px; margin-top: 20px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üìù</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">Profile Not Completed</div>
                            <div style="font-size: 14px;">This faculty member hasn't filled in their profile details yet.</div>
                        </div>
                    `;
                }
                
                contentDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading user profile:', error);
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #d63031;">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <div style="font-weight: 600;">Error Loading Profile</div>
                        <div style="margin-top: 10px; color: #666;">${error.message}</div>
                    </div>
                `;
            }
        }
        
        function closeViewUserModal() {
            document.getElementById('viewUserModal').style.display = 'none';
        }
        
        // Edit User Profile
        async function editUser(email) {
            const modal = document.getElementById('editUserModal');
            const formContent = document.getElementById('editUserFormContent');
            const formButtons = document.getElementById('editUserFormButtons');
            
            document.getElementById('editUserEmail').value = email;
            modal.style.display = 'flex';
            formButtons.style.display = 'none';
            formContent.innerHTML = '<div class="text-center" style="padding: 40px;"><div class="spinner-border text-primary"></div><div style="margin-top: 15px;">Loading profile...</div></div>';
            
            try {
                // Fetch user data and profile
                const userResponse = await fetch(`/api/users/${encodeURIComponent(email)}`, {
                    credentials: 'include'
                });
                
                if (!userResponse.ok) {
                    throw new Error('Failed to load user data');
                }
                
                const userResult = await userResponse.json();
                const user = userResult.user;
                
                // Fetch profile if student
                let profile = null;
                if (user.role === 'student') {
                    try {
                        const profileResponse = await fetch(`/api/profile/${encodeURIComponent(user.email)}`, {
                            credentials: 'include'
                        });
                        if (profileResponse.ok) {
                            const profileResult = await profileResponse.json();
                            profile = profileResult.profile;
                        }
                    } catch (e) {
                        console.log('No profile yet for this student');
                    }
                }
                
                // Build edit form
                let formHTML = `
                    <h4 style="margin-bottom: 15px; color: #667eea;">Basic Information</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" class="form-control" name="name" value="${user.name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label>Email (readonly)</label>
                            <input type="email" class="form-control" value="${user.email}" readonly style="background: #f0f0f0;">
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <select class="form-control" name="role">
                                <option value="student" ${user.role === 'student' ? 'selected' : ''}>Student</option>
                                <option value="teacher" ${user.role === 'teacher' ? 'selected' : ''}>Teacher</option>
                                <option value="management" ${user.role === 'management' ? 'selected' : ''}>Management</option>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select class="form-control" name="status">
                                <option value="active" ${user.status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="inactive" ${user.status !== 'active' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>
                    </div>
                `;
                
                // Add student profile fields if user is a student
                if (user.role === 'student') {
                    formHTML += `
                        <h4 style="margin-bottom: 15px; color: #667eea; margin-top: 20px;">üéì Student Profile</h4>
                        ${profile ? '' : '<div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px; color: #856404;"><strong>Note:</strong> This student hasn\'t filled their profile yet. You can create it here.</div>'}
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Student Name</label>
                                <input type="text" class="form-control" name="studentName" value="${profile?.studentName || ''}">
                            </div>
                            <div class="form-group">
                                <label>Student ID</label>
                                <input type="text" class="form-control" name="studentId" value="${profile?.studentId || ''}">
                            </div>
                            <div class="form-group">
                                <label>Blood Group</label>
                                <select class="form-control" name="bloodGroup">
                                    <option value="">Select...</option>
                                    <option value="A+" ${profile?.bloodGroup === 'A+' ? 'selected' : ''}>A+</option>
                                    <option value="A-" ${profile?.bloodGroup === 'A-' ? 'selected' : ''}>A-</option>
                                    <option value="B+" ${profile?.bloodGroup === 'B+' ? 'selected' : ''}>B+</option>
                                    <option value="B-" ${profile?.bloodGroup === 'B-' ? 'selected' : ''}>B-</option>
                                    <option value="AB+" ${profile?.bloodGroup === 'AB+' ? 'selected' : ''}>AB+</option>
                                    <option value="AB-" ${profile?.bloodGroup === 'AB-' ? 'selected' : ''}>AB-</option>
                                    <option value="O+" ${profile?.bloodGroup === 'O+' ? 'selected' : ''}>O+</option>
                                    <option value="O-" ${profile?.bloodGroup === 'O-' ? 'selected' : ''}>O-</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Gender</label>
                                <select class="form-control" name="gender">
                                    <option value="">Select...</option>
                                    <option value="male" ${profile?.gender === 'male' ? 'selected' : ''}>Male</option>
                                    <option value="female" ${profile?.gender === 'female' ? 'selected' : ''}>Female</option>
                                    <option value="other" ${profile?.gender === 'other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Date of Birth</label>
                                <input type="date" class="form-control" name="dateOfBirth" value="${profile?.dateOfBirth || ''}">
                            </div>
                            <div class="form-group">
                                <label>Current Semester</label>
                                <select class="form-control" name="currentSemester">
                                    <option value="">Select...</option>
                                    ${[1,2,3,4,5,6,7,8].map(sem => `<option value="${sem}" ${profile?.currentSemester == sem ? 'selected' : ''}>Semester ${sem}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Session</label>
                                <select class="form-control" name="session">
                                    <option value="">Select...</option>
                                    <option value="2020-23" ${profile?.session === '2020-23' ? 'selected' : ''}>2020-23</option>
                                    <option value="2021-24" ${profile?.session === '2021-24' ? 'selected' : ''}>2021-24</option>
                                    <option value="2022-25" ${profile?.session === '2022-25' ? 'selected' : ''}>2022-25</option>
                                    <option value="2023-26" ${profile?.session === '2023-26' ? 'selected' : ''}>2023-26</option>
                                    <option value="2024-27" ${profile?.session === '2024-27' ? 'selected' : ''}>2024-27</option>
                                    <option value="2025-28" ${profile?.session === '2025-28' ? 'selected' : ''}>2025-28</option>
                                    <option value="2026-29" ${profile?.session === '2026-29' ? 'selected' : ''}>2026-29</option>
                                    <option value="2027-30" ${profile?.session === '2027-30' ? 'selected' : ''}>2027-30</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Course</label>
                                <select class="form-control" name="course">
                                    <option value="">Select...</option>
                                    <option value="Diploma in Civil Engineering" ${profile?.course === 'Diploma in Civil Engineering' ? 'selected' : ''}>Diploma in Civil Engineering</option>
                                    <option value="Diploma in Mechanical Engineering" ${profile?.course === 'Diploma in Mechanical Engineering' ? 'selected' : ''}>Diploma in Mechanical Engineering</option>
                                    <option value="Diploma in Electrical Engineering" ${profile?.course === 'Diploma in Electrical Engineering' ? 'selected' : ''}>Diploma in Electrical Engineering</option>
                                    <option value="Diploma in Computer Science Engineering" ${profile?.course === 'Diploma in Computer Science Engineering' ? 'selected' : ''}>Diploma in Computer Science Engineering</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Residence Type</label>
                                <select class="form-control" name="residenceType">
                                    <option value="">Select...</option>
                                    <option value="hosteller" ${profile?.residenceType === 'hosteller' ? 'selected' : ''}>üè† Hosteller</option>
                                    <option value="day-boarder" ${profile?.residenceType === 'day-boarder' ? 'selected' : ''}>üö∂ Day Boarder</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Father's Name</label>
                                <input type="text" class="form-control" name="fatherName" value="${profile?.fatherName || ''}">
                            </div>
                            <div class="form-group">
                                <label>Mother's Name</label>
                                <input type="text" class="form-control" name="motherName" value="${profile?.motherName || ''}">
                            </div>
                            <div class="form-group">
                                <label>Student Contact</label>
                                <input type="tel" class="form-control" name="studentContact" value="${profile?.studentContact || ''}">
                            </div>
                            <div class="form-group">
                                <label>Parents Contact</label>
                                <input type="tel" class="form-control" name="parentsContact" value="${profile?.parentsContact || ''}">
                            </div>
                            <div class="form-group">
                                <label>Pincode</label>
                                <input type="text" class="form-control" name="pincode" value="${profile?.pincode || ''}" pattern="[0-9]{6}">
                            </div>
                            <div class="form-group">
                                <label>District</label>
                                <input type="text" class="form-control" name="district" value="${profile?.district || ''}">
                            </div>
                            <div class="form-group">
                                <label>State</label>
                                <input type="text" class="form-control" name="state" value="${profile?.state || ''}">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Address</label>
                                <textarea class="form-control" name="address" rows="2">${profile?.address || ''}</textarea>
                            </div>
                        </div>
                    `;
                }
                
                formContent.innerHTML = formHTML;
                formButtons.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading user for edit:', error);
                formContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #d63031;">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <div style="font-weight: 600;">Error Loading User</div>
                        <div style="margin-top: 10px; color: #666;">${error.message}</div>
                    </div>
                `;
            }
        }
        
        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        // Show and close Create User Modal
        function showCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'flex';
        }

        function closeCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'none';
            const form = document.getElementById('createUserForm');
            if (form) form.reset();
            // Hide ID field
            document.getElementById('idFieldGroup').style.display = 'none';
        }

        function toggleSetting(element) {
            element.classList.toggle('active');
            showMessage('Setting updated', 'success');
        }

        // Add showMessage function
        function showMessage(message, type = 'info') {
            // Create or get message container
            let messageContainer = document.getElementById('messageContainer');
            if (!messageContainer) {
                messageContainer = document.createElement('div');
                messageContainer.id = 'messageContainer';
                messageContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
                document.body.appendChild(messageContainer);
            }
            
            // Create message element
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                padding: 12px 16px; margin-bottom: 10px; border-radius: 8px; font-weight: 500;
                animation: slideIn 0.3s ease-out;
                ${type === 'success' ? 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;' : ''}
                ${type === 'error' ? 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;' : ''}
                ${type === 'info' ? 'background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;' : ''}
            `;
            messageDiv.textContent = message;
            
            messageContainer.appendChild(messageDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }
        
        // Add animation CSS
        const style = document.createElement('style');
        style.textContent = '@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }';
        document.head.appendChild(style);

        // Function to update ID field based on role selection
        function updateIdField() {
            const roleSelect = document.getElementById('userRoleSelect');
            const idFieldGroup = document.getElementById('idFieldGroup');
            const idFieldLabel = document.getElementById('idFieldLabel');
            const idField = document.getElementById('userIdField');
            
            const role = roleSelect.value;
            
            if (role) {
                idFieldGroup.style.display = 'block';
                if (role === 'student') {
                    idFieldLabel.textContent = 'Student ID *';
                    idField.placeholder = 'e.g., S2024001, STU001';
                    idField.name = 'studentId';
                } else {
                    idFieldLabel.textContent = 'Employee ID *';
                    idField.placeholder = 'e.g., EMP001, FAC001';
                    idField.name = 'employeeId';
                }
                idField.required = true;
            } else {
                idFieldGroup.style.display = 'none';
                idField.required = false;
            }
        }
        
        // Function to handle create user form submission
        function setupCreateUserForm() {
            const createUserForm = document.getElementById('createUserForm');
            if (createUserForm) {
                console.log('‚úÖ Found createUserForm, attaching submit handler');
                createUserForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const role = formData.get('role');
                    
                    const userData = {
                        name: formData.get('fullName'),
                        email: formData.get('email'),
                        password: formData.get('password'),
                        role: role,
                        requirePasswordChange: true // Force password change on first login
                    };
                    
                    // Add Student ID or Employee ID based on role
                    if (role === 'student') {
                        userData.studentId = formData.get('studentId');
                        if (!userData.studentId) {
                            showMessage('Student ID is required for students', 'error');
                            return;
                        }
                    } else {
                        userData.employeeId = formData.get('employeeId');
                        if (!userData.employeeId) {
                            showMessage('Employee ID is required for this role', 'error');
                            return;
                        }
                    }
                    
                    if (!authManager.isValidEmail(userData.email)) {
                        showMessage('Please enter a valid @gmcpnalanda.com email address', 'error');
                        return;
                    }
                    
                    console.log('Creating user with basic info:', userData);
                    
                    // Call backend API to create user
                    createUserViaAPI(userData).then(result => {
                        if (result.success) {
                            showMessage(`User ${userData.name} created successfully! They can now login with their email and password.`, 'success');
                            closeCreateUserModal(); // Close the modal
                            
                            // Update dashboard stats if on dashboard
                            updateDashboardStats();
                        } else {
                            showMessage(result.error, 'error');
                        }
                    }).catch(error => {
                        showMessage('Failed to create user: ' + error.message, 'error');
                    });
                });
            } else {
                console.warn('‚ùå createUserForm not found - form submission handler not attached');
            }
        }
        
        // Function to update dashboard statistics
        async function updateDashboardStats() {
            try {
                const users = await getUsersViaAPI();
                const activeUsers = users.filter(u => u.status === 'active');
                
                document.getElementById('totalUsers').textContent = users.length.toString();
                document.getElementById('activeUsers').textContent = activeUsers.length.toString();
                
                // Update user list in the users section
                updateUsersList();
            } catch (error) {
                console.error('Error updating dashboard stats:', error);
            }
        }
        
        // API Functions for backend integration
        async function createUserViaAPI(userData) {
            try {
                // Use JSON-based API for user creation
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(userData)
                });
                
                const result = await response.json();
                
                // Don't show biometric modal for JSON-based creation
                // Just return the result
                
                return result;
            } catch (error) {
                console.error('API Error creating user:', error);
                throw error;
            }
        }
        
        // Show biometric enrollment information after user creation
        function showBiometricEnrollmentInfo(result) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
                z-index: 10001;
            `;
            
            const tempPassword = result.user.tempPassword || 'Not provided';
            const instructions = result.enrollment?.instructions || [];
            
            modal.innerHTML = `
                <div style="
                    background: white; border-radius: 15px; padding: 40px; max-width: 600px; width: 90%; margin: 20px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                ">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div style="font-size: 64px; margin-bottom: 15px;">üéâ</div>
                        <h2 style="margin: 0 0 10px 0; color: #2d3748;">User Created Successfully!</h2>
                        <p style="color: #718096; margin: 0;">Student/Employee ID will be used for biometric enrollment</p>
                    </div>
                    
                    <div style="background: #f7fafc; padding: 25px; border-radius: 10px; margin-bottom: 25px;">
                        <div style="margin-bottom: 20px;">
                            <div style="color: #718096; font-size: 13px; margin-bottom: 5px;">User Name</div>
                            <div style="font-size: 18px; font-weight: 600; color: #2d3748;">${result.user.name}</div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <div style="color: #718096; font-size: 13px; margin-bottom: 5px;">${result.user.role === 'student' ? 'Student ID' : 'Employee ID'} (Biometric ID)</div>
                                <div style="font-size: 24px; font-weight: 700; color: #667eea;">${result.enrollment.biometricId}</div>
                                <div style="color: #48bb78; font-size: 11px; margin-top: 5px;">‚ú® Unified ID for LMS & Biometric</div>
                            </div>
                            <div>
                                <div style="color: #718096; font-size: 13px; margin-bottom: 5px;">Device PIN</div>
                                <div style="font-size: 24px; font-weight: 700; color: #f56565;">${result.enrollment.devicePIN}</div>
                                <div style="color: #718096; font-size: 11px; margin-top: 5px;">Use this for device enrollment</div>
                            </div>
                        </div>
                        
                        ${tempPassword !== 'Not provided' ? `
                            <div style="margin-bottom: 20px;">
                                <div style="color: #718096; font-size: 13px; margin-bottom: 5px;">Temporary Password</div>
                                <div style="font-family: monospace; font-size: 16px; font-weight: 600; color: #2d3748; background: white; padding: 10px; border-radius: 6px;">${tempPassword}</div>
                                <div style="color: #e53e3e; font-size: 12px; margin-top: 5px;">‚ö†Ô∏è User must change password on first login</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="background: #edf2f7; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                        <div style="font-weight: 600; margin-bottom: 15px; color: #2d3748;">üìã Enrollment Instructions:</div>
                        <ol style="margin: 0; padding-left: 20px; color: #4a5568; line-height: 1.8;">
                            ${instructions.map(inst => `<li>${inst}</li>`).join('')}
                        </ol>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="closeBiometricInfoModal()" style="
                            padding: 12px 30px; background: #667eea; color: white; border: none; 
                            border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;
                        ">Got It!</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store modal reference for closing
            window.currentBiometricModal = modal;
        }
        
        // Function to close biometric info modal and cleanup
        function closeBiometricInfoModal() {
            // Remove the biometric info modal
            if (window.currentBiometricModal) {
                window.currentBiometricModal.remove();
                window.currentBiometricModal = null;
            }
            
            // Close the create user modal
            closeCreateUserModal();
            
            // Refresh the user list to show the new user
            updateUsersList();
            
            console.log('‚úÖ Biometric modal closed, user list refreshed');
        }
        
        async function getUsersViaAPI() {
            try {
                console.log('üîÑ getUsersViaAPI: Starting fetch to /api/users');
                const response = await fetch('/api/users', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                console.log('üì° getUsersViaAPI: Received response, status:', response.status);
                const result = await response.json();
                console.log('üì¶ getUsersViaAPI: Parsed JSON result:', result);
                
                // JSON-based API returns users in a users array
                let users = [];
                if (result.success && Array.isArray(result.users)) {
                    users = result.users;
                } else if (Array.isArray(result)) {
                    users = result;
                }
                
                console.log('‚úÖ getUsersViaAPI: Returning', users.length, 'users');
                return users;
            } catch (error) {
                console.error('‚ùå API Error fetching users:', error);
                return [];
            }
        }
        
        async function deleteUserViaAPI(email) {
            try {
                // Use JSON-based API endpoint with email as parameter
                const response = await fetch(`/api/users/${encodeURIComponent(email)}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('API Error deleting user:', error);
                throw error;
            }
        }
        
        // Function to update users list
        async function updateUsersList() {
            const usersList = document.getElementById('usersList');
            if (!usersList) return;
            
            try {
                console.log('Loading users from API...');
                usersList.innerHTML = '<div class="text-center" style="padding: 40px; color: #666;"><div class="spinner-border text-primary" role="status"></div><div style="margin-top: 15px;">Loading users...</div></div>';
                
                const users = await getUsersViaAPI();
                console.log('Loaded users:', users);
                
                usersList.innerHTML = '';
                
                if (!users || users.length === 0) {
                    usersList.innerHTML = '<div class="text-center" style="padding: 40px; color: #666;">No users found in database.<br><button class="btn btn-primary" onclick="updateUsersList()" style="margin-top: 15px;">Retry</button></div>';
                    return;
                }
                
                users.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    userItem.dataset.role = user.role;
                    
                    const initials = user.name ? user.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
                    const badgeColor = {
                        'admin': 'badge-danger',
                        'management': 'badge-info', 
                        'teacher': 'badge-success',
                        'student': 'badge-primary'
                    }[user.role] || 'badge-secondary';
                    
                    // Determine what to show as ID/identifier
                    let identifier = '';
                    if (user.biometricId) {
                        identifier = `üëÜ ${user.biometricId}`;
                    } else if (user.employeeId) {
                        identifier = user.employeeId;
                    } else if (user.studentId) {
                        identifier = user.studentId;
                    }
                    
                    // Show enrollment status badge
                    let enrollmentBadge = '';
                    if (user.biometricData) {
                        const status = user.biometricData.enrollmentStatus;
                        if (status === 'active') {
                            enrollmentBadge = '<span class="badge badge-success">‚úÖ Enrolled</span>';
                        } else if (status === 'pending') {
                            enrollmentBadge = '<span class="badge badge-warning">‚è≥ Pending Enrollment</span>';
                        }
                    }
                    
                    userItem.innerHTML = `
                        <div><input type="checkbox" class="user-checkbox" onchange="updateSelection()"></div>
                        <div class="user-avatar">${initials}</div>
                        <div class="user-info">
                            <div class="user-name">${user.name || 'No Name'}</div>
                            <div class="user-email">${user.email}${identifier ? ' ‚Ä¢ ' + identifier : ''} ‚Ä¢ <span class="badge ${badgeColor}">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</span> ${enrollmentBadge}</div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-sm btn-primary" onclick="editUser('${user.email}')">‚úèÔ∏è Edit</button>
                            <button class="btn btn-sm btn-warning" onclick="resetUserPassword('${user.email}')">üîë Reset Password</button>
                            <button class="btn btn-sm btn-light" onclick="viewUser('${user.email}')">üëÅÔ∏è View</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.email}')">üóëÔ∏è Delete</button>
                        </div>
                    `;
                    
                    usersList.appendChild(userItem);
                });
                
                console.log(`‚úÖ Successfully rendered ${users.length} users`);
                
            } catch (error) {
                console.error('Error updating users list:', error);
                usersList.innerHTML = `
                    <div class="text-center" style="padding: 40px; color: #d63031;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                        <div style="font-weight: 600; margin-bottom: 10px;">Error Loading Users</div>
                        <div style="color: #666; margin-bottom: 15px;">${error.message}</div>
                        <button class="btn btn-primary" onclick="updateUsersList()">Retry</button>
                    </div>
                `;
            }
        }
        
        // Student Profile Management Functions
        let allProfiles = [];
        let currentFilter = 'all';

        async function loadStudentProfiles() {
            try {
                const response = await fetch('/api/profile/all', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    allProfiles = data.profiles || [];
                    renderProfiles();
                } else {
                    alert('Failed to load student profiles');
                }
            } catch (error) {
                console.error('Error loading profiles:', error);
                alert('Error loading profiles');
            }
        }

        function renderProfiles(filter = 'all') {
            const profilesList = document.getElementById('profilesList');
            const loading = document.getElementById('profilesLoading');
            
            if (loading) loading.style.display = 'none';
            
            let filteredProfiles = allProfiles;
            
            // Apply filters
            switch(filter) {
                case 'hosteller':
                    filteredProfiles = allProfiles.filter(p => p.residenceType === 'hosteller');
                    break;
                case 'day-boarder':
                    filteredProfiles = allProfiles.filter(p => p.residenceType === 'day-boarder');
                    break;
                case 'incomplete':
                    filteredProfiles = allProfiles.filter(p => !p.isComplete);
                    break;
            }
            
            if (filteredProfiles.length === 0) {
                profilesList.innerHTML = '<div class="text-center" style="padding: 40px; color: #666;">No student profiles found.</div>';
                return;
            }
            
            const profilesHTML = filteredProfiles.map(profile => `
                <div class="user-item" data-username="${profile.username}">
                    <div class="user-avatar">${profile.studentName ? profile.studentName.split(' ').map(n => n[0]).join('') : 'ST'}</div>
                    <div class="user-info">
                        <div class="user-name">${profile.studentName || 'Unnamed Student'}</div>
                        <div class="user-email">
                            ${profile.studentId || 'No ID'} ‚Ä¢ ${profile.email || profile.username} ‚Ä¢ 
                            <span class="badge ${profile.residenceType === 'hosteller' ? 'badge-info' : 'badge-secondary'}">
                                ${profile.residenceType === 'hosteller' ? 'üè† Hosteller' : 'üö∂ Day Boarder'}
                            </span> ‚Ä¢ 
                            <span class="badge badge-primary">Sem ${profile.currentSemester || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-sm btn-primary" onclick="editProfile('${profile.username}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-sm btn-success" onclick="promoteStudent('${profile.username}', '${profile.studentName}', ${profile.currentSemester})">üéì Promote</button>
                    </div>
                </div>
            `).join('');
            
            profilesList.innerHTML = profilesHTML;
        }

        function filterProfiles(filter) {
            currentFilter = filter;
            renderProfiles(filter);
        }

        async function editProfile(username) {
            try {
                const response = await fetch(`/api/profile/${username}`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const profile = data.profile;
                    
                    // Populate edit form
                    document.getElementById('editUsername').value = username;
                    document.getElementById('editStudentName').value = profile.studentName || '';
                    document.getElementById('editStudentId').value = profile.studentId || '';
                    document.getElementById('editBloodGroup').value = profile.bloodGroup || '';
                    document.getElementById('editCurrentSemester').value = profile.currentSemester || '';
                    document.getElementById('editResidenceType').value = profile.residenceType || '';
                    document.getElementById('editFatherName').value = profile.fatherName || '';
                    document.getElementById('editMotherName').value = profile.motherName || '';
                    document.getElementById('editStudentContact').value = profile.studentContact || '';
                    document.getElementById('editParentsContact').value = profile.parentsContact || '';
                    document.getElementById('editAddress').value = profile.address || '';
                    document.getElementById('editPincode').value = profile.pincode || '';
                    document.getElementById('editDistrict').value = profile.district || '';
                    document.getElementById('editState').value = profile.state || '';
                    
                    // Show modal
                    document.getElementById('profileEditModal').style.display = 'block';
                } else {
                    alert('Failed to load profile for editing');
                }
            } catch (error) {
                console.error('Error loading profile for edit:', error);
                alert('Error loading profile');
            }
        }

        function closeProfileModal() {
            document.getElementById('profileEditModal').style.display = 'none';
        }

        async function saveProfileChanges() {
            try {
                const form = document.getElementById('editProfileForm');
                const formData = new FormData(form);
                const username = document.getElementById('editUsername').value;
                
                const response = await fetch(`/api/profile/${username}`, {
                    method: 'PUT',
                    body: formData,
                    credentials: 'include'
                });
                
                if (response.ok) {
                    alert('Profile updated successfully!');
                    closeProfileModal();
                    loadStudentProfiles();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to update profile'));
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Error saving profile changes');
            }
        }

        function promoteStudent(username, studentName, currentSemester) {
            document.getElementById('promotionUsername').value = username;
            document.getElementById('promotionStudentName').textContent = studentName;
            document.getElementById('currentSemesterDisplay').textContent = `${currentSemester || 'Unknown'} Semester`;
            document.getElementById('newSemester').value = '';
            
            document.getElementById('semesterPromotionModal').style.display = 'block';
        }

        function closeSemesterModal() {
            document.getElementById('semesterPromotionModal').style.display = 'none';
        }

        async function confirmSemesterPromotion() {
            try {
                const username = document.getElementById('promotionUsername').value;
                const newSemester = document.getElementById('newSemester').value;
                
                if (!newSemester) {
                    alert('Please select a semester');
                    return;
                }
                
                const response = await fetch(`/api/profile/${username}/semester`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ semester: parseInt(newSemester) }),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    alert(`Student promoted to semester ${newSemester} successfully!`);
                    closeSemesterModal();
                    loadStudentProfiles();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to promote student'));
                }
            } catch (error) {
                console.error('Error promoting student:', error);
                alert('Error promoting student');
            }
        }

        function exportProfiles() {
            if (allProfiles.length === 0) {
                alert('No profiles to export');
                return;
            }
            
            const headers = ['Username', 'Student Name', 'Student ID', 'Semester', 'Residence Type', 'Blood Group', 'Father Name', 'Mother Name', 'Student Contact', 'Parents Contact', 'Address', 'District', 'State', 'Pincode'];
            const csvContent = [headers.join(',')];
            
            allProfiles.forEach(profile => {
                const row = [
                    profile.username || '',
                    profile.studentName || '',
                    profile.studentId || '',
                    profile.currentSemester || '',
                    profile.residenceType || '',
                    profile.bloodGroup || '',
                    profile.fatherName || '',
                    profile.motherName || '',
                    profile.studentContact || '',
                    profile.parentsContact || '',
                    profile.address || '',
                    profile.district || '',
                    profile.state || '',
                    profile.pincode || ''
                ];
                csvContent.push(row.map(field => `"${field}"`).join(','));
            });
            
            const blob = new Blob([csvContent.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `student_profiles_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Profile data exported successfully!');
        }

        // Override showSection to load profiles when needed
        const originalShowSection = window.showSection;
        let profilesLoaded = false;
        
        window.showSection = function(sectionId) {
            if (originalShowSection) {
                originalShowSection(sectionId);
            } else {
                // Fallback section switching
                document.querySelectorAll('.page-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.getElementById(sectionId).classList.add('active');
                event.target.classList.add('active');
            }
            
            if (sectionId === 'student-profiles' && !profilesLoaded) {
                loadStudentProfiles();
                profilesLoaded = true;
            }
        };

        // Hostel Management Functions
        async function fetchHostelers() {
            try {
                const res = await fetch('/api/hostel/admin/all-hostelers', { credentials: 'include' });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed to fetch hostelers');
                return data;
            } catch (e) {
                console.error('Fetch hostelers error:', e);
                return { success: false, hostelers: [], totalCount: 0 };
            }
        }
        
        async function fetchHostelStats() {
            try {
                const res = await fetch('/api/hostel/admin/hostel-stats', { credentials: 'include' });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed to fetch stats');
                return data.stats;
            } catch (e) {
                console.error('Fetch hostel stats error:', e);
                return { totalHostelers: 0, roomOccupancyStats: {}, wardenStats: {}, courseStats: {} };
            }
        }
        
        async function refreshHostelData() {
            const loading = document.getElementById('hostelersLoading');
            const list = document.getElementById('hostelersList');
            if (loading) loading.style.display = 'block';
            
            const [stats, hostelersResp] = await Promise.all([
                fetchHostelStats(),
                fetchHostelers()
            ]);
            
            // Update stats
            document.getElementById('totalHostelers').textContent = stats.totalHostelers || 0;
            const sharedCount = (stats.roomOccupancyStats && (stats.roomOccupancyStats['2'] || stats.roomOccupancyStats['3'] || stats.roomOccupancyStats['4'])) ?
                (Number(stats.roomOccupancyStats['2'] || 0) + Number(stats.roomOccupancyStats['3'] || 0) + Number(stats.roomOccupancyStats['4'] || 0)) : 0;
            const singleCount = Number((stats.roomOccupancyStats || {})['1'] || 0);
            document.getElementById('singleOccupancy').textContent = singleCount;
            document.getElementById('sharedRooms').textContent = sharedCount;
            document.getElementById('roomsOccupied').textContent = stats.totalHostelers || 0;
            
            // Render list
            renderHostelers(hostelersResp.hostelers || []);
            if (loading) loading.style.display = 'none';
        }
        
        function renderHostelers(hostelers) {
            const container = document.getElementById('hostelersList');
            if (!container) return;
            
            if (!hostelers || hostelers.length === 0) {
                container.innerHTML = '<div class="text-center" style="padding: 40px; color: #666;">No hostel records found.</div>';
                return;
            }
            
            const searchQuery = (document.getElementById('hostelSearch')?.value || '').toLowerCase();
            const filtered = hostelers.filter(h => {
                const hay = `${h.studentName || ''} ${h.studentId || ''} ${h.studentEmail || ''} ${h.roomNumber || ''}`.toLowerCase();
                return hay.includes(searchQuery);
            });
            
            container.innerHTML = filtered.map(h => {
                const initials = (h.studentName || 'ST').split(' ').map(n => n[0]).join('').toUpperCase();
                const roommates = (h.roommates || []).map((n, i) => `${n} (${h.roommatesContacts?.[i] || 'No contact'})`).join(', ') || 'None';
                return `
                    <div class="user-item">
                        <div class="user-avatar">${initials}</div>
                        <div class="user-info">
                            <div class="user-name">${h.studentName || 'Unknown'} ‚Ä¢ <span class="badge badge-primary">${h.roomNumber || 'N/A'}</span></div>
                            <div class="user-email">${h.studentEmail || ''} ‚Ä¢ ${h.studentId || ''} ‚Ä¢ ${h.course || ''} ‚Ä¢ Sem ${h.semester || ''}</div>
                            <div class="user-email">Roommates: ${roommates}</div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-sm btn-primary" onclick="openHostelEdit('${h.studentEmail}')">‚úèÔ∏è Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="confirmDeleteHostel('${h.studentEmail}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function filterHostelers() {
            // Re-render using cached last fetch by re-calling refresh (simple approach)
            refreshHostelData();
        }
        
        function addEditRoommateField(name = '', contact = '') {
            const container = document.getElementById('editRoommatesContainer');
            const row = document.createElement('div');
            row.className = 'row';
            row.style.marginBottom = '8px';
            row.innerHTML = `
                <div class="col-6"><input type="text" class="form-control" placeholder="Roommate name" value="${name}"></div>
                <div class="col-5"><input type="tel" class="form-control" placeholder="Contact (10 digits)" value="${contact}" maxlength="10"></div>
                <div class="col-1"><button type="button" class="btn btn-sm btn-light" onclick="this.closest('div.row').remove()">‚úñÔ∏è</button></div>
            `;
            container.appendChild(row);
        }
        
        function openHostelEdit(email) {
            // Fetch latest record from already rendered list by refetching all (simple)
            fetch('/api/hostel/admin/all-hostelers', { credentials: 'include' })
                .then(r => r.json())
                .then(data => {
                    const rec = (data.hostelers || []).find(h => h.studentEmail === email);
                    if (!rec) return alert('Record not found');
                    
                    document.getElementById('editHostelEmail').value = rec.studentEmail;
                    document.getElementById('editHostelStudentName').value = rec.studentName || '';
                    document.getElementById('editRoomNumber').value = rec.roomNumber || '';
                    document.getElementById('editAllotmentDate').value = (rec.allotmentDate || '').substring(0,10);
                    document.getElementById('editContactNumber').value = rec.contactNumber || '';
                    document.getElementById('editWardenName').value = rec.wardenName || 'Akarshan Raj Rohan';
                    
                    const cont = document.getElementById('editRoommatesContainer');
                    cont.innerHTML = '';
                    const names = rec.roommates || [];
                    const contacts = rec.roommatesContacts || [];
                    if (names.length === 0) addEditRoommateField();
                    names.forEach((n, i) => addEditRoommateField(n, contacts[i] || ''));
                    
                    document.getElementById('hostelEditModal').style.display = 'block';
                })
                .catch(err => {
                    console.error(err);
                    alert('Failed to load record');
                });
        }
        
        function closeHostelModal() {
            document.getElementById('hostelEditModal').style.display = 'none';
        }
        
        async function saveHostelChanges() {
            try {
                const email = document.getElementById('editHostelEmail').value;
                const roomNumber = document.getElementById('editRoomNumber').value.trim();
                const allotmentDate = document.getElementById('editAllotmentDate').value;
                const contactNumber = document.getElementById('editContactNumber').value.trim();
                const wardenName = document.getElementById('editWardenName').value.trim() || 'Akarshan Raj Rohan';
                
                const roommates = [];
                const roommatesContacts = [];
                document.querySelectorAll('#editRoommatesContainer .row').forEach(r => {
                    const inputs = r.querySelectorAll('input');
                    const n = inputs[0].value.trim();
                    const c = inputs[1].value.trim();
                    if (n) { roommates.push(n); roommatesContacts.push(c); }
                });
                
                const res = await fetch('/api/hostel/admin/update-student-hostel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        studentEmail: email,
                        roomNumber,
                        roommates,
                        roommatesContacts,
                        allotmentDate,
                        wardenName,
                        contactNumber
                    })
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed to save');
                
                alert('Hostel information updated');
                closeHostelModal();
                refreshHostelData();
            } catch (e) {
                console.error('Save hostel error:', e);
                alert('Failed to save hostel information');
            }
        }
        
        async function confirmDeleteHostel(email) {
            if (!confirm('Are you sure you want to delete this hostel record?')) return;
            try {
                const res = await fetch(`/api/hostel/admin/delete-student-hostel/${encodeURIComponent(email)}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed to delete');
                alert('Hostel record deleted');
                refreshHostelData();
            } catch (e) {
                console.error('Delete hostel error:', e);
                alert('Failed to delete hostel record');
            }
        }
        
        // Delete hostel record from modal (when editing a record)
        async function deleteHostelRecord() {
            const email = document.getElementById('editHostelEmail').value;
            const studentName = document.getElementById('editHostelStudentName').value || 'this student';
            
            if (!email) {
                alert('No student email found to delete.');
                return;
            }
            
            const confirmMessage = `Are you sure you want to delete the hostel record for ${studentName}?\n\n` +
                                   `Email: ${email}\n\n` +
                                   `This action cannot be undone and will remove:\n` +
                                   `- All hostel information\n` +
                                   `- Room allocation\n` +
                                   `- Roommate data\n\n` +
                                   `The student will need to re-register their hostel information.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                const res = await fetch(`/api/hostel/admin/delete-student-hostel/${encodeURIComponent(email)}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await res.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to delete');
                }
                
                alert(`Hostel record for ${studentName} deleted successfully!`);
                closeHostelModal();
                refreshHostelData();
                
            } catch (e) {
                console.error('Delete hostel record error:', e);
                alert(`Failed to delete hostel record: ${e.message}`);
            }
        }
        
        // Document Management Functions
        async function uploadNotice(formData) {
            try {
                const res = await fetch('/api/documents/upload-notice', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                return await res.json();
            } catch (e) {
                return { success: false, error: 'Upload failed' };
            }
        }
        
        async function uploadMessMenu(formData) {
            try {
                const res = await fetch('/api/documents/upload-mess-menu', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                return await res.json();
            } catch (e) {
                return { success: false, error: 'Upload failed' };
            }
        }
        
        async function fetchDocuments() {
            try {
                const res = await fetch('/api/documents/admin/all', { credentials: 'include' });
                const data = await res.json();
                return data.success ? data.documents : { notices: [], messMenus: [] };
            } catch (e) {
                return { notices: [], messMenus: [] };
            }
        }
        
        async function refreshDocuments() {
            const docs = await fetchDocuments();
            
            // Display notices
            const noticesList = document.getElementById('noticesList');
            if (docs.notices.length === 0) {
                noticesList.innerHTML = '<div class="text-center" style="padding: 20px; color: #666;">No notices uploaded yet</div>';
            } else {
                noticesList.innerHTML = docs.notices.map(notice => `
                    <div class="user-item" style="margin-bottom: 10px;">
                        <div class="user-info">
                            <div class="user-name">${notice.title}</div>
                            <div class="user-email">${formatDate(notice.uploadedAt)} ‚Ä¢ ${(notice.fileSize / 1024).toFixed(1)} KB</div>
                            ${notice.description ? `<div class="user-email">${notice.description}</div>` : ''}
                        </div>
                        <div class="user-actions">
                            <a href="${notice.filePath}" target="_blank" class="btn btn-sm btn-info">üëÅÔ∏è View</a>
                            <button class="btn btn-sm btn-${notice.isActive ? 'warning' : 'success'}" onclick="toggleNotice('${notice.id}')">
                                ${notice.isActive ? '‚è∏Ô∏è Hide' : '‚ñ∂Ô∏è Show'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteNotice('${notice.id}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `).join('');
            }
            
            // Display mess menu
            const messMenuDisplay = document.getElementById('messMenuDisplay');
            if (docs.messMenus.length === 0) {
                messMenuDisplay.innerHTML = '<div class="text-center" style="padding: 20px; color: #666;">No mess menu uploaded yet</div>';
            } else {
                const menu = docs.messMenus[0];
                messMenuDisplay.innerHTML = `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-name">${menu.title}</div>
                            <div class="user-email">${formatDate(menu.uploadedAt)} ‚Ä¢ ${(menu.fileSize / 1024).toFixed(1)} KB</div>
                            ${menu.description ? `<div class="user-email">${menu.description}</div>` : ''}
                        </div>
                        <div class="user-actions">
                            <a href="${menu.filePath}" target="_blank" class="btn btn-sm btn-success">üëÅÔ∏è View Menu</a>
                        </div>
                    </div>
                `;
            }
        }
        
        async function deleteNotice(id) {
            if (!confirm('Are you sure you want to delete this notice?')) return;
            try {
                const res = await fetch(`/api/documents/admin/notice/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const data = await res.json();
                if (data.success) {
                    alert('Notice deleted successfully');
                    refreshDocuments();
                } else {
                    alert('Failed to delete notice');
                }
            } catch (e) {
                alert('Error deleting notice');
            }
        }
        
        async function toggleNotice(id) {
            try {
                const res = await fetch(`/api/documents/admin/notice/${id}/toggle`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await res.json();
                if (data.success) {
                    refreshDocuments();
                } else {
                    alert('Failed to toggle notice status');
                }
            } catch (e) {
                alert('Error toggling notice status');
            }
        }
        
        function formatDate(isoString) {
            return new Date(isoString).toLocaleDateString('en-GB', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Setup form handlers
        function setupDocumentForms() {
            document.getElementById('noticeUploadForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const btn = e.target.querySelector('button');
                const originalText = btn.textContent;
                
                btn.textContent = 'Uploading...';
                btn.disabled = true;
                
                const result = await uploadNotice(formData);
                
                if (result.success) {
                    alert('Notice uploaded successfully!');
                    e.target.reset();
                    refreshDocuments();
                } else {
                    alert('Upload failed: ' + result.error);
                }
                
                btn.textContent = originalText;
                btn.disabled = false;
            });
            
            document.getElementById('messMenuUploadForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                formData.append('type', 'mess-menu'); // Add type field for proper multer destination
                const btn = e.target.querySelector('button');
                const originalText = btn.textContent;
                
                btn.textContent = 'Uploading...';
                btn.disabled = true;
                
                const result = await uploadMessMenu(formData);
                
                if (result.success) {
                    alert('Mess menu uploaded successfully!');
                    e.target.reset();
                    refreshDocuments();
                } else {
                    alert('Upload failed: ' + result.error);
                }
                
                btn.textContent = originalText;
                btn.disabled = false;
            });
        }
        
        // Request Management Functions
        let currentRequestFilter = 'all';
        let allRequestsData = [];
        
        async function fetchRequests() {
            try {
                const res = await fetch('/api/hostel/admin/all-requests', { credentials: 'include' });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed to fetch requests');
                return data;
            } catch (e) {
                console.error('Fetch requests error:', e);
                return { success: false, requests: [], totalCount: 0 };
            }
        }
        
        async function refreshRequestData() {
            const loading = document.getElementById('requestsLoading');
            const list = document.getElementById('requestsList');
            if (loading) loading.style.display = 'block';
            
            const requestsResp = await fetchRequests();
            allRequestsData = requestsResp.requests || [];
            
            // Update statistics
            updateRequestStats(allRequestsData);
            
            // Render list
            renderRequests(allRequestsData);
            if (loading) loading.style.display = 'none';
        }
        
        function updateRequestStats(requests) {
            document.getElementById('totalRequests').textContent = requests.length;
            document.getElementById('pendingRequests').textContent = requests.filter(r => r.status === 'pending').length;
            document.getElementById('approvedRequests').textContent = requests.filter(r => r.status === 'approved').length;
            document.getElementById('declinedRequests').textContent = requests.filter(r => r.status === 'declined').length;
        }
        
        function renderRequests(requests) {
            const container = document.getElementById('requestsList');
            if (!container) return;
            
            if (!requests || requests.length === 0) {
                container.innerHTML = '<div class="text-center" style="padding: 40px; color: #666;">No requests found.</div>';
                return;
            }
            
            const searchQuery = (document.getElementById('requestSearch')?.value || '').toLowerCase();
            const filtered = requests.filter(r => {
                // Apply current filter
                if (currentRequestFilter !== 'all') {
                    if (currentRequestFilter === 'pending' || currentRequestFilter === 'approved' || currentRequestFilter === 'declined') {
                        if (r.status !== currentRequestFilter) return false;
                    } else if (currentRequestFilter === 'leave_hostel' || currentRequestFilter === 'outing') {
                        if (r.type !== currentRequestFilter) return false;
                    }
                }
                
                // Apply search
                if (searchQuery) {
                    const hay = `${r.studentName || ''} ${r.id || ''} ${r.purposeOfLeave || ''} ${r.purposeOfOuting || ''}`.toLowerCase();
                    if (!hay.includes(searchQuery)) return false;
                }
                
                return true;
            });
            
            const requestsHtml = filtered.map(r => {
                const statusBadge = r.status === 'pending' ? 'badge-warning' : r.status === 'approved' ? 'badge-success' : 'badge-danger';
                const typeBadge = r.type === 'leave_hostel' ? 'badge-info' : 'badge-secondary';
                const purpose = r.type === 'leave_hostel' ? r.purposeOfLeave : r.purposeOfOuting;
                const dateInfo = r.type === 'leave_hostel' ? `${r.leaveStartDate} to ${r.leaveEndDate}` : `${r.outingDate} (${r.outingStartTime}-${r.outingEndTime})`;
                
                return `
                    <div class="user-item" style="margin-bottom: 10px; ${r.status === 'pending' ? 'border-left: 4px solid #ffc107;' : ''}">
                        <div><input type="checkbox" class="request-checkbox" data-request-id="${r.id}" onchange="updateRequestSelection()"></div>
                        <div class="user-avatar">${r.studentName.split(' ').map(n => n[0]).join('').substring(0, 2)}</div>
                        <div class="user-info" style="flex: 2;">
                            <div class="user-name">${r.studentName}</div>
                            <div class="user-email">
                                ${r.id} ‚Ä¢ ${r.studentEmail} ‚Ä¢ Room ${r.roomNumber}
                                <span class="badge ${statusBadge}">${r.status.toUpperCase()}</span>
                                <span class="badge ${typeBadge}">${r.type === 'leave_hostel' ? 'üè† Leave Hostel' : 'üö∂ Outing'}</span>
                            </div>
                            <div class="user-email"><strong>Purpose:</strong> ${purpose}</div>
                            <div class="user-email"><strong>Date:</strong> ${dateInfo}</div>
                            <div class="user-email"><strong>Submitted:</strong> ${formatDate(r.submittedAt)}</div>
                            ${r.reviewedAt ? `<div class="user-email"><strong>Reviewed:</strong> ${formatDate(r.reviewedAt)} by ${r.reviewedBy}</div>` : ''}
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-sm btn-info" onclick="viewRequestDetails('${r.id}')">üëÅÔ∏è View</button>
                            ${r.status === 'pending' ? `
                                <button class="btn btn-sm btn-success" onclick="quickApproveRequest('${r.id}')">‚úÖ Approve</button>
                                <button class="btn btn-sm btn-danger" onclick="quickDeclineRequest('${r.id}')">‚ùå Decline</button>
                            ` : ''}
                            ${r.supportingDocument ? `<a href="/uploads/supporting-documents/${r.supportingDocument}" target="_blank" class="btn btn-sm btn-secondary">üìÑ Document</a>` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deleteIndividualRequest('${r.id}')" title="Delete this request">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = requestsHtml || '<div class="text-center" style="padding: 40px; color: #666;">No requests match the current filter.</div>';
        }
        
        function filterRequests() {
            renderRequests(allRequestsData);
        }
        
        function filterRequestsByStatus(status) {
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            currentRequestFilter = status;
            renderRequests(allRequestsData);
        }
        
        function filterRequestsByType(type) {
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            currentRequestFilter = type;
            renderRequests(allRequestsData);
        }
        
        function viewRequestDetails(requestId) {
            const request = allRequestsData.find(r => r.id === requestId);
            if (!request) return;
            
            const modal = document.getElementById('requestReviewModal');
            const title = document.getElementById('reviewModalTitle');
            const details = document.getElementById('requestDetails');
            
            title.textContent = `Review ${request.type === 'leave_hostel' ? 'Leave Hostel' : 'Outing'} Request`;
            
            let detailsHtml = `
                <div class="row">
                    <div class="col-6">
                        <strong>Student:</strong> ${request.studentName}<br>
                        <strong>Email:</strong> ${request.studentEmail}<br>
                        <strong>Student ID:</strong> ${request.studentId}<br>
                        <strong>Course:</strong> ${request.course} (Year ${request.year}, Sem ${request.semester})<br>
                        <strong>Room:</strong> ${request.roomNumber}<br>
                    </div>
                    <div class="col-6">
                        <strong>Request ID:</strong> ${request.id}<br>
                        <strong>Status:</strong> <span class="badge ${request.status === 'pending' ? 'badge-warning' : request.status === 'approved' ? 'badge-success' : 'badge-danger'}">${request.status.toUpperCase()}</span><br>
                        <strong>Submitted:</strong> ${formatDate(request.submittedAt)}<br>
                        ${request.reviewedAt ? `<strong>Reviewed:</strong> ${formatDate(request.reviewedAt)}<br><strong>Reviewed By:</strong> ${request.reviewedBy}<br>` : ''}
                    </div>
                </div>
                <hr>
            `;
            
            if (request.type === 'leave_hostel') {
                detailsHtml += `
                    <div class="row">
                        <div class="col-6">
                            <strong>Leave Type:</strong> ${request.leaveType}<br>
                            <strong>Purpose:</strong> ${request.purposeOfLeave}<br>
                            <strong>Place of Visit:</strong> ${request.placeOfVisit}<br>
                            <strong>Contact During Leave:</strong> ${request.contactNoDuringLeave || 'Not provided'}<br>
                        </div>
                        <div class="col-6">
                            <strong>Leave Period:</strong> ${request.leaveStartDate} to ${request.leaveEndDate}<br>
                            <strong>Departure:</strong> ${request.dateOfLeaving} at ${request.timeOfLeaving || 'Not specified'}<br>
                            <strong>Return:</strong> ${request.arrivalDate} at ${request.arrivalTime || 'Not specified'}<br>
                        </div>
                    </div>
                `;
            } else {
                detailsHtml += `
                    <div class="row">
                        <div class="col-6">
                            <strong>Purpose:</strong> ${request.purposeOfOuting}<br>
                            <strong>Place of Visit:</strong> ${request.placeOfVisit}<br>
                            <strong>Contact During Outing:</strong> ${request.contactNoDuringOuting || 'Not provided'}<br>
                        </div>
                        <div class="col-6">
                            <strong>Outing Date:</strong> ${request.outingDate}<br>
                            <strong>Time:</strong> ${request.outingStartTime} - ${request.outingEndTime}<br>
                            <strong>Expected Return:</strong> ${request.expectedReturnTime || request.outingEndTime}<br>
                        </div>
                    </div>
                `;
            }
            
            if (request.supportingDocument) {
                detailsHtml += `
                    <hr>
                    <div class="text-center">
                        <strong>Supporting Document:</strong><br>
                        <a href="/uploads/supporting-documents/${request.supportingDocument}" target="_blank" class="btn btn-info">üìÑ View Document</a>
                    </div>
                `;
            }
            
            if (request.adminRemarks) {
                detailsHtml += `
                    <hr>
                    <div><strong>Admin Remarks:</strong><br>${request.adminRemarks}</div>
                `;
            }
            
            details.innerHTML = detailsHtml;
            
            // Set current request ID
            modal.setAttribute('data-request-id', requestId);
            
            // Show/hide action buttons based on status
            const approveBtn = document.getElementById('approveRequestBtn');
            const declineBtn = document.getElementById('declineRequestBtn');
            if (request.status === 'pending') {
                approveBtn.style.display = 'inline-block';
                declineBtn.style.display = 'inline-block';
            } else {
                approveBtn.style.display = 'none';
                declineBtn.style.display = 'none';
            }
            
            modal.style.display = 'block';
        }
        
        function closeRequestReviewModal() {
            document.getElementById('requestReviewModal').style.display = 'none';
        }
        
        async function reviewRequest(action) {
            const modal = document.getElementById('requestReviewModal');
            const requestId = modal.getAttribute('data-request-id');
            const adminRemarks = document.getElementById('adminRemarks').value;
            const reviewedBy = document.getElementById('reviewedBy').value;
            
            if (!reviewedBy.trim()) {
                alert('Please enter reviewer name');
                return;
            }
            
            try {
                const res = await fetch('/api/hostel/admin/review-request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        requestId: requestId,
                        action: action,
                        adminRemarks: adminRemarks,
                        reviewedBy: reviewedBy
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert(`Request ${action}d successfully!`);
                    closeRequestReviewModal();
                    refreshRequestData();
                } else {
                    alert(`Failed to ${action} request: ${data.error}`);
                }
            } catch (error) {
                console.error('Review request error:', error);
                alert(`Error ${action}ing request. Please try again.`);
            }
        }
        
        async function quickApproveRequest(requestId) {
            const reviewerName = prompt('Enter your name for approval:');
            if (!reviewerName) return;
            
            try {
                const res = await fetch('/api/hostel/admin/review-request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        requestId: requestId,
                        action: 'approve',
                        adminRemarks: 'Quick approval',
                        reviewedBy: reviewerName
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert('Request approved successfully!');
                    refreshRequestData();
                } else {
                    alert(`Failed to approve request: ${data.error}`);
                }
            } catch (error) {
                console.error('Quick approve error:', error);
                alert('Error approving request. Please try again.');
            }
        }
        
        async function quickDeclineRequest(requestId) {
            const reviewerName = prompt('Enter your name:');
            if (!reviewerName) return;
            
            const remarks = prompt('Reason for declining (optional):');
            
            try {
                const res = await fetch('/api/hostel/admin/review-request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        requestId: requestId,
                        action: 'decline',
                        adminRemarks: remarks || 'Request declined',
                        reviewedBy: reviewerName
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert('Request declined successfully!');
                    refreshRequestData();
                } else {
                    alert(`Failed to decline request: ${data.error}`);
                }
            } catch (error) {
                console.error('Quick decline error:', error);
                alert('Error declining request. Please try again.');
            }
        }
        
        // Request selection management
        function updateRequestSelection() {
            const checkboxes = document.querySelectorAll('.request-checkbox:checked');
            const count = checkboxes.length;
            
            // Show/hide bulk action buttons
            const bulkApproveBtn = document.getElementById('bulkApproveBtn');
            const bulkDeclineBtn = document.getElementById('bulkDeclineBtn');
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            
            if (count > 0) {
                bulkApproveBtn.style.display = 'inline-block';
                bulkDeclineBtn.style.display = 'inline-block';
                bulkDeleteBtn.style.display = 'inline-block';
            } else {
                bulkApproveBtn.style.display = 'none';
                bulkDeclineBtn.style.display = 'none';
                bulkDeleteBtn.style.display = 'none';
            }
        }
        
        // Individual request delete
        async function deleteIndividualRequest(requestId) {
            const request = allRequestsData.find(r => r.id === requestId);
            if (!request) {
                alert('Request not found!');
                return;
            }
            
            const confirmMessage = `Are you sure you want to delete this request?\n\n` +
                                   `Request ID: ${requestId}\n` +
                                   `Student: ${request.studentName}\n` +
                                   `Type: ${request.type === 'leave_hostel' ? 'Leave Hostel' : 'Outing'}\n` +
                                   `Status: ${request.status.toUpperCase()}\n\n` +
                                   `This action cannot be undone.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                const res = await fetch(`/api/hostel/requests/${requestId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert('Request deleted successfully!');
                    refreshRequestData();
                } else {
                    alert(`Failed to delete request: ${data.error}`);
                }
            } catch (error) {
                console.error('Delete individual request error:', error);
                alert('Error deleting request. Please try again.');
            }
        }
        
        // Bulk delete requests
        async function bulkDeleteRequests() {
            const checkboxes = document.querySelectorAll('.request-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.requestId);
            
            if (selectedIds.length === 0) {
                alert('Please select at least one request to delete.');
                return;
            }
            
            const selectedRequests = allRequestsData.filter(r => selectedIds.includes(r.id));
            const requestsInfo = selectedRequests.map(r => 
                `- ${r.studentName} (${r.type === 'leave_hostel' ? 'Leave Hostel' : 'Outing'}) - ${r.status.toUpperCase()}`
            ).join('\n');
            
            const confirmMessage = `Are you sure you want to delete ${selectedIds.length} selected request(s)?\n\n` +
                                   `Selected requests:\n${requestsInfo}\n\n` +
                                   `This action cannot be undone and will permanently remove:\n` +
                                   `- All request data\n` +
                                   `- Supporting documents\n` +
                                   `- Request history\n\n` +
                                   `Type "DELETE" to confirm:`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            const confirmText = prompt('Please type "DELETE" to confirm bulk deletion:');
            if (confirmText !== 'DELETE') {
                alert('Bulk deletion cancelled - confirmation text did not match.');
                return;
            }
            
            try {
                const res = await fetch('/api/hostel/requests/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        requestIds: selectedIds
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert(`Successfully deleted ${data.deletedCount} request(s)!`);
                    
                    // Clear selections
                    document.querySelectorAll('.request-checkbox').forEach(cb => cb.checked = false);
                    updateRequestSelection();
                    
                    // Refresh the request list
                    refreshRequestData();
                } else {
                    alert(`Failed to delete requests: ${data.error}`);
                }
            } catch (error) {
                console.error('Bulk delete requests error:', error);
                alert('Error deleting requests. Please try again.');
            }
        }
        
        // Extend section switching to load data
        const originalShowSection2 = window.showSection;
        window.showSection = function(sectionId) {
            if (originalShowSection2) originalShowSection2(sectionId);
            if (sectionId === 'users') {
                // Refresh the user list when switching to User Management
                updateUsersList();
            }
            if (sectionId === 'hostel-management') {
                refreshHostelData();
            }
            if (sectionId === 'request-management') {
                refreshRequestData();
            }
            if (sectionId === 'document-management') {
                refreshDocuments();
                setupDocumentForms();
            }
        };
        
        // Initialize dashboard on page load
        window.addEventListener('load', () => {
            console.log('üöÄ Page loaded - initializing...');
            
            // Setup create user form handler
            try {
                setupCreateUserForm();
            } catch (e) {
                console.error('Create user form setup error:', e);
            }
            
            // Setup edit user form handler
            const editUserForm = document.getElementById('editUserProfileForm');
            if (editUserForm) {
                editUserForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const email = document.getElementById('editUserEmail').value;
                    
                    const updates = {
                        name: formData.get('name'),
                        role: formData.get('role'),
                        status: formData.get('status')
                    };
                    
                    // If student, include profile data
                    if (formData.get('role') === 'student') {
                        updates.profile = {
                            studentName: formData.get('studentName'),
                            studentId: formData.get('studentId'),
                            bloodGroup: formData.get('bloodGroup'),
                            gender: formData.get('gender'),
                            dateOfBirth: formData.get('dateOfBirth'),
                            currentSemester: formData.get('currentSemester'),
                            session: formData.get('session'),
                            residenceType: formData.get('residenceType'),
                            fatherName: formData.get('fatherName'),
                            motherName: formData.get('motherName'),
                            studentContact: formData.get('studentContact'),
                            parentsContact: formData.get('parentsContact'),
                            address: formData.get('address'),
                            pincode: formData.get('pincode'),
                            district: formData.get('district'),
                            state: formData.get('state')
                        };
                    }
                    
                    try {
                        showMessage('Saving changes...', 'info');
                        
                        // Update user
                        const userResponse = await fetch(`/api/users/${encodeURIComponent(email)}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify(updates)
                        });
                        
                        if (!userResponse.ok) {
                            throw new Error('Failed to update user');
                        }
                        
                        // If student with profile data, update/create profile
                        if (updates.profile && updates.profile.studentName) {
                            const profileResponse = await fetch(`/api/profile/${encodeURIComponent(email)}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify(updates.profile)
                            });
                            
                            if (!profileResponse.ok) {
                                console.warn('Profile update failed, but user updated');
                            }
                        }
                        
                        showMessage('User updated successfully!', 'success');
                        closeEditUserModal();
                        updateUsersList();
                        
                    } catch (error) {
                        console.error('Error saving user:', error);
                        showMessage('Failed to save changes: ' + error.message, 'error');
                    }
                });
            }
            
            try {
                updateDashboardStats();
            } catch (e) {
                console.error('Dashboard stats error:', e);
            }
            
            // Force load users immediately
            try {
                console.log('üë• Forcing immediate user list load...');
                updateUsersList();
            } catch (e) {
                console.error('User list error:', e);
            }
        });
        
        // ALSO try to load users as soon as this script executes (don't wait for page load)
        console.log('üö® Attempting IMMEDIATE user load (before page load event)...');
        setTimeout(() => {
            try {
                updateUsersList();
            } catch (e) {
                console.error('Immediate user load error:', e);
            }
        }, 100);
        
        // ===== BULK OPERATIONS FUNCTIONS =====
        
        // Show Bulk Add Modal
        function showBulkAddModal() {
            document.getElementById('bulkAddModal').style.display = 'flex';
        }
        
        function closeBulkAddModal() {
            document.getElementById('bulkAddModal').style.display = 'none';
            document.getElementById('userCount').value = '';
            document.getElementById('bulkUserForms').innerHTML = '';
            document.getElementById('submitBulkBtn').disabled = true;
        }
        
        // Switch between bulk tabs
        function switchBulkTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }
        
        // Generate user forms for manual entry
        function generateUserForms() {
            const count = parseInt(document.getElementById('userCount').value);
            const container = document.getElementById('bulkUserForms');
            
            if (!count) {
                container.innerHTML = '';
                document.getElementById('submitBulkBtn').disabled = true;
                return;
            }
            
            let formsHTML = '';
            for (let i = 1; i <= count; i++) {
                formsHTML += `
                    <div class="user-form-group">
                        <h5>User ${i}</h5>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Full Name *</label>
                                <input type="text" class="form-control" name="name_${i}" required>
                            </div>
                            <div class="form-group">
                                <label>Email *</label>
                                <input type="email" class="form-control" name="email_${i}" required placeholder="user${i}@gmcpnalanda.com">
                            </div>
                            <div class="form-group">
                                <label>Role *</label>
                                <select class="form-control" name="role_${i}" required onchange="toggleBulkIdField(${i}, this.value)">
                                    <option value="">Select Role</option>
                                    <option value="student">Student</option>
                                    <option value="teacher">Teacher</option>
                                    <option value="management">Management</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <div class="form-group" id="idField_${i}" style="display: none;">
                                <label id="idLabel_${i}">Student ID *</label>
                                <input type="text" class="form-control" name="id_${i}" id="idInput_${i}" placeholder="e.g., STU001">
                            </div>
                            <div class="form-group">
                                <label>Temporary Password *</label>
                                <input type="password" class="form-control" name="password_${i}" required minlength="8" value="TempPass123!">
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = formsHTML;
            document.getElementById('submitBulkBtn').disabled = false;
        }
        
        // Toggle ID field based on role selection in bulk add
        function toggleBulkIdField(index, role) {
            const idField = document.getElementById(`idField_${index}`);
            const idLabel = document.getElementById(`idLabel_${index}`);
            const idInput = document.getElementById(`idInput_${index}`);
            
            if (role) {
                idField.style.display = 'block';
                if (role === 'student') {
                    idLabel.textContent = 'Student ID *';
                    idInput.placeholder = 'e.g., STU001, S2024001';
                    idInput.name = 'studentId_' + index;
                } else {
                    idLabel.textContent = 'Employee ID *';
                    idInput.placeholder = 'e.g., EMP001, FAC001';
                    idInput.name = 'employeeId_' + index;
                }
                idInput.required = true;
            } else {
                idField.style.display = 'none';
                idInput.required = false;
            }
        }
        
        // Submit bulk users
        async function submitBulkUsers() {
            const count = parseInt(document.getElementById('userCount').value);
            const users = [];
            
            // Collect all user data - including ID fields like Create User form
            for (let i = 1; i <= count; i++) {
                const name = document.querySelector(`[name="name_${i}"]`).value.trim();
                const email = document.querySelector(`[name="email_${i}"]`).value.trim();
                const role = document.querySelector(`[name="role_${i}"]`).value;
                const password = document.querySelector(`[name="password_${i}"]`).value.trim();
                
                if (!name || !email || !role || !password) {
                    showMessage(`Please fill all required fields for User ${i}`, 'error');
                    return;
                }
                
                // Build user object with basic fields
                const user = {
                    name,
                    email,
                    role,
                    password,
                    mustChangePassword: true
                };
                
                // Add Student ID or Employee ID based on role
                if (role === 'student') {
                    const studentIdInput = document.querySelector(`[name="studentId_${i}"]`);
                    if (studentIdInput) {
                        user.studentId = studentIdInput.value.trim();
                        if (!user.studentId) {
                            showMessage(`Student ID is required for User ${i}`, 'error');
                            return;
                        }
                    }
                } else {
                    const employeeIdInput = document.querySelector(`[name="employeeId_${i}"]`);
                    if (employeeIdInput) {
                        user.employeeId = employeeIdInput.value.trim();
                        if (!user.employeeId) {
                            showMessage(`Employee ID is required for User ${i}`, 'error');
                            return;
                        }
                    }
                }
                
                users.push(user);
            }
            
            try {
                showMessage(`Creating ${users.length} users...`, 'info');
                
                const response = await fetch('/api/users/bulk-create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include', // Include session cookie
                    body: JSON.stringify({ users })
                });
                
                // Check for authentication errors
                if (response.status === 401) {
                    showMessage('Session expired. Please login again.', 'error');
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 2000);
                    return;
                }
                
                const result = await response.json();
                console.log('Bulk create response:', result);
                
                if (result.success) {
                    showMessage(`Successfully created ${result.created || users.length} users!\nSkipped ${result.skipped || 0} duplicates.`, 'success');
                    closeBulkAddModal();
                    
                    // Refresh user list
                    updateUsersList();
                    
                    // Optionally reload the page to show new users
                    setTimeout(() => {
                        if (confirm('Reload page to see the new users?')) {
                            location.reload();
                        }
                    }, 2000);
                } else {
                    showMessage(`Failed to create users: ${result.error || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                console.error('Bulk create error:', error);
                showMessage(`Error creating users: ${error.message}`, 'error');
            }
        }
        
        // Show bulk import modal
        function showBulkImportModal() {
            document.getElementById('bulkImportModal').style.display = 'flex';
        }
        
        function closeBulkImportModal() {
            document.getElementById('bulkImportModal').style.display = 'none';
            document.getElementById('csvImportFile').value = '';
            document.getElementById('csvPreview').style.display = 'none';
            document.getElementById('importCSVBtn').disabled = true;
            window.csvData = null;
        }
        
        // Download CSV template
        function downloadCSVTemplate() {
            const headers = 'name,email,role,studentId,employeeId,password';
            const sampleRows = [
                'John Doe,john.doe@gmcpnalanda.com,student,STU001,,TempPass123!',
                'Jane Smith,jane.smith@gmcpnalanda.com,student,STU002,,TempPass123!',
                'Dr. Smith Kumar,prof.smith@gmcpnalanda.com,teacher,,EMP001,TempPass123!'
            ];
            
            const csvContent = headers + '\n' + sampleRows.join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'user_import_template.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Preview CSV file
        function previewCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    showMessage('CSV file must have at least a header row and one data row', 'error');
                    return;
                }
                
                const headers = lines[0].split(',').map(h => h.trim());
                const requiredHeaders = ['name', 'email', 'role'];
                const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                
                if (missingHeaders.length > 0) {
                    showMessage(`Missing required columns: ${missingHeaders.join(', ')}`, 'error');
                    return;
                }
                
                // Show preview
                let previewHTML = '<table border="1" style="width: 100%; border-collapse: collapse;"><tr>';
                headers.forEach(header => {
                    previewHTML += `<th style="padding: 5px; background: #f8f9fa;">${header}</th>`;
                });
                previewHTML += '</tr>';
                
                for (let i = 1; i <= Math.min(5, lines.length - 1); i++) {
                    const row = lines[i].split(',').map(cell => cell.trim());
                    previewHTML += '<tr>';
                    row.forEach(cell => {
                        previewHTML += `<td style="padding: 5px;">${cell || '\u2014'}</td>`;
                    });
                    previewHTML += '</tr>';
                }
                previewHTML += '</table>';
                
                document.getElementById('csvPreviewContent').innerHTML = previewHTML;
                document.getElementById('csvStats').textContent = `Total rows: ${lines.length - 1} users to import`;
                document.getElementById('csvPreview').style.display = 'block';
                document.getElementById('importCSVBtn').disabled = false;
                
                // Store parsed data for import
                window.csvData = { headers, lines: lines.slice(1) };
            };
            
            reader.readAsText(file);
        }
        
        // Import users from CSV
        async function importCSVUsers() {
            if (!window.csvData) {
                showMessage('No CSV data to import', 'error');
                return;
            }
            
            const { headers, lines } = window.csvData;
            const users = [];
            const errors = [];
            
            lines.forEach((line, index) => {
                const rowNum = index + 2; // +2 because index is 0-based and we skip header
                const values = line.split(',').map(v => v.trim());
                const user = {};
                
                headers.forEach((header, i) => {
                    if (values[i]) {
                        user[header] = values[i];
                    }
                });
                
                // Set defaults if not provided
                if (!user.password) user.password = 'TempPass123!';
                user.mustChangePassword = true;
                
                // Validate required fields
                if (!user.name || !user.email || !user.role) {
                    errors.push(`Row ${rowNum}: Missing name, email, or role`);
                    return;
                }
                
                // Validate Student ID for students
                if (user.role === 'student') {
                    if (!user.studentId) {
                        errors.push(`Row ${rowNum}: Student ID is required for students`);
                        return;
                    }
                    // Remove employeeId if present for students
                    delete user.employeeId;
                } else {
                    // Validate Employee ID for non-students
                    if (!user.employeeId) {
                        errors.push(`Row ${rowNum}: Employee ID is required for ${user.role}`);
                        return;
                    }
                    // Remove studentId if present for non-students
                    delete user.studentId;
                }
                
                users.push(user);
            });
            
            if (errors.length > 0) {
                showMessage(`CSV validation errors:\n${errors.join('\n')}`, 'error');
                return;
            }
            
            if (users.length === 0) {
                showMessage('No valid users found in CSV file', 'error');
                return;
            }
            
            try {
                showMessage(`Importing ${users.length} users from CSV...`, 'info');
                
                const response = await fetch('/api/users/bulk-create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include', // Include session cookie
                    body: JSON.stringify({ users })
                });
                
                // Check for authentication errors
                if (response.status === 401) {
                    showMessage('Session expired. Please login again.', 'error');
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 2000);
                    return;
                }
                
                const result = await response.json();
                console.log('CSV import response:', result);
                
                if (result.success) {
                    showMessage(
                        `CSV Import completed!\n\n` +
                        `\u2705 Created: ${result.created || 0} users\n` +
                        `\u26a0\ufe0f  Skipped: ${result.skipped || 0} duplicates\n` +
                        `\u274c Errors: ${result.errors || 0} invalid entries`,
                        'success'
                    );
                    closeBulkImportModal();
                    
                    // Refresh user list
                    updateUsersList();
                    
                    // Optionally reload the page
                    setTimeout(() => {
                        if (confirm('Reload page to see the imported users?')) {
                            location.reload();
                        }
                    }, 2000);
                } else {
                    showMessage(`Failed to import users: ${result.error || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                console.error('CSV import error:', error);
                showMessage(`Error importing users: ${error.message}`, 'error');
            }
        }
        
        // Handle CSV upload from template tab
        async function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            
            console.log('CSV file selected:', file.name);
            showMessage('Reading CSV file...', 'info');
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        showMessage('CSV file must have at least a header row and one data row', 'error');
                        return;
                    }
                    
                    const headers = lines[0].split(',').map(h => h.trim());
                    const requiredHeaders = ['name', 'email', 'role'];
                    const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                    
                    if (missingHeaders.length > 0) {
                        showMessage(`Missing required columns: ${missingHeaders.join(', ')}`, 'error');
                        return;
                    }
                    
                    const users = [];
                    const errors = [];
                    
                    lines.slice(1).forEach((line, index) => {
                        const rowNum = index + 2;
                        const values = line.split(',').map(v => v.trim());
                        const user = {};
                        
                        headers.forEach((header, i) => {
                            if (values[i]) {
                                user[header] = values[i];
                            }
                        });
                        
                        // Set defaults
                        if (!user.password) user.password = 'TempPass123!';
                        user.mustChangePassword = true;
                        
                        // Validate required fields
                        if (!user.name || !user.email || !user.role) {
                            errors.push(`Row ${rowNum}: Missing name, email, or role`);
                            return;
                        }
                        
                        // Validate Student ID for students
                        if (user.role === 'student') {
                            if (!user.studentId) {
                                errors.push(`Row ${rowNum}: Student ID is required for students`);
                                return;
                            }
                            delete user.employeeId;
                        } else {
                            // Validate Employee ID for non-students
                            if (!user.employeeId) {
                                errors.push(`Row ${rowNum}: Employee ID is required for ${user.role}`);
                                return;
                            }
                            delete user.studentId;
                        }
                        
                        users.push(user);
                    });
                    
                    if (errors.length > 0) {
                        showMessage(`CSV validation errors:\n${errors.join('\n')}`, 'error');
                        return;
                    }
                    
                    if (users.length === 0) {
                        showMessage('No valid users found in CSV file', 'error');
                        return;
                    }
                    
                    // Show confirmation
                    if (!confirm(`Found ${users.length} valid users in CSV.\n\nProceed with import?`)) {
                        return;
                    }
                    
                    // Import users
                    showMessage(`Importing ${users.length} users...`, 'info');
                    
                    console.log('Sending to backend:', { users });
                    
                    const response = await fetch('/api/users/bulk-create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({ users })
                    });
                    
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    
                    if (response.status === 401) {
                        showMessage('Session expired. Please login again.', 'error');
                        setTimeout(() => {
                            window.location.href = '/login.html';
                        }, 2000);
                        return;
                    }
                    
                    // Check if response is JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await response.text();
                        console.error('Non-JSON response:', text);
                        showMessage('Server error: Expected JSON response but got: ' + text.substring(0, 100), 'error');
                        return;
                    }
                    
                    const result = await response.json();
                    console.log('CSV import response:', result);
                    console.log('result.success:', result.success);
                    console.log('result.error:', result.error);
                    console.log('result.message:', result.message);
                    console.log('result.created:', result.created);
                    console.log('result.skipped:', result.skipped);
                    console.log('result.errors:', result.errors);
                    
                    // Show results whether success or not
                    const created = result.created || 0;
                    const skipped = result.skipped || 0;
                    const errorCount = result.errors || 0;
                    
                    if (created > 0) {
                        // Some users were created successfully
                        showMessage(
                            `CSV Import completed!\n\n` +
                            `‚úÖ Created: ${created} users\n` +
                            `‚ö†Ô∏è  Skipped: ${skipped} duplicates\n` +
                            `‚ùå Errors: ${errorCount} invalid entries`,
                            'success'
                        );
                        
                        // Clear file input
                        event.target.value = '';
                        
                        // Close modal
                        closeBulkAddModal();
                        
                        // Refresh user list
                        updateUsersList();
                        
                        // Optionally reload
                        setTimeout(() => {
                            if (confirm('Reload page to see the imported users?')) {
                                location.reload();
                            }
                        }, 2000);
                    } else {
                        // No users were created
                        console.log('CSV import result - no new users:', result);
                        
                        let messageType = 'warning';
                        let errorMessage = '';
                        
                        // If all were skipped (duplicates), show warning instead of error
                        if (skipped > 0 && errorCount === 0) {
                            messageType = 'warning';
                            errorMessage = `‚ö†Ô∏è All ${skipped} users already exist in the system.\n\n`;
                        } else {
                            messageType = 'error';
                            errorMessage = 'No users were created.\n\n';
                            errorMessage += `‚ö†Ô∏è  Skipped: ${skipped} duplicates\n`;
                            errorMessage += `‚ùå Errors: ${errorCount} invalid entries\n\n`;
                        }
                        
                        // Show details if available
                        if (result.details && result.details.length > 0) {
                            errorMessage += 'Details:\n';
                            result.details.forEach((detail, index) => {
                                if (index < 5) { // Show first 5 details only
                                    errorMessage += `${index + 1}. ${detail.email}: ${detail.message}\n`;
                                }
                            });
                            if (result.details.length > 5) {
                                errorMessage += `... and ${result.details.length - 5} more\n`;
                            }
                        }
                        
                        if (result.error) {
                            errorMessage += `\nError: ${result.error}`;
                        }
                        
                        showMessage(errorMessage, messageType);
                    }
                    
                } catch (error) {
                    console.error('CSV import error:', error);
                    console.error('Error stack:', error.stack);
                    showMessage(`Error importing CSV: ${error.message}`, 'error');
                }
            };
            
            reader.readAsText(file);
        }
        
        // Section switching function
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event?.target?.classList?.add('active');
            
            // Load data when sections are shown
            if (sectionId === 'hostel-issues') {
                loadHostelIssues('All');
            } else if (sectionId === 'feedback-management') {
                loadFeedbackLinks();
            } else if (sectionId === 'attendance') {
                loadAttendanceConfiguration();
            }
        }
        
        // Hostel Issues Management Functions
        let currentIssueFilter = 'All';
        
        async function loadHostelIssues(status = 'All') {
            try {
                currentIssueFilter = status;
                const url = status === 'All' 
                    ? '/api/hostel-issues' 
                    : `/api/hostel-issues?status=${encodeURIComponent(status)}`;
                    
                const response = await fetch(url, { credentials: 'include' });
                const data = await response.json();
                
                const listDiv = document.getElementById('hostelIssuesList');
                
                if (data.issues && data.issues.length > 0) {
                    listDiv.innerHTML = data.issues.map(issue => `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                            <span class="badge badge-${getStatusColor(issue.status)}">${issue.status}</span>
                                            <span class="badge badge-${getPriorityColor(issue.priority)}">${issue.priority}</span>
                                            <strong>${issue.category}</strong>
                                        </div>
                                        <div style="margin-bottom: 10px; font-size: 14px;">
                                            <strong>Student:</strong> ${issue.studentName} (${issue.studentEmail})<br>
                                            <strong>Room:</strong> ${issue.roomNumber}<br>
                                            <strong>Reported:</strong> ${new Date(issue.createdAt).toLocaleString()}
                                        </div>
                                        <div style="padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                            ${issue.description}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label>Update Status</label>
                                            <select class="form-control" onchange="updateIssueStatus('${issue.id}', this.value)">
                                                <option value="">Select Status</option>
                                                <option value="Pending" ${issue.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                                <option value="In Progress" ${issue.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                                <option value="Resolved" ${issue.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                                                <option value="Rejected" ${issue.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Admin Notes</label>
                                            <textarea class="form-control" rows="3" id="notes-${issue.id}" 
                                                      placeholder="Add notes...">${issue.adminNotes || ''}</textarea>
                                        </div>
                                        <button class="btn btn-primary btn-sm btn-block" onclick="saveAdminNotes('${issue.id}')">
                                            üíæ Save Notes
                                        </button>
                                        <button class="btn btn-danger btn-sm btn-block" onclick="deleteHostelIssue('${issue.id}')" style="margin-top: 10px;">
                                            üóëÔ∏è Delete Issue
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    listDiv.innerHTML = '<div class="card"><div class="card-body text-center" style="padding: 40px; color: #999;"><p>No issues found</p></div></div>';
                }
            } catch (error) {
                console.error('Error loading hostel issues:', error);
                document.getElementById('hostelIssuesList').innerHTML = '<div class="card"><div class="card-body text-center" style="padding: 40px; color: #dc3545;"><p>Error loading issues</p></div></div>';
            }
        }
        
        function filterHostelIssues(status) {
            // Update active tab
            document.querySelectorAll('#hostel-issues .filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadHostelIssues(status);
        }
        
        async function updateIssueStatus(issueId, status) {
            if (!status) return;
            
            try {
                const response = await fetch(`/api/hostel-issues/${issueId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ status })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Issue status updated successfully', 'success');
                    loadHostelIssues(currentIssueFilter);
                } else {
                    showMessage(result.error || 'Failed to update status', 'error');
                }
            } catch (error) {
                console.error('Error updating issue status:', error);
                showMessage('Failed to update status', 'error');
            }
        }
        
        async function saveAdminNotes(issueId) {
            const notes = document.getElementById(`notes-${issueId}`).value;
            
            try {
                const response = await fetch(`/api/hostel-issues/${issueId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ adminNotes: notes })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Notes saved successfully', 'success');
                } else {
                    showMessage(result.error || 'Failed to save notes', 'error');
                }
            } catch (error) {
                console.error('Error saving notes:', error);
                showMessage('Failed to save notes', 'error');
            }
        }
        
        function getStatusColor(status) {
            switch (status) {
                case 'Pending': return 'warning';
                case 'In Progress': return 'info';
                case 'Resolved': return 'success';
                case 'Rejected': return 'danger';
                default: return 'secondary';
            }
        }
        
        function getPriorityColor(priority) {
            switch (priority) {
                case 'Urgent': return 'danger';
                case 'High': return 'warning';
                case 'Medium': return 'info';
                case 'Low': return 'secondary';
                default: return 'secondary';
            }
        }
        
        async function deleteHostelIssue(issueId) {
            if (!confirm('Are you sure you want to delete this hostel issue? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/hostel-issues/${issueId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Issue deleted successfully', 'success');
                    loadHostelIssues(currentIssueFilter);
                } else {
                    showMessage(result.error || 'Failed to delete issue', 'error');
                }
            } catch (error) {
                console.error('Error deleting issue:', error);
                showMessage('Failed to delete issue', 'error');
            }
        }
        
        // Feedback Links Management
        async function loadFeedbackLinks() {
            try {
                const response = await fetch('/api/feedback-links', { credentials: 'include' });
                const data = await response.json();
                
                const listDiv = document.getElementById('feedbackLinksList');
                
                if (data.links && data.links.length > 0) {
                    listDiv.innerHTML = data.links.map(link => `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <h5>${link.title}</h5>
                                        <p style="color: #666; margin: 10px 0;">${link.description || 'No description'}</p>
                                        <a href="${link.url}" target="_blank" style="color: #007bff; word-break: break-all;">üîó ${link.url}</a>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn btn-sm btn-primary" onclick="editFeedbackLink('${link.id}')">‚úèÔ∏è Edit</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteFeedbackLink('${link.id}')">üóëÔ∏è Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    listDiv.innerHTML = '<div class="text-center" style="padding: 40px; color: #666;"><p>No feedback links added yet</p></div>';
                }
            } catch (error) {
                console.error('Error loading feedback links:', error);
                document.getElementById('feedbackLinksList').innerHTML = '<div class="text-center" style="padding: 40px; color: #dc3545;"><p>Error loading feedback links</p></div>';
            }
        }
        
        function showAddFeedbackLinkModal() {
            document.getElementById('feedbackLinkModal').style.display = 'flex';
            document.getElementById('feedbackLinkForm').reset();
            document.getElementById('feedbackLinkId').value = '';
            document.getElementById('feedbackModalTitle').textContent = '‚ûï Add Feedback Link';
        }
        
        function closeFeedbackLinkModal() {
            document.getElementById('feedbackLinkModal').style.display = 'none';
        }
        
        async function saveFeedbackLink() {
            const id = document.getElementById('feedbackLinkId').value;
            const title = document.getElementById('feedbackTitle').value;
            const url = document.getElementById('feedbackUrl').value;
            const description = document.getElementById('feedbackDescription').value;
            
            try {
                const method = id ? 'PATCH' : 'POST';
                const endpoint = id ? `/api/feedback-links/${id}` : '/api/feedback-links';
                
                const response = await fetch(endpoint, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ title, url, description })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(id ? 'Link updated successfully' : 'Link added successfully', 'success');
                    closeFeedbackLinkModal();
                    loadFeedbackLinks();
                } else {
                    showMessage(result.error || 'Failed to save link', 'error');
                }
            } catch (error) {
                console.error('Error saving feedback link:', error);
                showMessage('Failed to save link', 'error');
            }
        }
        
        async function editFeedbackLink(id) {
            try {
                const response = await fetch('/api/feedback-links', { credentials: 'include' });
                const data = await response.json();
                const link = data.links.find(l => l.id === id);
                
                if (link) {
                    document.getElementById('feedbackLinkId').value = link.id;
                    document.getElementById('feedbackTitle').value = link.title;
                    document.getElementById('feedbackUrl').value = link.url;
                    document.getElementById('feedbackDescription').value = link.description || '';
                    document.getElementById('feedbackModalTitle').textContent = '‚úèÔ∏è Edit Feedback Link';
                    document.getElementById('feedbackLinkModal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading link:', error);
                showMessage('Failed to load link', 'error');
            }
        }
        
        async function deleteFeedbackLink(id) {
            if (!confirm('Are you sure you want to delete this feedback link?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/feedback-links/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Link deleted successfully', 'success');
                    loadFeedbackLinks();
                } else {
                    showMessage(result.error || 'Failed to delete link', 'error');
                }
            } catch (error) {
                console.error('Error deleting link:', error);
                showMessage('Failed to delete link', 'error');
            }
        }
        
    </script>
    
    <!-- Feedback Link Modal -->
    <div id="feedbackLinkModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="feedbackModalTitle">‚ûï Add Feedback Link</h3>
                <button class="modal-close" onclick="closeFeedbackLinkModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="feedbackLinkForm" onsubmit="event.preventDefault(); saveFeedbackLink();">
                    <input type="hidden" id="feedbackLinkId">
                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" id="feedbackTitle" class="form-control" required placeholder="e.g., Course Feedback Form">
                    </div>
                    <div class="form-group">
                        <label>Google Form URL *</label>
                        <input type="url" id="feedbackUrl" class="form-control" required placeholder="https://forms.gle/...">
                    </div>
                    <div class="form-group">
                        <label>Description (Optional)</label>
                        <textarea id="feedbackDescription" class="form-control" rows="3" placeholder="Brief description"></textarea>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button type="submit" class="btn btn-success">üíæ Save Link</button>
                        <button type="button" class="btn btn-light" onclick="closeFeedbackLinkModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Bulk Add Users Modal -->
    <div id="bulkAddModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>‚ûï Bulk Add Users</h3>
                <button class="modal-close" onclick="closeBulkAddModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab-nav">
                        <button class="tab-btn active" onclick="switchBulkTab('manual')">Manual Entry</button>
                        <button class="tab-btn" onclick="switchBulkTab('template')">Download Template</button>
                    </div>
                    
                    <!-- Manual Entry Tab -->
                    <div id="manualTab" class="tab-content active">
                        <div class="form-group">
                            <label>Number of users to add:</label>
                            <select id="userCount" class="form-control" onchange="generateUserForms()" style="width: 200px;">
                                <option value="">Select...</option>
                                <option value="2">2 users</option>
                                <option value="3">3 users</option>
                                <option value="5">5 users</option>
                                <option value="10">10 users</option>
                                <option value="20">20 users</option>
                            </select>
                        </div>
                        
                        <div id="bulkUserForms">
                            <!-- User forms will be generated here -->
                        </div>
                        
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-success" onclick="submitBulkUsers()" id="submitBulkBtn" disabled>üíæ Save All Users</button>
                            <button class="btn btn-light" onclick="closeBulkAddModal()">Cancel</button>
                        </div>
                    </div>
                    
                    <!-- Template Tab -->
                    <div id="templateTab" class="tab-content">
                        <div class="text-center" style="padding: 40px;">
                            <h4>Download CSV Template</h4>
                            <p>Download the CSV template, fill in user details, and import it back.</p>
                            <button class="btn btn-primary" onclick="downloadCSVTemplate()">üìÅ Download Template</button>
                            <div style="margin-top: 20px;">
                                <label for="csvFile" class="btn btn-success">üìÑ Upload Filled CSV</label>
                                <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bulk Import CSV Modal -->
    <div id="bulkImportModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>üìÅ Import Users from CSV</h3>
                <button class="modal-close" onclick="closeBulkImportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <h4>CSV Format Requirements:</h4>
                    <ul style="font-size: 14px; color: #666; margin-left: 20px;">
                        <li>First row should be headers</li>
                        <li>Required columns: name, email, role</li>
                        <li>Optional column: password (defaults to TempPass123! if not provided)</li>
                        <li>Roles: student, teacher, management, admin</li>
                        <li><strong>Note:</strong> Students will fill in their own profile details (Student ID, Roll Number, etc.) after first login</li>
                    </ul>
                </div>
                
                <div class="form-group">
                    <label>Select CSV File:</label>
                    <input type="file" id="csvImportFile" accept=".csv" class="form-control" onchange="previewCSV(event)">
                </div>
                
                <div id="csvPreview" style="display: none; margin-top: 20px;">
                    <h4>Preview (First 5 rows):</h4>
                    <div id="csvPreviewContent" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;"></div>
                    <p id="csvStats" style="margin-top: 10px; color: #666;"></p>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-success" onclick="importCSVUsers()" id="importCSVBtn" disabled>üì• Import Users</button>
                    <button class="btn btn-light" onclick="closeBulkImportModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create User Modal -->
    <div id="createUserModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>‚ûï Create New User</h3>
                <button class="modal-close" onclick="closeCreateUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <input type="text" class="form-control" name="fullName" required placeholder="Enter full name">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email Address *</label>
                        <input type="email" class="form-control" name="email" required placeholder="user@gmcpnalanda.com">
                        <small class="form-text">Must end with @gmcpnalanda.com</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Temporary Password *</label>
                        <input type="password" class="form-control" name="password" required minlength="8" placeholder="Minimum 8 characters">
                        <small class="form-text">User will be prompted to change on first login</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Role *</label>
                        <select class="form-control form-select" name="role" required id="userRoleSelect" onchange="updateIdField()">
                            <option value="">Select Role</option>
                            <option value="student">Student</option>
                            <option value="teacher">Faculty/Teacher</option>
                            <option value="management">Management</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="idFieldGroup" style="display: none;">
                        <label class="form-label" id="idFieldLabel">Student ID *</label>
                        <input type="text" class="form-control" id="userIdField" name="institutionId" placeholder="Enter unique ID">
                        <small class="form-text" style="color: #d63031; font-weight: 500;">‚ö†Ô∏è This ID is permanent and cannot be changed after user creation</small>
                    </div>

                    <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                        <button type="submit" class="btn btn-success">üë§ Create User</button>
                        <button type="button" class="btn btn-light" onclick="closeCreateUserModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- View User Profile Modal -->
    <div id="viewUserModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>üëÅÔ∏è User Profile Details</h3>
                <button class="modal-close" onclick="closeViewUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="userProfileContent">
                    <div class="text-center" style="padding: 40px; color: #666;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <div style="margin-top: 15px;">Loading user profile...</div>
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-light" onclick="closeViewUserModal()">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit User Profile Modal -->
    <div id="editUserModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>‚úèÔ∏è Edit User Profile</h3>
                <button class="modal-close" onclick="closeEditUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editUserProfileForm">
                    <input type="hidden" id="editUserEmail" name="email">
                    <div id="editUserFormContent">
                        <div class="text-center" style="padding: 40px; color: #666;">
                            <div class="spinner-border text-primary" role="status"></div>
                            <div style="margin-top: 15px;">Loading profile...</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; text-align: center; display: none;" id="editUserFormButtons">
                        <button type="submit" class="btn btn-success">üíæ Save Changes</button>
                        <button type="button" class="btn btn-light" onclick="closeEditUserModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, #d63031 0%, #74b9ff 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: white;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tabs {
            width: 100%;
        }
        
        .tab-nav {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            border-bottom-color: #d63031;
            color: #d63031;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .user-form-group {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        
        .user-form-group h5 {
            margin-bottom: 15px;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 8px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
    </style>

    <!-- Attendance Management JavaScript -->
    <script>
        // Attendance Management Global Variables
        let attendanceSessions = [];
        let attendanceBranches = [];
        let attendancePeriods = [];
        let attendanceSubjects = [];
        let attendanceEnrollments = [];
        let allStudents = [];

        // Show Attendance Tab
        function showAttendanceTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.attendance-tab').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all filter tabs
            const tabs = document.querySelectorAll('#attendance .filter-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab and set active
            document.getElementById(`attendance-${tabName}`).style.display = 'block';
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'config') {
                loadAttendanceConfiguration();
            } else if (tabName === 'subjects') {
                loadSubjectsData();
            } else if (tabName === 'enrollments') {
                loadEnrollmentsData();
            } else if (tabName === 'monitor') {
                // Populate dropdowns for monitor tab
                populateSessionDropdown('monitorSession');
                populateBranchDropdown('monitorBranch');
            } else if (tabName === 'reports') {
                loadReportsData();
            }
        }

        // Load Attendance Configuration
        async function loadAttendanceConfiguration() {
            try {
                // Load sessions
                const sessionsRes = await fetch('/api/attendance/sessions', { credentials: 'include' });
                const sessionsData = await sessionsRes.json();
                if (sessionsData.success) {
                    attendanceSessions = sessionsData.sessions;
                    displaySessions(sessionsData.sessions);
                }
                
                // Load branches
                const branchesRes = await fetch('/api/attendance/branches', { credentials: 'include' });
                const branchesData = await branchesRes.json();
                if (branchesData.success) {
                    attendanceBranches = branchesData.branches;
                    displayBranches(branchesData.branches);
                }
                
                // Load periods
                const periodsRes = await fetch('/api/attendance/periods', { credentials: 'include' });
                const periodsData = await periodsRes.json();
                if (periodsData.success) {
                    attendancePeriods = periodsData.periods;
                    displayPeriods(periodsData.periods);
                }
            } catch (error) {
                console.error('Error loading attendance configuration:', error);
            }
        }

        // Display Sessions
        function displaySessions(sessions) {
            const list = document.getElementById('sessionsList');
            if (!sessions || sessions.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No sessions found. Click Add to create one.</div>';
                return;
            }
            
            list.innerHTML = sessions.map(s => `
                <div style="padding: 12px; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 10px; background: white; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; color: #333;">${s.name || s.id}</div>
                        <div style="font-size: 13px; color: #666; margin-top: 4px;">${s.startYear} - ${s.endYear}</div>
                        <div style="font-size: 12px; color: #999; margin-top: 4px;">
                            <span class="badge badge-${s.status === 'active' ? 'success' : 'secondary'}">${s.status}</span>
                        </div>
                    </div>
                    <button onclick="deleteSession('${s.id}')" class="btn btn-sm btn-danger" style="height: fit-content;">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            `).join('');
        }

        // Display Branches
        function displayBranches(branches) {
            const list = document.getElementById('branchesList');
            if (!branches || branches.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No branches found. Click Add to create one.</div>';
                return;
            }
            
            list.innerHTML = branches.map(b => `
                <div style="padding: 12px; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 10px; background: white; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; color: #333;">${b.name}</div>
                        <div style="font-size: 13px; color: #666; margin-top: 4px;">Code: ${b.code}</div>
                        <div style="font-size: 12px; color: #999; margin-top: 4px;">
                            <span class="badge badge-${b.status === 'active' ? 'success' : 'secondary'}">${b.status}</span>
                        </div>
                    </div>
                    <button onclick="deleteBranch('${b.id}')" class="btn btn-sm btn-danger" style="height: fit-content;">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            `).join('');
        }

        // Display Periods
        function displayPeriods(periods) {
            const list = document.getElementById('periodsList');
            if (!periods || periods.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No periods found. Click Add to create one.</div>';
                return;
            }
            
            list.innerHTML = periods.map(p => `
                <div style="padding: 12px; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 10px; background: white; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; color: #333;">${p.name}</div>
                        <div style="font-size: 13px; color: #666; margin-top: 4px;">${p.startTime} - ${p.endTime}</div>
                        <div style="font-size: 12px; color: #999; margin-top: 4px;">
                            <span class="badge badge-info">Order: ${p.order}</span>
                        </div>
                    </div>
                    <button onclick="deletePeriod('${p.id}')" class="btn btn-sm btn-danger" style="height: fit-content;">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            `).join('');
        }

        // Modal Functions
        function showAddSessionModal() {
            const modal = prompt('Enter session in format YYYY-YYYY (e.g., 2026-2029):');
            if (!modal) return;
            
            const parts = modal.split('-');
            if (parts.length !== 2) {
                alert('Invalid format. Use YYYY-YYYY');
                return;
            }
            
            const startYear = parseInt(parts[0]);
            const endYear = parseInt(parts[1]);
            
            if (isNaN(startYear) || isNaN(endYear) || endYear <= startYear) {
                alert('Invalid years');
                return;
            }
            
            addSession(startYear, endYear);
        }

        async function addSession(startYear, endYear) {
            try {
                const res = await fetch('/api/attendance/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        startYear,
                        endYear,
                        name: `${startYear}-${endYear}`,
                        createdBy: authManager.getCurrentUser().email
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Session added successfully!');
                    loadAttendanceConfiguration();
                } else {
                    alert('‚ùå ' + (data.error || 'Failed to add session'));
                }
            } catch (error) {
                console.error('Error adding session:', error);
                alert('‚ùå Error adding session');
            }
        }

        function showAddBranchModal() {
            const code = prompt('Enter branch code (e.g., CSE, ME, EE):');
            if (!code) return;
            
            const name = prompt('Enter branch name:');
            if (!name) return;
            
            addBranch(code, name);
        }

        async function addBranch(code, name) {
            try {
                const res = await fetch('/api/attendance/branches', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        id: code,
                        name,
                        code,
                        createdBy: authManager.getCurrentUser().email
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Branch added successfully!');
                    loadAttendanceConfiguration();
                } else {
                    alert('‚ùå ' + (data.error || 'Failed to add branch'));
                }
            } catch (error) {
                console.error('Error adding branch:', error);
                alert('‚ùå Error adding branch');
            }
        }

        function showAddPeriodModal() {
            const id = prompt('Enter period ID (e.g., P7):');
            if (!id) return;
            
            const name = prompt('Enter period name (e.g., Period 7):');
            if (!name) return;
            
            const startTime = prompt('Enter start time (HH:MM format, e.g., 09:00):');
            if (!startTime) return;
            
            const endTime = prompt('Enter end time (HH:MM format, e.g., 10:00):');
            if (!endTime) return;
            
            const order = prompt('Enter order number:');
            if (!order) return;
            
            addPeriod(id, name, startTime, endTime, parseInt(order));
        }

        async function addPeriod(id, name, startTime, endTime, order) {
            try {
                const res = await fetch('/api/attendance/periods', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        id, name, startTime, endTime, order,
                        createdBy: authManager.getCurrentUser().email
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Period added successfully!');
                    loadAttendanceConfiguration();
                } else {
                    alert('‚ùå ' + (data.error || 'Failed to add period'));
                }
            } catch (error) {
                console.error('Error adding period:', error);
                alert('‚ùå Error adding period');
            }
        }

        // Delete Session
        async function deleteSession(sessionId) {
            if (!confirm(`‚ö†Ô∏è Are you sure you want to delete this session?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const res = await fetch(`/api/attendance/sessions/${sessionId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Session deleted successfully!');
                    loadAttendanceConfiguration();
                } else {
                    alert('‚ùå ' + (data.error || 'Failed to delete session'));
                }
            } catch (error) {
                console.error('Error deleting session:', error);
                alert('‚ùå Error deleting session');
            }
        }

        // Delete Branch
        async function deleteBranch(branchId) {
            if (!confirm(`‚ö†Ô∏è Are you sure you want to delete this branch?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const res = await fetch(`/api/attendance/branches/${branchId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Branch deleted successfully!');
                    loadAttendanceConfiguration();
                } else {
                    alert('‚ùå ' + (data.error || 'Failed to delete branch'));
                }
            } catch (error) {
                console.error('Error deleting branch:', error);
                alert('‚ùå Error deleting branch');
            }
        }

        // Delete Period
        async function deletePeriod(periodId) {
            if (!confirm(`‚ö†Ô∏è Are you sure you want to delete this period?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const res = await fetch(`/api/attendance/periods/${periodId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Period deleted successfully!');
                    loadAttendanceConfiguration();
                } else {
                    alert('‚ùå ' + (data.error || 'Failed to delete period'));
                }
            } catch (error) {
                console.error('Error deleting period:', error);
                alert('‚ùå Error deleting period');
            }
        }

        // Load Subjects Data
        async function loadSubjectsData() {
            try {
                // Populate filter dropdowns
                populateSessionDropdown('subjectFilterSession');
                populateBranchDropdown('subjectFilterBranch');
                
                // Load subjects
                const res = await fetch('/api/attendance/subjects', { credentials: 'include' });
                const data = await res.json();
                if (data.success) {
                    attendanceSubjects = data.subjects;
                    displaySubjects(data.subjects);
                }
            } catch (error) {
                console.error('Error loading subjects:', error);
            }
        }

        function displaySubjects(subjects) {
            const list = document.getElementById('subjectsList');
            if (!subjects || subjects.length === 0) {
                list.innerHTML = '<div class="text-center" style="padding: 40px; color: #999;">No subjects found. Click Add Subject to create one.</div>';
                return;
            }
            
            list.innerHTML = `
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Subject Code</th>
                            <th>Subject Name</th>
                            <th>Session</th>
                            <th>Branch</th>
                            <th>Semester</th>
                            <th>Credits</th>
                            <th style="width: 120px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${subjects.map(s => `
                            <tr>
                                <td><strong>${s.subjectCode}</strong></td>
                                <td>${s.subjectName}</td>
                                <td>${s.sessionId}</td>
                                <td>${s.branchId}</td>
                                <td>Sem ${s.semester}</td>
                                <td>${s.credits}</td>
                                <td>
                                    <button onclick="deleteSubject('${s.id}')" class="btn btn-sm btn-danger" title="Delete Subject">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function filterSubjects() {
            const session = document.getElementById('subjectFilterSession').value;
            const branch = document.getElementById('subjectFilterBranch').value;
            const semester = document.getElementById('subjectFilterSemester').value;
            
            let url = '/api/attendance/subjects?';
            if (session) url += `sessionId=${session}&`;
            if (branch) url += `branchId=${branch}&`;
            if (semester) url += `semester=${semester}&`;
            
            try {
                const res = await fetch(url, { credentials: 'include' });
                const data = await res.json();
                if (data.success) {
                    displaySubjects(data.subjects);
                }
            } catch (error) {
                console.error('Error filtering subjects:', error);
            }
        }

        function showAddSubjectModal() {
            if (attendanceSessions.length === 0 || attendanceBranches.length === 0) {
                alert('Please configure sessions and branches first!');
                return;
            }
            
            const sessionId = prompt(`Select Session (${attendanceSessions.map(s => s.id).join(', ')}):`);
            if (!sessionId) return;
            
            const branchId = prompt(`Select Branch (${attendanceBranches.map(b => b.id).join(', ')}):`);
            if (!branchId) return;
            
            const semester = prompt('Enter Semester (1-6):');
            if (!semester) return;
            
            const subjectCode = prompt('Enter Subject Code (e.g., CS101):');
            if (!subjectCode) return;
            
            const subjectName = prompt('Enter Subject Name:');
            if (!subjectName) return;
            
            const credits = prompt('Enter Credits:');
            if (!credits) return;
            
            addSubject(sessionId, branchId, parseInt(semester), subjectCode, subjectName, parseInt(credits));
        }

        async function addSubject(sessionId, branchId, semester, subjectCode, subjectName, credits) {
            try {
                const res = await fetch('/api/attendance/subjects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        sessionId, branchId, semester, subjectCode, subjectName, credits,
                        createdBy: authManager.getCurrentUser().email
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Subject added successfully!');
                    loadSubjectsData();
                } else {
                    alert('‚ùå ' + (data.error || 'Failed to add subject'));
                }
            } catch (error) {
                console.error('Error adding subject:', error);
                alert('‚ùå Error adding subject');
            }
        }

        // Delete Subject
        async function deleteSubject(subjectId) {
            if (!confirm(`‚ö†Ô∏è Are you sure you want to delete this subject?\n\nThis will also remove all related enrollments and attendance records.\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const res = await fetch(`/api/attendance/subjects/${subjectId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Subject deleted successfully!');
                    loadSubjectsData();
                } else {
                    alert('‚ùå ' + (data.error || 'Failed to delete subject'));
                }
            } catch (error) {
                console.error('Error deleting subject:', error);
                alert('‚ùå Error deleting subject');
            }
        }

        // Load Enrollments
        async function loadEnrollmentsData() {
            try {
                // Populate filter dropdowns
                populateSessionDropdown('enrollFilterSession');
                populateBranchDropdown('enrollFilterBranch');
                
                // Populate enrollment form dropdowns
                populateSessionDropdown('enrollAddSession');
                populateBranchDropdown('enrollAddBranch');
                
                // Load all students
                await loadAllStudents();
                
                // Load enrollments
                const res = await fetch('/api/attendance/enrollments', { credentials: 'include' });
                const data = await res.json();
                if (data.success) {
                    attendanceEnrollments = data.enrollments;
                    displayEnrollments(data.enrollments);
                }
            } catch (error) {
                console.error('Error loading enrollments:', error);
            }
        }
        
        async function loadAllStudents() {
            try {
                const res = await fetch('/api/users', { credentials: 'include' });
                const data = await res.json();
                if (data.success) {
                    // Filter only students
                    allStudents = data.users.filter(u => u.role === 'student');
                    populateStudentDropdown();
                }
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }
        
        function populateStudentDropdown() {
            const select = document.getElementById('enrollAddStudent');
            if (!allStudents || allStudents.length === 0) {
                select.innerHTML = '<option value="">No students available</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Select Student</option>' +
                allStudents.map(s => `<option value="${s.email}" data-id="${s.studentId}" data-name="${s.name}">${s.name} (${s.studentId}) - ${s.email}</option>`).join('');
        }

        function displayEnrollments(enrollments) {
            const list = document.getElementById('enrollmentsList');
            if (!enrollments || enrollments.length === 0) {
                list.innerHTML = '<div class="text-center" style="padding: 40px; color: #999;">No enrollments found. Use the form above to enroll students.</div>';
                return;
            }
            
            list.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong>Total Enrollments:</strong> ${enrollments.length}
                </div>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Student Name</th>
                            <th>Email</th>
                            <th>Session</th>
                            <th>Branch</th>
                            <th>Semester</th>
                            <th>Source</th>
                            <th>Enrolled On</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${enrollments.map(e => {
                            const isAutoEnrolled = e.createdBy === 'system-auto-enrollment';
                            return `
                            <tr style="${isAutoEnrolled ? 'background-color: #f0f9ff;' : ''}">
                                <td><strong>${e.studentId}</strong></td>
                                <td>${e.studentName}</td>
                                <td>${e.studentEmail}</td>
                                <td>${e.sessionId}</td>
                                <td>${e.branchId}</td>
                                <td>Sem ${e.semester}</td>
                                <td>
                                    ${isAutoEnrolled ? 
                                        '<span class="badge badge-info" title="Automatically enrolled when student completed profile">‚öôÔ∏è Auto</span>' : 
                                        '<span class="badge badge-primary" title="Manually enrolled by admin">üë§ Manual</span>'}
                                </td>
                                <td>${new Date(e.createdAt).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="deleteEnrollment('${e.id}')" title="Remove enrollment">‚ùå</button>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;
        }

        async function filterEnrollments() {
            const session = document.getElementById('enrollFilterSession').value;
            const branch = document.getElementById('enrollFilterBranch').value;
            const semester = document.getElementById('enrollFilterSemester').value;
            
            let url = '/api/attendance/enrollments?';
            if (session) url += `sessionId=${session}&`;
            if (branch) url += `branchId=${branch}&`;
            if (semester) url += `semester=${semester}&`;
            
            try {
                const res = await fetch(url, { credentials: 'include' });
                const data = await res.json();
                if (data.success) {
                    displayEnrollments(data.enrollments);
                }
            } catch (error) {
                console.error('Error filtering enrollments:', error);
            }
        }

        async function enrollStudent() {
            const sessionId = document.getElementById('enrollAddSession').value;
            const branchId = document.getElementById('enrollAddBranch').value;
            const semester = document.getElementById('enrollAddSemester').value;
            const studentEmail = document.getElementById('enrollAddStudent').value;
            
            // Validation
            if (!sessionId) {
                alert('‚ö†Ô∏è Please select a session');
                return;
            }
            if (!branchId) {
                alert('‚ö†Ô∏è Please select a branch');
                return;
            }
            if (!semester) {
                alert('‚ö†Ô∏è Please select a semester');
                return;
            }
            if (!studentEmail) {
                alert('‚ö†Ô∏è Please select a student');
                return;
            }
            
            // Get student details from the selected option
            const studentSelect = document.getElementById('enrollAddStudent');
            const selectedOption = studentSelect.options[studentSelect.selectedIndex];
            const studentId = selectedOption.getAttribute('data-id');
            const studentName = selectedOption.getAttribute('data-name');
            
            if (!studentId) {
                alert('‚ö†Ô∏è Student ID not found. Please refresh and try again.');
                return;
            }
            
            // Check if student is already enrolled
            const existingEnrollment = attendanceEnrollments.find(e => 
                e.studentEmail === studentEmail && 
                e.sessionId === sessionId && 
                e.branchId === branchId && 
                e.semester == semester
            );
            
            if (existingEnrollment) {
                alert('‚ö†Ô∏è This student is already enrolled in the selected session, branch, and semester.');
                return;
            }
            
            try {
                const res = await fetch('/api/attendance/enrollments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        studentEmail,
                        studentId,
                        studentName,
                        sessionId,
                        branchId,
                        semester: parseInt(semester),
                        createdBy: authManager.getCurrentUser().email
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Student enrolled successfully!');
                    resetEnrollmentForm();
                    loadEnrollmentsData();
                } else {
                    alert('‚ùå ' + (data.error || 'Failed to enroll student'));
                }
            } catch (error) {
                console.error('Error enrolling student:', error);
                alert('‚ùå Error enrolling student');
            }
        }
        
        function resetEnrollmentForm() {
            document.getElementById('enrollAddSession').value = '';
            document.getElementById('enrollAddBranch').value = '';
            document.getElementById('enrollAddSemester').value = '';
            document.getElementById('enrollAddStudent').value = '';
        }
        
        async function deleteEnrollment(enrollmentId) {
            if (!confirm('‚ö†Ô∏è Are you sure you want to remove this enrollment? This action cannot be undone.')) {
                return;
            }
            
            try {
                const res = await fetch(`/api/attendance/enrollments/${enrollmentId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Enrollment deleted successfully!');
                    loadEnrollmentsData();
                } else {
                    alert('‚ùå ' + (data.error || 'Failed to delete enrollment'));
                }
            } catch (error) {
                console.error('Error deleting enrollment:', error);
                alert('‚ùå Error deleting enrollment');
            }
        }

        // Attendance Monitoring
        async function filterAttendanceRecords() {
            const date = document.getElementById('monitorDate').value;
            const session = document.getElementById('monitorSession').value;
            const branch = document.getElementById('monitorBranch').value;
            const semester = document.getElementById('monitorSemester').value;
            
            let url = '/api/attendance/records?';
            if (date) url += `date=${date}&`;
            if (session) url += `sessionId=${session}&`;
            if (branch) url += `branchId=${branch}&`;
            if (semester) url += `semester=${semester}&`;
            
            try {
                const res = await fetch(url, { credentials: 'include' });
                const data = await res.json();
                if (data.success) {
                    displayAttendanceRecords(data.records);
                }
            } catch (error) {
                console.error('Error filtering attendance records:', error);
            }
        }

        function displayAttendanceRecords(records) {
            const list = document.getElementById('attendanceRecordsList');
            if (!records || records.length === 0) {
                list.innerHTML = '<div class="text-center" style="padding: 40px; color: #999;">No attendance records found for selected filters.</div>';
                return;
            }
            
            list.innerHTML = `
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Session</th>
                            <th>Branch</th>
                            <th>Sem</th>
                            <th>Period</th>
                            <th>Subject</th>
                            <th>Present/Total</th>
                            <th>Marked By</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${records.map(r => `
                            <tr>
                                <td>${r.date}</td>
                                <td>${r.sessionId}</td>
                                <td>${r.branchId}</td>
                                <td>${r.semester}</td>
                                <td>${r.periodId}</td>
                                <td>${r.subjectId}</td>
                                <td>${r.classNotConducted ? 'N/A' : `${r.presentCount}/${r.totalStudents}`}</td>
                                <td>${r.markedBy}</td>
                                <td>
                                    ${r.classNotConducted ? '<span class="badge badge-warning">Not Conducted</span>' : '<span class="badge badge-success">Conducted</span>'}
                                    ${r.canEdit ? '<span class="badge badge-info">Editable</span>' : '<span class="badge badge-secondary">Locked</span>'}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="viewAttendanceDetail('${r.id}')">View</button>
                                    ${r.canEdit ? `<button class="btn btn-sm btn-warning" onclick="lockAttendance('${r.id}', true)">Lock</button>` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function viewAttendanceDetail(recordId) {
            alert(`View Detail: Record ID ${recordId}. Implement a modal to show student-wise attendance details.`);
        }

        async function lockAttendance(recordId, lock) {
            if (!confirm(`Are you sure you want to ${lock ? 'lock' : 'unlock'} this attendance record?`)) return;
            
            try {
                const res = await fetch(`/api/attendance/records/${recordId}/lock`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        lock,
                        modifiedBy: authManager.getCurrentUser().email
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Attendance record updated!');
                    filterAttendanceRecords();
                } else {
                    alert('‚ùå ' + (data.error || 'Failed to update record'));
                }
            } catch (error) {
                console.error('Error updating attendance:', error);
                alert('‚ùå Error updating attendance');
            }
        }

        // Reports
        async function loadReportsData() {
            try {
                // Populate dropdowns
                populateSessionDropdown('reportSession');
                
                // Load subjects for subject report
                const res = await fetch('/api/attendance/subjects', { credentials: 'include' });
                const data = await res.json();
                if (data.success) {
                    const select = document.getElementById('reportSubject');
                    select.innerHTML = '<option value="">Select Subject</option>' +
                        data.subjects.map(s => `<option value="${s.id}">${s.subjectName} (${s.subjectCode})</option>`).join('');
                }
                
                // Load audit logs
                loadAuditLogs();
            } catch (error) {
                console.error('Error loading reports data:', error);
            }
        }

        async function generateDailyReport() {
            const date = document.getElementById('reportDate').value;
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            alert(`Generate Daily Report for ${date}. This would show all attendance records for that day.`);
        }

        async function generateSubjectReport() {
            const subjectId = document.getElementById('reportSubject').value;
            if (!subjectId) {
                alert('Please select a subject');
                return;
            }
            
            alert(`Generate Subject Report for ${subjectId}. This would show attendance summary for all students in this subject.`);
        }

        async function generateStudentReport() {
            const email = document.getElementById('reportStudentEmail').value;
            const session = document.getElementById('reportSession').value;
            
            if (!email || !session) {
                alert('Please enter student email and select session');
                return;
            }
            
            try {
                const res = await fetch(`/api/attendance/student-summary/${encodeURIComponent(email)}`, {
                    credentials: 'include'
                });
                const data = await res.json();
                
                if (data.success) {
                    const summaries = data.summaries.filter(s => s.sessionId === session);
                    displayStudentReport(summaries);
                } else {
                    alert('‚ùå Failed to load student report');
                }
            } catch (error) {
                console.error('Error generating student report:', error);
                alert('‚ùå Error generating report');
            }
        }

        function displayStudentReport(summaries) {
            const display = document.getElementById('studentReportDisplay');
            if (!summaries || summaries.length === 0) {
                display.innerHTML = '<div class="alert alert-warning">No attendance data found for this student.</div>';
                return;
            }
            
            display.innerHTML = `
                <table class="table table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th>Subject</th>
                            <th>Total Conducted</th>
                            <th>Total Present</th>
                            <th>Total Absent</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${summaries.map(s => `
                            <tr>
                                <td>${s.subjectId}</td>
                                <td>${s.totalConducted}</td>
                                <td>${s.totalPresent}</td>
                                <td>${s.totalAbsent}</td>
                                <td>
                                    <span class="badge badge-${s.percentage >= 75 ? 'success' : 'danger'}">
                                        ${s.percentage}%
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function loadAuditLogs() {
            try {
                const res = await fetch('/api/attendance/audit-logs', { credentials: 'include' });
                const data = await res.json();
                
                if (data.success) {
                    displayAuditLogs(data.logs);
                }
            } catch (error) {
                console.error('Error loading audit logs:', error);
            }
        }

        function displayAuditLogs(logs) {
            const list = document.getElementById('auditLogsList');
            if (!logs || logs.length === 0) {
                list.innerHTML = '<div class="text-center" style="padding: 20px; color: #999;">No audit logs found.</div>';
                return;
            }
            
            list.innerHTML = `
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Action</th>
                            <th>User</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${logs.slice(0, 50).map(log => `
                            <tr>
                                <td>${new Date(log.timestamp).toLocaleString()}</td>
                                <td><span class="badge badge-info">${log.action}</span></td>
                                <td>${log.userEmail}</td>
                                <td><small>${JSON.stringify(log.details)}</small></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Helper Functions
        function populateSessionDropdown(elementId) {
            const select = document.getElementById(elementId);
            if (!select) return;
            
            const currentOptions = select.innerHTML;
            const hasAll = currentOptions.includes('All');
            
            select.innerHTML = (hasAll ? '<option value="">All Sessions</option>' : '<option value="">Select Session</option>') +
                attendanceSessions.map(s => `<option value="${s.id}">${s.name || s.id}</option>`).join('');
        }

        function populateBranchDropdown(elementId) {
            const select = document.getElementById(elementId);
            if (!select) return;
            
            const currentOptions = select.innerHTML;
            const hasAll = currentOptions.includes('All');
            
            select.innerHTML = (hasAll ? '<option value="">All Branches</option>' : '<option value="">Select Branch</option>') +
                attendanceBranches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
        }

        // ==================== BIOMETRIC ATTENDANCE FUNCTIONS ====================
        
        function showBiometricTab(tabName) {
            document.querySelectorAll('.biometric-tab').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('#biometric-attendance .filter-tab').forEach(tab => tab.classList.remove('active'));
            
            const tabMap = {
                'devices': 'biometric-devices',
                'enrollment': 'biometric-enrollment',
                'attendance-log': 'biometric-attendance-log',
                'reports': 'biometric-reports'
            };
            
            document.getElementById(tabMap[tabName]).style.display = 'block';
            event.target.classList.add('active');
            
            if (tabName === 'attendance-log') {
                document.getElementById('bioAttendanceDate').valueAsDate = new Date();
            }
        }

        async function loadBiometricDevices() {
            const devicesList = document.getElementById('devicesList');
            try {
                devicesList.innerHTML = '<div class="text-center" style="padding: 40px;"><div class="spinner-border"></div><div style="margin-top: 15px;">Loading devices...</div></div>';
                
                const response = await fetch('/api/biometric/devices', { credentials: 'include' });
                const result = await response.json();
                
                if (result.success && result.devices && result.devices.length > 0) {
                    document.getElementById('bioActiveDevices').textContent = result.devices.filter(d => d.status?.isOnline).length;
                    devicesList.innerHTML = result.devices.map(device => `
                        <div class="card" style="margin-bottom: 15px;">
                            <div class="card-body">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 5px 0;">${device.name || device.deviceId}</h4>
                                        <div style="color: #666; font-size: 13px;">
                                            üì± ${device.deviceId} ‚Ä¢ üìç ${device.location?.name || 'Unknown'} ‚Ä¢ 
                                            <span class="${device.status?.isOnline ? 'text-success' : 'text-danger'}">
                                                ${device.status?.isOnline ? 'üü¢ Online' : 'üî¥ Offline'}
                                            </span>
                                        </div>
                                        ${device.status?.lastSyncTime ? `<div style="color: #999; font-size: 12px; margin-top: 3px;">Last sync: ${new Date(device.status.lastSyncTime).toLocaleString()}</div>` : ''}
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-sm btn-success" onclick="alert('Sync device: ${device.deviceId}')">üîÑ Sync</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    devicesList.innerHTML = '<div class="text-center" style="padding: 40px;">No devices found. Contact your biometric system administrator.</div>';
                }
            } catch (error) {
                console.error('Error loading devices:', error);
                devicesList.innerHTML = '<div class="text-center" style="padding: 40px; color: #e74c3c;">Error loading devices. Please try again.</div>';
            }
        }

        async function loadBioEnrollmentStatus() {
            const list = document.getElementById('bioEnrollmentList');
            try {
                list.innerHTML = '<div class="text-center" style="padding: 40px;"><div class="spinner-border"></div></div>';
                
                const response = await fetch('/api/users', { credentials: 'include' });
                const result = await response.json();
                const users = result.success ? result.users : result;
                
                const enrolled = users.filter(u => u.biometricData?.enrollmentStatus === 'active').length;
                const pending = users.filter(u => u.biometricData?.enrollmentStatus === 'pending').length;
                
                document.getElementById('bioEnrolledUsers').textContent = enrolled;
                document.getElementById('bioPendingEnrollments').textContent = pending;
                
                list.innerHTML = users.map(user => {
                    const status = user.biometricData?.enrollmentStatus || 'not-enrolled';
                    const statusBadge = status === 'active' ? '<span class="badge badge-success">‚úÖ Enrolled</span>' :
                                       status === 'pending' ? '<span class="badge badge-warning">‚è≥ Pending</span>' :
                                       '<span class="badge badge-secondary">‚ùå Not Enrolled</span>';
                    
                    return `
                        <div class="user-item" data-enrollment-status="${status}">
                            <div class="user-avatar">${user.name.charAt(0)}</div>
                            <div class="user-info">
                                <div class="user-name">${user.name}</div>
                                <div class="user-email">${user.studentId || user.employeeId || user.email} ‚Ä¢ ${user.role}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                ${statusBadge}
                                ${user.biometricId ? `<span class="badge badge-info">üëÜ ID: ${user.biometricId}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading enrollment:', error);
                list.innerHTML = '<div class="text-center" style="padding: 40px; color: #e74c3c;">Error loading enrollment data</div>';
            }
        }

        function filterBioEnrollment(status) {
            document.querySelectorAll('#bioEnrollmentList .user-item').forEach(item => {
                const itemStatus = item.dataset.enrollmentStatus;
                item.style.display = (status === 'all' || itemStatus === status) ? 'flex' : 'none';
            });
            document.querySelectorAll('#biometric-enrollment .filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
        }

        // Store attendance data globally for export
        let currentAttendanceData = [];

        async function loadBioAttendanceLog() {
            const fromDate = document.getElementById('bioAttendanceFromDate').value;
            const toDate = document.getElementById('bioAttendanceToDate').value;
            const logList = document.getElementById('bioAttendanceLogList');
            
            if (!fromDate || !toDate) {
                alert('Please select both From and To dates');
                return;
            }
            
            if (new Date(fromDate) > new Date(toDate)) {
                alert('From Date cannot be after To Date');
                return;
            }
            
            try {
                logList.innerHTML = '<div class="text-center" style="padding: 40px;"><div class="spinner-border text-primary"></div><div style="margin-top: 15px;">Loading attendance records...</div></div>';
                
                // Fetch users to get their names
                const usersResponse = await fetch('/api/users', { credentials: 'include' });
                const usersData = await usersResponse.json();
                const usersMap = {};
                usersData.users.forEach(user => {
                    usersMap[user.email] = {
                        name: user.name,
                        id: user.studentId || user.employeeId || user.email,
                        role: user.role
                    };
                });
                
                // Fetch attendance for date range
                const attendanceRecords = [];
                const start = new Date(fromDate);
                const end = new Date(toDate);
                
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    try {
                        const response = await fetch(`/api/biometric/reports/daily?date=${dateStr}`, { credentials: 'include' });
                        const result = await response.json();
                        if (result.records && result.records.length > 0) {
                            attendanceRecords.push(...result.records);
                        }
                    } catch (e) {
                        console.log(`No records for ${dateStr}`);
                    }
                }
                
                currentAttendanceData = attendanceRecords;
                
                if (attendanceRecords.length > 0) {
                    // Group by user and date
                    const grouped = {};
                    attendanceRecords.forEach(record => {
                        const date = record.attendance.date;
                        const userId = record.userId;
                        const key = `${userId}_${date}`;
                        
                        if (!grouped[key]) {
                            grouped[key] = {
                                userId: userId,
                                date: date,
                                userName: usersMap[userId]?.name || 'Unknown',
                                userRole: usersMap[userId]?.role || 'Unknown',
                                id: usersMap[userId]?.id || record.studentId || record.employeeId || '',
                                inTimes: [],
                                outTimes: [],
                                status: record.attendance.status,
                                templateId: record.biometricData.templateId
                            };
                        }
                        
                        const time = new Date(record.attendance.timestamp._seconds * 1000);
                        if (record.attendance.type === 'IN') {
                            grouped[key].inTimes.push(time);
                        } else if (record.attendance.type === 'OUT') {
                            grouped[key].outTimes.push(time);
                        }
                    });
                    
                    // Process grouped data: first IN, last OUT
                    const rows = Object.values(grouped).map(row => {
                        // Sort and get first IN and last OUT
                        row.inTimes.sort((a, b) => a - b);
                        row.outTimes.sort((a, b) => a - b);
                        
                        return {
                            ...row,
                            inTime: row.inTimes.length > 0 ? row.inTimes[0] : null,  // First IN
                            outTime: row.outTimes.length > 0 ? row.outTimes[row.outTimes.length - 1] : null  // Last OUT
                        };
                    });
                    
                    // Separate students and faculty
                    const studentRows = rows.filter(r => r.userRole === 'student');
                    const facultyRows = rows.filter(r => r.userRole === 'teacher' || r.userRole === 'admin' || r.userRole === 'staff');
                    
                    const renderTable = (title, dataRows, icon) => {
                        if (dataRows.length === 0) return '';
                        
                        return `
                            <div style="background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 20px;">
                                <div style="padding: 15px; background: #f8f9fa; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;">
                                    <h4 style="margin: 0;">${icon} ${title} (${dataRows.length} entries)</h4>
                                </div>
                                <div style="overflow-x: auto;">
                                    <table class="table" style="margin: 0;">
                                        <thead style="background: #f8f9fa;">
                                            <tr>
                                                <th>Date</th>
                                                <th>Name</th>
                                                <th>ID / Template</th>
                                                <th>IN Time</th>
                                                <th>OUT Time</th>
                                                <th>Duration</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${dataRows.map(row => {
                                                let duration = '';
                                                if (row.inTime && row.outTime) {
                                                    const diff = row.outTime - row.inTime;
                                                    const hours = Math.floor(diff / 3600000);
                                                    const minutes = Math.floor((diff % 3600000) / 60000);
                                                    duration = `${hours}h ${minutes}m`;
                                                }
                                                
                                                const statusColor = row.status === 'PRESENT' ? '#28a745' : 
                                                                  row.status === 'LATE' ? '#ffc107' : '#dc3545';
                                                
                                                return `
                                                    <tr style="border-bottom: 1px solid #f0f0f0;">
                                                        <td style="font-weight: 500;">${row.date}</td>
                                                        <td>${row.userName}</td>
                                                        <td><span class="badge badge-info">${row.id || row.templateId}</span></td>
                                                        <td style="color: #28a745; font-weight: 500;">${row.inTime ? row.inTime.toLocaleTimeString() : '-'}</td>
                                                        <td style="color: #dc3545; font-weight: 500;">${row.outTime ? row.outTime.toLocaleTimeString() : '-'}</td>
                                                        <td><strong>${duration || '-'}</strong></td>
                                                        <td><span class="badge" style="background: ${statusColor}; color: white;">${row.status}</span></td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    };
                    
                    logList.innerHTML = `
                        <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0; color: #1976d2;">üìä Attendance Summary</h4>
                            <p style="margin: 5px 0 0 0; color: #666;">From: ${fromDate} to ${toDate} | Total: ${rows.length} entries (Students: ${studentRows.length}, Faculty: ${facultyRows.length})</p>
                        </div>
                        ${renderTable('üë®‚Äçüéì Student Attendance', studentRows, 'üë®‚Äçüéì')}
                        ${renderTable('üë®‚Äçüè´ Faculty Attendance', facultyRows, 'üë®‚Äçüè´')}
                    `;
                    
                    document.getElementById('bioTodayAttendance').textContent = rows.length;
                } else {
                    logList.innerHTML = `
                        <div class="text-center" style="padding: 60px; background: white; border-radius: 8px;">
                            <div style="font-size: 48px; margin-bottom: 20px;">üì≠</div>
                            <h4>No attendance records found</h4>
                            <p style="color: #666;">No biometric punches recorded between ${fromDate} and ${toDate}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading attendance:', error);
                logList.innerHTML = `
                    <div class="text-center" style="padding: 60px; background: white; border-radius: 8px;">
                        <div style="font-size: 48px; margin-bottom: 20px; color: #e74c3c;">‚ùå</div>
                        <h4 style="color: #e74c3c;">Error loading attendance data</h4>
                        <p style="color: #666;">${error.message}</p>
                    </div>
                `;
            }
        }

        async function exportBioAttendanceCSV() {
            const fromDate = document.getElementById('bioAttendanceFromDate').value;
            const toDate = document.getElementById('bioAttendanceToDate').value;
            
            if (!fromDate || !toDate) {
                alert('Please select date range and load data first');
                return;
            }
            
            if (currentAttendanceData.length === 0) {
                alert('No data to export. Please load attendance records first.');
                return;
            }
            
            // Create CSV content
            const headers = ['Date', 'Name', 'ID/Template', 'Role', 'IN Time', 'OUT Time', 'Duration', 'Status'];
            let csv = headers.join(',') + '\n';
            
            // Fetch users to get their names
            const usersResponse = await fetch('/api/users', { credentials: 'include' });
            const usersData = await usersResponse.json();
            const usersMap = {};
            usersData.users.forEach(user => {
                usersMap[user.email] = {
                    name: user.name,
                    id: user.studentId || user.employeeId || user.email,
                    role: user.role
                };
            });
            
            // Group by user and date (same as display logic)
            const grouped = {};
            currentAttendanceData.forEach(record => {
                const date = record.attendance.date;
                const userId = record.userId;
                const key = `${userId}_${date}`;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        date: date,
                        userName: usersMap[userId]?.name || 'Unknown',
                        id: usersMap[userId]?.id || record.studentId || record.employeeId || record.biometricData.templateId,
                        role: usersMap[userId]?.role || 'Unknown',
                        inTimes: [],
                        outTimes: [],
                        status: record.attendance.status
                    };
                }
                
                const time = new Date(record.attendance.timestamp._seconds * 1000);
                if (record.attendance.type === 'IN') {
                    grouped[key].inTimes.push(time);
                } else if (record.attendance.type === 'OUT') {
                    grouped[key].outTimes.push(time);
                }
            });
            
            // Process: first IN, last OUT
            const processedRows = Object.values(grouped).map(row => {
                row.inTimes.sort((a, b) => a - b);
                row.outTimes.sort((a, b) => a - b);
                return {
                    ...row,
                    inTime: row.inTimes.length > 0 ? row.inTimes[0] : null,
                    outTime: row.outTimes.length > 0 ? row.outTimes[row.outTimes.length - 1] : null
                };
            });
            
            processedRows.forEach(row => {
                let duration = '';
                if (row.inTime && row.outTime) {
                    const diff = row.outTime - row.inTime;
                    const hours = Math.floor(diff / 3600000);
                    const minutes = Math.floor((diff % 3600000) / 60000);
                    duration = `${hours}h ${minutes}m`;
                }
                
                csv += [
                    row.date,
                    row.userName,
                    row.id,
                    row.role,
                    row.inTime ? row.inTime.toLocaleTimeString() : '-',
                    row.outTime ? row.outTime.toLocaleTimeString() : '-',
                    duration || '-',
                    row.status
                ].join(',') + '\n';
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `biometric-attendance-${fromDate}-to-${toDate}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function exportBioAttendancePDF() {
            const fromDate = document.getElementById('bioAttendanceFromDate').value;
            const toDate = document.getElementById('bioAttendanceToDate').value;
            
            if (!fromDate || !toDate) {
                alert('Please select date range and load data first');
                return;
            }
            
            if (currentAttendanceData.length === 0) {
                alert('No data to export. Please load attendance records first.');
                return;
            }
            
            // Open print dialog for PDF
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Biometric Attendance Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { text-align: center; color: #333; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #4a90e2; color: white; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .date-range { color: #666; font-size: 14px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üéì GMCP Biometric Attendance Report</h1>
                        <div class="date-range">Period: ${fromDate} to ${toDate}</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Name</th>
                                <th>ID</th>
                                <th>IN Time</th>
                                <th>OUT Time</th>
                                <th>Duration</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `);
            
            // Add data rows - use same logic as display
            const grouped = {};
            currentAttendanceData.forEach(record => {
                const date = record.attendance.date;
                const userId = record.userId;
                const key = `${userId}_${date}`;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        date: date,
                        userName: record.userId,
                        id: record.studentId || record.employeeId || record.biometricData.templateId,
                        inTimes: [],
                        outTimes: [],
                        status: record.attendance.status
                    };
                }
                
                const time = new Date(record.attendance.timestamp._seconds * 1000);
                if (record.attendance.type === 'IN') {
                    grouped[key].inTimes.push(time);
                } else if (record.attendance.type === 'OUT') {
                    grouped[key].outTimes.push(time);
                }
            });
            
            // Process: first IN, last OUT
            const processedRows = Object.values(grouped).map(row => {
                row.inTimes.sort((a, b) => a - b);
                row.outTimes.sort((a, b) => a - b);
                return {
                    ...row,
                    inTime: row.inTimes.length > 0 ? row.inTimes[0] : null,
                    outTime: row.outTimes.length > 0 ? row.outTimes[row.outTimes.length - 1] : null
                };
            });
            
            processedRows.forEach(row => {
                let duration = '';
                if (row.inTime && row.outTime) {
                    const diff = row.outTime - row.inTime;
                    const hours = Math.floor(diff / 3600000);
                    const minutes = Math.floor((diff % 3600000) / 60000);
                    duration = `${hours}h ${minutes}m`;
                }
                
                printWindow.document.write(`
                    <tr>
                        <td>${row.date}</td>
                        <td>${row.userName}</td>
                        <td>${row.id}</td>
                        <td>${row.inTime ? row.inTime.toLocaleTimeString() : '-'}</td>
                        <td>${row.outTime ? row.outTime.toLocaleTimeString() : '-'}</td>
                        <td>${duration || '-'}</td>
                        <td>${row.status}</td>
                    </tr>
                `);
            });
            
            printWindow.document.write(`
                        </tbody>
                    </table>
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() { window.close(); }, 100);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        async function generateBioReport() {
            const reportType = document.getElementById('bioReportType').value;
            const userFilter = document.getElementById('bioReportUserFilter').value;
            const fromDate = document.getElementById('bioReportFromDate').value;
            const toDate = document.getElementById('bioReportToDate').value;
            const resultsDiv = document.getElementById('bioReportResults');
            
            if (reportType === 'custom' && (!fromDate || !toDate)) {
                alert('Please select both From and To dates for custom report');
                return;
            }
            
            // Calculate date range based on report type
            let startDate, endDate;
            const today = new Date();
            
            switch (reportType) {
                case 'daily':
                    startDate = endDate = today.toISOString().split('T')[0];
                    break;
                case 'weekly':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    startDate = weekAgo.toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                    break;
                case 'monthly':
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    startDate = monthAgo.toISOString().split('T')[0];
                    endDate = today.toISOString().split('T')[0];
                    break;
                case 'custom':
                    startDate = fromDate;
                    endDate = toDate;
                    break;
            }
            
            resultsDiv.innerHTML = '<div class="text-center" style="padding: 40px;"><div class="spinner-border text-primary"></div><div style="margin-top: 15px;">Generating report...</div></div>';
            
            try {
                // Fetch all users
                const usersResponse = await fetch('/api/users', { credentials: 'include' });
                const usersData = await usersResponse.json();
                let users = usersData.users;
                
                // Filter by role
                if (userFilter === 'students') {
                    users = users.filter(u => u.role === 'student');
                } else if (userFilter === 'faculty') {
                    users = users.filter(u => u.role === 'teacher' || u.role === 'faculty');
                }
                
                // Fetch attendance for date range
                const attendanceMap = {};
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    try {
                        const response = await fetch(`/api/biometric/reports/daily?date=${dateStr}`, { credentials: 'include' });
                        const result = await response.json();
                        if (result.records) {
                            result.records.forEach(record => {
                                const userId = record.userId;
                                if (!attendanceMap[userId]) attendanceMap[userId] = [];
                                attendanceMap[userId].push(record);
                            });
                        }
                    } catch (e) {}
                }
                
                // Generate summary
                const summary = users.map(user => {
                    const records = attendanceMap[user.email] || [];
                    const days = new Set(records.map(r => r.attendance.date)).size;
                    const present = records.filter(r => r.attendance.status === 'PRESENT').length;
                    const late = records.filter(r => r.attendance.status === 'LATE').length;
                    
                    return {
                        name: user.name,
                        id: user.studentId || user.employeeId || user.email,
                        role: user.role,
                        daysPresent: days,
                        onTime: present,
                        late: late,
                        totalPunches: records.length
                    };
                });
                
                resultsDiv.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìà ${reportType.charAt(0).toUpperCase() + reportType.slice(1)} Report - ${userFilter}</div>
                            <small style="color: #666;">Period: ${startDate} to ${endDate}</small>
                        </div>
                        <div class="card-body">
                            <div style="overflow-x: auto;">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>ID</th>
                                            <th>Role</th>
                                            <th>Days Present</th>
                                            <th>On Time</th>
                                            <th>Late</th>
                                            <th>Total Punches</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${summary.map(s => `
                                            <tr>
                                                <td><strong>${s.name}</strong></td>
                                                <td><span class="badge badge-info">${s.id}</span></td>
                                                <td><span class="badge badge-secondary">${s.role}</span></td>
                                                <td><strong>${s.daysPresent}</strong></td>
                                                <td><span class="badge badge-success">${s.onTime}</span></td>
                                                <td><span class="badge badge-warning">${s.late}</span></td>
                                                <td>${s.totalPunches}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                currentAttendanceData = Object.values(attendanceMap).flat();
            } catch (error) {
                console.error('Error generating report:', error);
                resultsDiv.innerHTML = `
                    <div class="card">
                        <div class="card-body text-center" style="padding: 40px; color: #e74c3c;">
                            <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                            <h4>Error generating report</h4>
                            <p>${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }
        
        function downloadBioReportPDF() {
            if (!currentAttendanceData || currentAttendanceData.length === 0) {
                alert('Please generate a report first');
                return;
            }
            exportBioAttendancePDF();
        }
        
        function downloadBioReportCSV() {
            if (!currentAttendanceData || currentAttendanceData.length === 0) {
                alert('Please generate a report first');
                return;
            }
            exportBioAttendanceCSV();
        }
    </script>

</body>
</html>
