const admin = require('firebase-admin');
const path = require('path');
const fs = require('fs');

// Initialize Firebase
const serviceAccountPath = path.join(__dirname, '../config/firebase-service-account.json');

if (!fs.existsSync(serviceAccountPath)) {
  console.error('‚ùå Firebase credentials file not found at:', serviceAccountPath);
  process.exit(1);
}

const serviceAccount = require(serviceAccountPath);

if (!admin.apps.length) {
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount)
  });
}

const db = admin.firestore();

async function removeAutoGeneratedIds() {
  console.log('üîß Starting removal of auto-generated Student IDs and Employee IDs...\n');
  
  try {
    // Get all users
    const usersSnapshot = await db.collection('users').get();
    
    let updatedCount = 0;
    
    for (const userDoc of usersSnapshot.docs) {
      const user = userDoc.data();
      const updates = {};
      let needsUpdate = false;
      
      // Check if studentId follows auto-generated pattern (STU followed by digits)
      if (user.studentId && /^STU\d{4}$/.test(user.studentId)) {
        console.log(`‚ùå Found auto-generated studentId: ${user.studentId} for ${user.email}`);
        updates.studentId = null;
        needsUpdate = true;
      }
      
      // Check if employeeId follows auto-generated pattern (EMP followed by digits)
      if (user.employeeId && /^EMP\d{4}$/.test(user.employeeId)) {
        console.log(`‚ùå Found auto-generated employeeId: ${user.employeeId} for ${user.email}`);
        updates.employeeId = null;
        needsUpdate = true;
      }
      
      if (needsUpdate) {
        await db.collection('users').doc(userDoc.id).update(updates);
        console.log(`‚úÖ Updated ${user.email} - removed auto-generated IDs\n`);
        updatedCount++;
      }
    }
    
    console.log(`\n‚úÖ Migration complete!`);
    console.log(`üìä Total users updated: ${updatedCount}`);
    console.log('\nüí° Note: Student ID and Employee ID will now only appear after users fill them in themselves.');
    
    process.exit(0);
  } catch (error) {
    console.error('‚ùå Error:', error);
    process.exit(1);
  }
}

// Run the migration
removeAutoGeneratedIds();
